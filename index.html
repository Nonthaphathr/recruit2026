<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>ระบบรับสมัครนักเรียนออนไลน์ - โรงเรียนกระดุมทองวิทยา</title>
    <link rel="icon" type="image/png" href="https://nonthaphathr.github.io/uploadimg/logoschool.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&family=Prompt:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #c2185b;
            --primary-light: #e91e63;
            --primary-dark: #880e4f;
            --accent: #f06292;
            --accent-light: #f8bbd0;
            --accent-dark: #ad1457;
            --bg: #fce4ec;
            --bg-secondary: #f8bbd0;
            --card-bg: #ffffff;
            --overlay-bg: rgba(0, 0, 0, 0.6);
            --text: #2d3748;
            --text-light: #718096;
            --text-lighter: #a0aec0;
            --border: #f8bbd0;
            --border-light: #fce4ec;
            --success: #38a169;
            --success-light: #48bb78;
            --danger: #e53e3e;
            --danger-light: #fc8181;
            --warning: #ed8936;
            --info: #3182ce;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;
            --font-body: 'Sarabun', sans-serif;
            --font-heading: 'Prompt', sans-serif;
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
            --text-4xl: 2.25rem;
            --touch-target: 44px;
            --button-height: 48px;
            --input-height: 48px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-body);
            background: linear-gradient(135deg, var(--bg) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
            font-weight: 600;
            line-height: 1.3;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: var(--space-md) var(--space-lg);
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-md);
            flex-wrap: wrap;
        }

        .settings-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg) scale(1.1);
        }

        .report-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            height: 48px;
            padding: 0 18px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--text-sm);
            font-weight: 600;
            flex-shrink: 0;
            font-family: inherit;
        }
        .report-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* ===== Report Page ===== */
        .report-page {
            display: none;
            padding: var(--space-xl) var(--space-lg);
            max-width: 1000px;
            margin: 0 auto;
        }
        .report-page.active { display: block; }

        .report-page-header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
            flex-wrap: wrap;
        }
        .report-page-header h2 {
            font-size: 1.4rem;
            color: var(--primary);
            flex: 1;
        }

        .reporter-section {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-lg);
            border-left: 5px solid var(--primary);
        }
        .reporter-section h3 {
            font-size: 1rem;
            color: var(--primary);
            margin-bottom: var(--space-md);
        }

        .report-query-section {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-lg);
            border-left: 5px solid var(--accent-dark);
        }
        .report-query-section h3 {
            font-size: 1rem;
            color: var(--accent-dark);
            margin-bottom: var(--space-md);
        }

        .report-results {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-lg);
        }
        .report-results h3 {
            font-size: 1rem;
            color: var(--text);
            margin-bottom: var(--space-md);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }
        .report-summary-card {
            background: var(--accent-light);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            text-align: center;
        }
        .report-summary-card .num {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }
        .report-summary-card .lbl {
            font-size: var(--text-sm);
            color: var(--text-light);
        }

        .report-table-wrap { overflow-x: auto; }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--text-sm);
        }
        .report-table th {
            background: var(--primary);
            color: white;
            padding: 8px 10px;
            text-align: left;
            white-space: nowrap;
        }
        .report-table td {
            padding: 7px 10px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        .report-table tr:hover td { background: var(--accent-light); }
        .report-table .grade-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 700;
            background: var(--primary);
            color: white;
        }

        .report-actions {
            display: flex;
            gap: var(--space-md);
            flex-wrap: wrap;
            margin-top: var(--space-lg);
        }

        /* Line copy modal */
        .line-copy-modal .modal-body {
            background: white;
            padding: var(--space-lg);
        }
        .line-copy-area {
            background: #f0f8e8;
            border: 2px solid #25d366;
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            font-family: inherit;
            font-size: var(--text-sm);
            line-height: 1.8;
            white-space: pre-wrap;
            margin-bottom: var(--space-md);
            min-height: 200px;
        }

        /* A4 Memo Document — Thai Government Format */
        #memoDocModal .modal-content { background: #f5f5f5; }
        #memoDocContent { background: transparent; }

        /* Screen view: A4 container */
        .a4-paper {
            width: 210mm;
            min-height: 297mm;
            background: white;
            font-family: 'Sarabun', sans-serif;
            box-shadow: 0 4px 20px rgba(0,0,0,0.18);
            margin: 0 auto 12px;
            position: relative;
            overflow: hidden;
        }

        /* Memo modal display wrapper */
        .memo-modal-wrapper {
            overflow-x: auto;
            overflow-y: auto;
            padding: 8px 0;
        }

        /* Page 1 layout */
        .memo-layout {
            font-family: 'Sarabun', sans-serif !important;
            position: relative;
            min-height: 297mm;
            padding: 10mm 15mm 25mm 20mm;
        }
        .memo-layout .garuda {
            position: absolute;
            left: 22mm;
            top: 9.3mm;
            width: 1.3cm;
            height: auto;
        }
        .memo-layout .doc-title {
            text-align: center;
            font-size: 20pt;
            font-weight: bold;
            padding-top: 5mm;
            margin-bottom: 2mm;
        }
        .memo-layout .doc-meta {
            font-size: 11pt;
            line-height: 1.4;
            margin-bottom: 1px;
            white-space: normal;
        }
        .memo-layout .doc-meta-row {
            display: flex;
            justify-content: flex-start;
            gap: 0;
        }
        .memo-layout .doc-meta-row .doc-ref { flex: 0 0 50%; }
        .memo-layout .doc-meta-row .doc-date { flex: 0 0 50%; text-align: left; padding-left: 10px; }
        .memo-layout .doc-line {
            border: none;
            border-bottom: 1px solid black;
            margin: 2px 0 8px 0;
        }
        .memo-layout .doc-to {
            font-size: 11pt;
            font-weight: bold;
            font-style: italic;
            margin-bottom: 2px;
            line-height: 1.4;
        }
        .memo-layout .doc-content {
            font-size: 11pt;
            text-indent: 2.5cm;
            text-align: justify;
            line-height: 1.5;
            margin-bottom: 2px;
        }
        .memo-layout .doc-closing {
            font-size: 11pt;
            text-indent: 2.5cm;
            margin-top: 8px;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        .memo-layout .doc-table {
            width: 100%;
            border-collapse: collapse;
            margin: 4px 0;
            font-size: 10pt;
        }
        .memo-layout .doc-table th,
        .memo-layout .doc-table td {
            border: 1px solid black;
            padding: 2px 3px;
            text-align: center;
            vertical-align: middle;
            line-height: 1.2;
            font-size: 10pt;
        }
        .memo-layout .doc-table th { background: white; font-weight: bold; color: black; }
        .memo-layout .doc-table td.text-left { text-align: left; }
        .memo-layout .sign-table {
            width: 100%;
            border-collapse: collapse;
            border: none !important;
            margin-top: 12px;
        }
        .memo-layout .sign-table td {
            border: none !important;
            vertical-align: top;
            text-align: center;
            padding: 2px 5px;
            width: 50%;
            font-size: 11pt;
            line-height: 1.3;
            white-space: nowrap;
        }
        .memo-layout .name-shift-left {
            display: inline-block;
            position: relative;
            left: -10mm;
        }
        .memo-layout .checkbox-text {
            text-align: left;
            padding-left: 15px;
            margin-bottom: 1px;
            font-size: 11pt;
        }
        .memo-layout .footer-system {
            position: absolute;
            bottom: 10mm;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 10pt;
            color: #666;
            font-style: italic;
        }

        /* Page 2 layout */
        .memo-page2 {
            font-family: 'Sarabun', sans-serif !important;
            position: relative;
            min-height: 297mm;
            padding: 10mm 15mm 25mm 20mm;
            page-break-before: always;
        }
        .memo-page2 .page2-title { text-align: center; font-size: 14pt; font-weight: bold; margin-bottom: 4mm; padding-top: 5mm; }
        .memo-page2 .page2-subtitle { text-align: center; font-size: 11pt; margin-bottom: 6mm; color: #444; }
        .memo-page2 .school-block { margin-bottom: 6mm; }
        .memo-page2 .school-name {
            font-size: 11pt; font-weight: bold;
            background: #fff5eb; padding: 2px 6px;
            border-left: 3px solid #1a56a0;
            margin-bottom: 2mm; display: block;
        }
        .memo-page2 .student-table {
            width: 100%; border-collapse: collapse; font-size: 9.5pt; margin-bottom: 2mm;
        }
        .memo-page2 .student-table th {
            background: var(--primary-dark, #1a56a0);
            color: white; font-weight: bold;
            padding: 3px 5px; border: 1px solid #0d3d7a;
            text-align: center; font-size: 9.5pt;
        }
        .memo-page2 .student-table td {
            border: 1px solid #ccc; padding: 2px 5px; vertical-align: middle; font-size: 9.5pt;
        }
        .memo-page2 .student-table td.text-left { text-align: left; }
        .memo-page2 .student-table tr:nth-child(even) { background: #f0f5ff; }
        .memo-page2 .footer-system {
            position: absolute; bottom: 10mm; left: 0;
            width: 100%; text-align: center; font-size: 9pt; color: #666; font-style: italic;
        }

        @media screen and (max-width: 900px) {
            .a4-paper { transform-origin: top left; }
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .logo-section img {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-full);
            border: 3px solid var(--accent);
            background: white;
            padding: 2px;
            flex-shrink: 0;
        }

        .logo-text h1 {
            font-size: clamp(1rem, 4vw, 1.25rem);
            font-weight: 600;
            letter-spacing: 0.3px;
            line-height: 1.3;
        }

        .logo-text p {
            font-size: clamp(0.75rem, 3vw, 0.875rem);
            opacity: 0.95;
            margin-top: 2px;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: clamp(1rem, 3vw, 2rem);
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: clamp(1rem, 3vw, 2rem);
            align-items: start;
        }

        .form-section {
            background: var(--card-bg);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            animation: fadeIn 0.5s ease;
        }

        .form-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: clamp(1rem, 3vw, 1.5rem) clamp(1rem, 4vw, 2rem);
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .form-header-icon {
            width: clamp(40px, 10vw, 48px);
            height: clamp(40px, 10vw, 48px);
            background: var(--accent);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.25rem, 5vw, 1.5rem);
            flex-shrink: 0;
        }

        .form-header h2 {
            font-size: clamp(1rem, 4vw, 1.25rem);
            font-weight: 600;
            line-height: 1.3;
        }

        .form-header p {
            font-size: clamp(0.8rem, 3vw, 0.875rem);
            opacity: 0.95;
            margin-top: 2px;
        }

        .form-body {
            padding: clamp(1rem, 4vw, 2rem);
        }

        .form-group {
            margin-bottom: var(--space-lg);
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: var(--space-sm);
            color: var(--text);
            font-size: var(--text-base);
        }

        .form-group label .required {
            color: var(--danger);
            margin-left: 2px;
        }

        .form-group label span {
            font-size: var(--text-sm);
            color: var(--text-light);
            font-weight: 400;
        }

        .form-control {
            width: 100%;
            padding: clamp(0.75rem, 3vw, 1rem);
            min-height: var(--input-height);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            font-family: var(--font-body);
            font-size: var(--text-base);
            transition: all 0.3s ease;
            background: white;
            color: var(--text);
            -webkit-appearance: none;
            appearance: none;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
        }

        .form-control::placeholder {
            color: var(--text-lighter);
        }

        select.form-control {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23718096' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 12px;
            padding-right: 2.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-md);
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            margin-top: var(--space-sm);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            cursor: pointer;
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            transition: background 0.2s ease;
            min-height: var(--touch-target);
        }

        .checkbox-item:hover {
            background: var(--bg);
        }

        .checkbox-item input[type="checkbox"],
        .checkbox-item input[type="radio"] {
            width: 22px;
            height: 22px;
            min-width: 22px;
            min-height: 22px;
            accent-color: var(--primary);
            cursor: pointer;
            margin: 0;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-size: var(--text-base);
            line-height: 1.5;
        }

        .form-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            margin-top: var(--space-xl);
            padding-top: var(--space-lg);
            border-top: 2px solid var(--border);
        }

        .btn {
            padding: clamp(0.875rem, 3vw, 1rem) clamp(1rem, 4vw, 1.5rem);
            min-height: var(--button-height);
            border-radius: var(--radius-lg);
            font-family: var(--font-body);
            font-size: var(--text-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            border: none;
            white-space: nowrap;
            text-align: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-outline {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: var(--text-sm);
            border-radius: var(--radius-md);
            min-height: 36px;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: var(--danger-light);
        }

        .history-panel {
            background: var(--card-bg);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            height: fit-content;
            animation: fadeIn 0.5s ease 0.1s both;
        }

        .history-header {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: var(--primary);
            padding: clamp(1rem, 3vw, 1.25rem) clamp(1rem, 3vw, 1.5rem);
        }

        .history-header h3 {
            font-size: clamp(1rem, 3.5vw, 1.1rem);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
        }

        .history-count {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: var(--text-sm);
            font-weight: 600;
        }

        .history-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .history-item {
            padding: var(--space-md) clamp(1rem, 3vw, 1.5rem);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            background: var(--bg);
        }

        .history-item:active {
            background: var(--bg-secondary);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-sm);
            gap: var(--space-sm);
        }

        .history-item-type {
            font-size: var(--text-xs);
            padding: 0.25rem 0.5rem;
            background: var(--primary);
            color: white;
            border-radius: var(--radius-sm);
            font-weight: 500;
            white-space: nowrap;
        }

        .history-item-date {
            font-size: var(--text-xs);
            color: var(--text-light);
            text-align: right;
        }

        .history-item-name {
            font-weight: 600;
            color: var(--text);
            margin-bottom: var(--space-xs);
            font-size: var(--text-base);
        }

        .history-item-detail {
            font-size: var(--text-sm);
            color: var(--text-light);
        }

        .history-item-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }

        .empty-history {
            padding: var(--space-2xl) var(--space-lg);
            text-align: center;
            color: var(--text-light);
        }

        .empty-history svg {
            width: 64px;
            height: 64px;
            margin-bottom: var(--space-md);
            opacity: 0.5;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay-bg);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: var(--space-md);
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-2xl);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: clamp(1rem, 3vw, 1.5rem);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-md);
        }

        .modal-header h3 {
            font-size: clamp(1.1rem, 4vw, 1.25rem);
            flex: 1;
        }

        .modal-close {
            width: clamp(36px, 10vw, 40px);
            height: clamp(36px, 10vw, 40px);
            min-width: var(--touch-target);
            min-height: var(--touch-target);
            border: none;
            background: var(--bg);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: clamp(1.25rem, 4vw, 1.5rem);
            color: var(--text-light);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: clamp(0.5rem, 2vw, 1rem);
            background: var(--bg-secondary);
        }

        .modal-footer {
            padding: clamp(1rem, 3vw, 1.5rem);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        #previewArea {
            background: white;
            min-height: 200px;
        }

        #previewArea .print-document {
            margin: 0 auto;
            box-shadow: var(--shadow-lg);
        }

        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--success);
            color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
            font-size: var(--text-base);
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: var(--danger);
        }

        .print-document {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 8mm 10mm;
            font-family: var(--font-body);
            font-size: 15px;
            line-height: 1.5;
            color: black;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }

        .print-document .doc-code {
            text-align: right;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .print-document .doc-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            position: relative;
        }

        .print-document .doc-logo-section {
            text-align: center;
            flex: 1;
        }

        .print-document .doc-logo {
            width: 110px;
            height: 110px;
            margin: 0 auto;
        }

        .print-document .doc-title-section {
            text-align: center;
            margin-top: 8px;
        }

        .print-document .doc-school-info {
            position: absolute;
            right: 0;
            top: 0;
            text-align: right;
            font-size: 13px;
            line-height: 1.5;
        }

        .print-document .doc-title {
            text-align: center;
            font-size: 16px;
            font-weight: 700;
            margin: 5px 0;
        }

        .print-document .doc-content {
            margin-bottom: 5px;
        }

        .print-document .doc-content p {
            margin-bottom: 4px;
        }

        .print-document .field-line {
            display: flex;
            align-items: baseline;
            gap: 4px;
            margin: 3px 0;
            line-height: 1.6;
        }

        .print-document .field-label {
            font-size: 14px;
        }

        .print-document .field-value {
            font-weight: 600;
            border-bottom: 1px dotted #333;
            min-width: 100px;
            display: inline-block;
        }

        .print-document .checkbox-line {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin: 2px 0 2px 25px;
            line-height: 1.4;
        }

        .print-document .doc-checkbox {
            display: inline-block;
            width: 13px;
            height: 13px;
            min-width: 13px;
            min-height: 13px;
            border: 1.5px solid #333;
            background: white;
            position: relative;
            flex-shrink: 0;
            margin-top: 3px;
        }

        .print-document .doc-checkbox.checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: bold;
            color: #333;
            line-height: 1;
        }

        .print-document .signature-section {
            margin-top: 15px;
            text-align: right;
            padding-right: 20px;
        }

        .print-document .signature-section p {
            margin: 2px 0;
        }

        .print-document .approval-section {
            margin-top: 15px;
            border-top: 1px solid #666;
            padding-top: 10px;
        }

        .print-document .approval-box {
            border: 1px solid #666;
            padding: 8px 10px;
            font-size: 13px;
            margin-top: 8px;
        }

        .print-document .approval-box-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .print-document .approval-box p {
            margin: 2px 0;
        }

        .print-document .id-boxes {
            display: flex;
            gap: 2px;
            align-items: center;
        }

        .print-document .id-box {
            width: 18px;
            height: 22px;
            border: 1.5px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .print-document .id-dash {
            width: 8px;
            height: 2px;
            background: #333;
            margin: 0 1px;
        }

        #printArea {
            display: none;
        }

        @media print {
            *, *::before, *::after {
                background: transparent !important;
                background-color: transparent !important;
                box-shadow: none !important;
            }
            
            html, body {
                width: 210mm !important;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                background-color: white !important;
            }
            
            body > * {
                display: none !important;
                visibility: hidden !important;
            }
            
            /* ใบสมัคร - แสดงเมื่อไม่ได้พิมพ์ใบมอบตัว */
            body:not([data-print="mobtua"]) #printArea {
                display: block !important;
                visibility: visible !important;
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                background-color: white !important;
            }
            
            body:not([data-print="mobtua"]) #printArea * {
                visibility: visible !important;
            }

            /* ใบมอบตัว - แสดงเมื่อ data-print="mobtua" */
            body[data-print="mobtua"] #mobtuaPrintArea {
                display: block !important;
                visibility: visible !important;
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }

            body[data-print="mobtua"] #mobtuaPrintArea * {
                visibility: visible !important;
            }

            /* ===== บันทึกข้อความรายงานประจำวัน ===== */
            body[data-print="memo"] #memoPrintArea {
                display: block !important;
                visibility: visible !important;
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }
            body[data-print="memo"] #memoPrintArea * {
                visibility: visible !important;
            }
            body[data-print="memo"] .a4-paper {
                width: 100% !important;
                min-height: auto !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
            }
            body[data-print="memo"] .memo-layout {
                position: relative !important;
                width: 100% !important;
                height: auto !important;
                min-height: auto !important;
                padding: 8mm 10mm 8mm 15mm !important;
                margin: 0 !important;
            }
            body[data-print="memo"] .memo-page2 {
                position: relative !important;
                width: 100% !important;
                height: auto !important;
                min-height: auto !important;
                padding: 8mm 10mm 8mm 15mm !important;
                margin: 0 !important;
                page-break-before: always;
            }
            body[data-print="memo"] .memo-layout .garuda {
                position: absolute !important;
                left: 22mm !important;
                top: 9.3mm !important;
                width: 1.3cm !important;
            }
            body[data-print="memo"] .memo-layout .doc-title {
                font-size: 18pt !important;
                padding-top: 8mm !important;
            }
            body[data-print="memo"] .memo-layout .doc-table th,
            body[data-print="memo"] .memo-layout .doc-table td {
                border: 1px solid black !important;
                padding: 1.5mm 1mm !important;
                font-size: 9pt !important;
            }
            body[data-print="memo"] .memo-layout .sign-table td {
                border: none !important;
                font-size: 11pt !important;
            }
            body[data-print="memo"] .memo-layout .footer-system {
                position: relative !important;
                bottom: auto !important;
                margin-top: 10mm !important;
                font-size: 9pt !important;
            }
            body[data-print="memo"] .memo-page2 .student-table th {
                background: #1a56a0 !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            body[data-print="memo"] .memo-page2 .student-table tr:nth-child(even) {
                background: #f0f5ff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            body[data-print="memo"] .memo-page2 .school-name {
                background: #fff5eb !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            body[data-print="memo"] .memo-page2 .footer-system {
                position: relative !important;
                bottom: auto !important;
                margin-top: 10mm !important;
            }
            
            .print-document {
                display: block !important;
                visibility: visible !important;
                width: 100% !important;
                min-height: auto !important;
                padding: 5mm 10mm !important;
                margin: 0 !important;
                box-shadow: none !important;
                font-size: 14px !important;
                page-break-inside: avoid !important;
                background: white !important;
                background-color: white !important;
            }
            
            .print-document .approval-box {
                background: white !important;
                background-color: white !important;
            }
            
            @page {
                size: A4 portrait;
                margin: 10mm;
            }
            
            .print-document,
            .print-document * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            .print-document .approval-box {
                border: 1px solid #666 !important;
            }
            
            .print-document .doc-checkbox {
                border: 1.5px solid #333 !important;
                background: white !important;
            }

            /* mobtua 2-page break */
            .mobtua-page-1 {
                page-break-after: always !important;
            }
            .mobtua-page-2 {
                page-break-before: always !important;
            }
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
                display: flex;
                flex-direction: column;
            }
            .form-section {
                order: 1;
                width: 100%;
            }
            .history-panel {
                order: 2;
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            .modal-footer {
                flex-direction: column;
            }
            .modal-footer .btn {
                width: 100%;
            }
            .print-document {
                width: 100%;
                padding: 5mm;
                font-size: 11px;
            }
            .toast {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
            }
        }

        @media (min-width: 769px) {
            .form-actions, .modal-footer {
                flex-direction: row;
                justify-content: flex-end;
            }
            .history-panel {
                position: sticky;
                top: 100px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Landing Page Styles */
        .landing-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 120px);
            padding: var(--space-2xl) var(--space-lg);
        }

        .landing-page h2 {
            font-size: clamp(1.25rem, 4vw, 2rem);
            color: var(--primary);
            margin-bottom: var(--space-xl);
            text-align: center;
        }

        /* ===== Step 1: 2 main cards ===== */
        .doc-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            max-width: 720px;
            width: 100%;
        }

        .doc-type-card {
            background: white;
            border-radius: var(--radius-2xl);
            padding: 2rem 1.5rem 1.5rem;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .doc-type-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .doc-type-card.admission { border-color: var(--primary); }
        .doc-type-card.mobtua   { border-color: #7b3f9e; }

        .doc-type-card .card-icon  { font-size: 3.5rem; margin-bottom: .75rem; }
        .doc-type-card h3          { font-size: 1.4rem; margin-bottom: .5rem; }
        .doc-type-card.admission h3{ color: var(--primary); }
        .doc-type-card.mobtua   h3 { color: #7b3f9e; }
        .doc-type-card p           { color: var(--text-light); font-size: var(--text-sm); line-height: 1.5; }
        .doc-type-card .card-badge {
            display: inline-block; font-size: 0.7rem; padding: 2px 8px;
            border-radius: 999px; font-weight: 600; margin-bottom: .5rem;
        }
        .doc-type-card.admission .card-badge { background: var(--accent-light); color: var(--primary-dark); }
        .doc-type-card.mobtua   .card-badge { background: #e9d5ff; color: #5b21b6; }

        /* ===== Step 2: grade sub-selection ===== */
        .grade-step {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 720px;
            animation: fadeIn 0.3s ease;
        }
        .grade-step.active { display: flex; }

        .step-back-btn {
            align-self: flex-start;
            background: none; border: none; cursor: pointer;
            color: var(--text-light); font-size: var(--text-base);
            display: flex; align-items: center; gap: .5rem;
            padding: .5rem .25rem; margin-bottom: 1rem;
            transition: color .2s;
        }
        .step-back-btn:hover { color: var(--primary); }

        .grade-step-title {
            font-size: 1.1rem; color: var(--text-light);
            margin-bottom: 1.25rem; text-align: center;
        }
        .grade-step-title strong { color: var(--text); }

        .grade-sub-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.25rem;
            width: 100%;
        }

        .grade-sub-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 2rem 1rem;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all 0.25s ease;
            text-align: center;
            border: 3px solid transparent;
        }
        .grade-sub-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .grade-sub-card .sub-icon { font-size: 2.5rem; margin-bottom: .5rem; }
        .grade-sub-card h3  { font-size: 1.6rem; font-weight: 700; margin-bottom: .25rem; }
        .grade-sub-card p   { color: var(--text-light); font-size: var(--text-sm); }

        .grade-sub-card.m1 { border-color: var(--primary); }
        .grade-sub-card.m1 h3 { color: var(--primary); }
        .grade-sub-card.m4 { border-color: var(--accent-dark); }
        .grade-sub-card.m4 h3 { color: var(--accent-dark); }
        .grade-sub-card.mobtua-m1 { border-color: #7b3f9e; }
        .grade-sub-card.mobtua-m1 h3 { color: #7b3f9e; }
        .grade-sub-card.mobtua-m4 { border-color: #5b21b6; }
        .grade-sub-card.mobtua-m4 h3 { color: #5b21b6; }

        /* legacy selectors still used elsewhere */
        .grade-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-xl);
            max-width: 800px;
            width: 100%;
        }
        .grade-card {
            background: white; border-radius: var(--radius-2xl);
            padding: var(--space-2xl); box-shadow: var(--shadow-lg);
            cursor: pointer; transition: all 0.3s ease;
            text-align: center; border: 3px solid transparent;
        }
        .grade-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-xl); border-color: var(--primary); }
        .grade-card-icon { font-size: 4rem; margin-bottom: var(--space-md); }
        .grade-card h3   { font-size: 1.5rem; color: var(--primary); margin-bottom: var(--space-sm); }
        .grade-card p    { color: var(--text-light); font-size: var(--text-base); }


        .hidden {
            display: none !important;
        }

        .history-locked-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: var(--text-xs);
            color: var(--danger);
            background: #fff5f5;
            border: 1px solid var(--danger-light);
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-weight: 600;
        }

        .btn-edit {
            background: var(--info);
            color: white;
        }

        .btn-edit:hover {
            background: #2b6cb0;
        }


        /* ===== ใบมอบตัว modal ===== */
        .mobtua-modal {
            z-index: 1050;
        }
        .mobtua-modal .modal-content {
            max-width: 1100px;
            width: 100%;
            height: 92vh;
            max-height: 92vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .mobtua-modal .modal-header {
            flex-shrink: 0;
        }
        .mobtua-modal .modal-body {
            background: white;
            padding: 1.25rem 1.75rem;
            overflow-y: scroll;
            overflow-x: hidden;
            flex: 1 1 0;
            min-height: 0;
        }
        .mobtua-modal .form-actions {
            flex-shrink: 0;
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 2px solid var(--border);
            padding: 1rem 0 0.5rem;
            margin-top: 1rem;
            z-index: 10;
        }
        @media (max-width: 768px) {
            .mobtua-modal .modal-body { padding: 1rem; }
            .mobtua-modal .modal-content { height: 100vh; max-height: 100vh; border-radius: 0; }
        }
        /* form-row สำหรับ คำนำหน้า + ชื่อ + นามสกุล */
        .form-row-prefix {
            display: grid;
            grid-template-columns: 140px 1fr 1fr;
            gap: var(--space-md);
        }
        @media (max-width: 768px) {
            .form-row-prefix {
                grid-template-columns: 1fr 1fr;
            }
            .form-row-prefix .form-group:first-child {
                grid-column: 1 / -1;
            }
        }

        .section-divider {
            color: #7b3f9e;
            margin: var(--space-xl) 0 var(--space-lg);
            padding-bottom: var(--space-sm);
            border-bottom: 2px solid #e9d5f9;
            font-size: 1rem;
        }

        /* Print document for มอบตัว */
        .mobtua-doc {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 8mm 12mm;
            font-family: 'Sarabun', sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: black;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: relative;
        }
        .mobtua-doc .mt-doc-header-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 6px;
        }
        .mobtua-doc .mt-logo {
            width: 90px;
            height: 90px;
            flex-shrink: 0;
        }
        .mobtua-doc .mt-title-center {
            flex: 1;
            text-align: center;
            padding-top: 8px;
        }
        .mobtua-doc .mt-title-center h2 {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
            font-family: 'Prompt', sans-serif;
        }
        .mobtua-doc .mt-title-center p {
            font-size: 15px;
            font-weight: 600;
            margin: 2px 0 0;
            font-family: 'Prompt', sans-serif;
        }
        .mobtua-doc .mt-topright {
            width: 120px;
            border: 1.5px solid #333;
            padding: 5px 8px;
            font-size: 12px;
            line-height: 1.8;
            flex-shrink: 0;
        }
        .mobtua-doc .mt-field {
            display: inline;
        }
        .mobtua-doc .mt-line {
            border-bottom: 1px dotted #333;
            display: inline-block;
            min-width: 80px;
            font-weight: 600;
            text-align: center;
            vertical-align: bottom;
        }
        .mobtua-doc .mt-section-title {
            font-weight: 700;
            margin: 6px 0 2px;
        }
        .mobtua-doc .mt-para {
            margin: 3px 0;
            line-height: 1.6;
        }
        .mobtua-doc .mt-checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 2px 0;
        }
        .mobtua-doc .mt-cb {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-right: 10px;
        }
        .mobtua-doc .mt-box {
            width: 13px;
            height: 13px;
            border: 1.5px solid #333;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            flex-shrink: 0;
            vertical-align: middle;
        }
        .mobtua-doc .mt-sig-row {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            gap: 20px;
        }
        .mobtua-doc .mt-sig-block {
            text-align: center;
            flex: 1;
        }
        .mobtua-doc .mt-doclist {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px 16px;
            font-size: 12.5px;
            margin-top: 6px;
        }
        .mobtua-doc .mt-doclist-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .mobtua-doc .mt-divider {
            border-top: 1px solid #555;
            margin: 8px 0;
        }
        .mobtua-doc .mt-id-boxes {
            display: inline-flex;
            gap: 2px;
            align-items: center;
            vertical-align: middle;
        }
        .mobtua-doc .mt-id-box {
            width: 16px;
            height: 20px;
            border: 1.5px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
        }
        .mobtua-doc .mt-id-dash {
            width: 6px;
            height: 2px;
            background: #333;
        }
        .mobtua-doc .mt-code {
            text-align: right;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 3px;
        }
        .mobtua-doc .mt-nowrap {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .mobtua-doc .mobtua-page-1 {
            padding-bottom: 10px;
        }
        .mobtua-doc .mobtua-page-2 {
            border-top: 2px dashed #ccc;
            padding-top: 10px;
            margin-top: 10px;
        }
        @media print {
            .mobtua-doc {
                width: 100% !important;
                min-height: auto !important;
                padding: 5mm 10mm !important;
                margin: 0 !important;
                box-shadow: none !important;
                font-size: 13px !important;
            }
            .mobtua-doc .mobtua-page-2 {
                border-top: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <img src="https://nonthaphathr.github.io/uploadimg/logoschool.png" alt="โลโก้โรงเรียน">
                <div class="logo-text">
                    <h1>ระบบรับสมัครนักเรียนออนไลน์</h1>
                    <p>โรงเรียนกระดุมทองวิทยา อำเภอกันทรารมย์ จังหวัดศรีสะเกษ</p>
                    <p style="font-size: 0.7rem; opacity: 0.8; margin-top: 4px;">พัฒนาโดย ครูนนทพัทธ์ หิรัญเรือง งานทะเบียนและเทียบโอนผลการเรียน</p>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:10px; flex-shrink:0;">
                <button class="report-btn" onclick="openReportPage()" title="รายงานประจำวัน">
                    📊 รายงาน
                </button>
                <button class="settings-btn" onclick="openAdminSettings()" title="ตั้งค่าแอดมิน">
                    ⚙️
                </button>
            </div>
        </div>
    </header>

    <!-- ===== Report Page ===== -->
    <div class="report-page" id="reportPage">

        <div class="report-page-header">
            <button class="btn btn-outline" onclick="closeReportPage()" style="flex-shrink:0;">← กลับ</button>
            <h2>📊 รายงานการสมัครเรียนรายวัน</h2>
        </div>

        <!-- ข้อมูลครูผู้รายงาน -->
        <div class="reporter-section">
            <h3>👤 ข้อมูลผู้ลงนามในเอกสาร</h3>
            <p style="font-size:var(--text-sm); color:var(--text-light); margin-bottom:var(--space-md);">
                กรอกครั้งเดียว ระบบจะจำไว้ใช้ในเอกสารทุกครั้ง
            </p>

            <!-- ผู้รับผิดชอบงานรับนักเรียน -->
            <p style="font-weight:600; font-size:var(--text-sm); color:var(--primary); margin-bottom:6px;">
                ✍️ ผู้รับผิดชอบงานรับนักเรียน (ผู้จัดทำรายงาน)
            </p>
            <div class="form-row-3" style="margin-bottom:var(--space-md);">
                <div class="form-group">
                    <label>คำนำหน้า</label>
                    <select class="form-control" id="rpt_prefix">
                        <option value="นาย">นาย</option>
                        <option value="นาง">นาง</option>
                        <option value="นางสาว">นางสาว</option>
                        <option value="ครู">ครู</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ชื่อ</label>
                    <input type="text" class="form-control" id="rpt_firstName" placeholder="ชื่อ">
                </div>
                <div class="form-group">
                    <label>นามสกุล</label>
                    <input type="text" class="form-control" id="rpt_lastName" placeholder="นามสกุล">
                </div>
            </div>

            <!-- หัวหน้างานรับนักเรียน -->
            <p style="font-weight:600; font-size:var(--text-sm); color:var(--primary); margin-bottom:6px;">
                ✍️ หัวหน้างานรับนักเรียน
            </p>
            <div class="form-row-3" style="margin-bottom:var(--space-md);">
                <div class="form-group">
                    <label>คำนำหน้า</label>
                    <select class="form-control" id="sig1_prefix">
                        <option value="นาย">นาย</option>
                        <option value="นาง">นาง</option>
                        <option value="นางสาว">นางสาว</option>
                        <option value="ครู">ครู</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ชื่อ</label>
                    <input type="text" class="form-control" id="sig1_firstName" placeholder="ชื่อ">
                </div>
                <div class="form-group">
                    <label>นามสกุล</label>
                    <input type="text" class="form-control" id="sig1_lastName" placeholder="นามสกุล">
                </div>
            </div>

            <!-- หัวหน้ากลุ่มบริหารงานทั่วไป -->
            <p style="font-weight:600; font-size:var(--text-sm); color:var(--primary); margin-bottom:6px;">
                ✍️ หัวหน้ากลุ่มบริหารงานทั่วไป
            </p>
            <div class="form-row-3" style="margin-bottom:var(--space-md);">
                <div class="form-group">
                    <label>คำนำหน้า</label>
                    <select class="form-control" id="sig2_prefix">
                        <option value="นาย">นาย</option>
                        <option value="นาง">นาง</option>
                        <option value="นางสาว">นางสาว</option>
                        <option value="ครู">ครู</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ชื่อ</label>
                    <input type="text" class="form-control" id="sig2_firstName" placeholder="ชื่อ">
                </div>
                <div class="form-group">
                    <label>นามสกุล</label>
                    <input type="text" class="form-control" id="sig2_lastName" placeholder="นามสกุล">
                </div>
            </div>

            <!-- รองผู้อำนวยการ -->
            <p style="font-weight:600; font-size:var(--text-sm); color:var(--primary); margin-bottom:6px;">
                ✍️ รองผู้อำนวยการโรงเรียน
            </p>
            <div class="form-row-3" style="margin-bottom:var(--space-md);">
                <div class="form-group">
                    <label>คำนำหน้า</label>
                    <select class="form-control" id="sig3_prefix">
                        <option value="นาย">นาย</option>
                        <option value="นาง">นาง</option>
                        <option value="นางสาว">นางสาว</option>
                        <option value="ครู">ครู</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ชื่อ</label>
                    <input type="text" class="form-control" id="sig3_firstName" placeholder="ชื่อ">
                </div>
                <div class="form-group">
                    <label>นามสกุล</label>
                    <input type="text" class="form-control" id="sig3_lastName" placeholder="นามสกุล">
                </div>
            </div>

            <!-- ผู้อำนวยการ -->
            <p style="font-weight:600; font-size:var(--text-sm); color:var(--primary); margin-bottom:6px;">
                ✍️ ผู้อำนวยการโรงเรียน
            </p>
            <div class="form-row-3">
                <div class="form-group">
                    <label>คำนำหน้า</label>
                    <select class="form-control" id="sig4_prefix">
                        <option value="นาย">นาย</option>
                        <option value="นาง">นาง</option>
                        <option value="นางสาว">นางสาว</option>
                        <option value="ดร.">ดร.</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ชื่อ</label>
                    <input type="text" class="form-control" id="sig4_firstName" placeholder="ชื่อ">
                </div>
                <div class="form-group">
                    <label>นามสกุล</label>
                    <input type="text" class="form-control" id="sig4_lastName" placeholder="นามสกุล">
                </div>
            </div>
        </div>

        <!-- เลือกวันที่ -->
        <div class="report-query-section">
            <h3>📅 เลือกวันที่ต้องการดึงข้อมูล</h3>
            <div class="form-row" style="align-items:flex-end;">
                <div class="form-group">
                    <label>วันที่</label>
                    <input type="date" class="form-control" id="rpt_date">
                </div>
                <div class="form-group" style="flex:0 0 auto;">
                    <button class="btn btn-primary" onclick="fetchDailyReport()">
                        🔍 ดึงข้อมูลประจำวัน
                    </button>
                </div>
            </div>
        </div>

        <!-- ผลลัพธ์ -->
        <div class="report-results" id="rpt_results" style="display:none;">
            <h3>📋 ผลการค้นหา
                <span id="rpt_dateLabel" style="font-weight:400; color:var(--text-light); font-size:0.9rem;"></span>
            </h3>

            <!-- Summary Cards -->
            <div class="report-summary-grid">
                <div class="report-summary-card">
                    <span class="num" id="rpt_total">0</span>
                    <span class="lbl">ผู้สมัครทั้งหมด</span>
                </div>
                <div class="report-summary-card">
                    <span class="num" id="rpt_m1count">0</span>
                    <span class="lbl">ม.1</span>
                </div>
                <div class="report-summary-card">
                    <span class="num" id="rpt_m4count">0</span>
                    <span class="lbl">ม.4</span>
                </div>
                <div class="report-summary-card">
                    <span class="num" id="rpt_maleCount">0</span>
                    <span class="lbl">ชาย</span>
                </div>
                <div class="report-summary-card">
                    <span class="num" id="rpt_femaleCount">0</span>
                    <span class="lbl">หญิง</span>
                </div>
            </div>

            <!-- Table -->
            <div class="report-table-wrap">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>ชั้น</th>
                            <th>ชื่อ-สกุล</th>
                            <th>โรงเรียนเดิม</th>
                            <th>อำเภอ</th>
                            <th>จังหวัด</th>
                            <th>เวลาสมัคร</th>
                        </tr>
                    </thead>
                    <tbody id="rpt_tableBody">
                    </tbody>
                </table>
            </div>

            <!-- Action Buttons -->
            <div class="report-actions">
                <button class="btn btn-success" onclick="openLineCopyModal()" style="background:linear-gradient(135deg,#25d366,#128c7e);">
                    📱 คัดลอกส่งไลน์
                </button>
                <button class="btn btn-primary" onclick="generateMemoDocument()">
                    📄 สร้างเอกสาร (ผู้รับผิดชอบงานรับนักเรียน)
                </button>
            </div>
        </div>

        <div id="rpt_empty" style="display:none; text-align:center; padding:3rem; color:var(--text-light);">
            <div style="font-size:3rem; margin-bottom:1rem;">📭</div>
            <p>ไม่พบข้อมูลผู้สมัครในวันที่เลือก</p>
        </div>
    </div>

    <!-- Line Copy Modal -->
    <div class="modal-overlay" id="lineCopyModal" style="z-index:1500;">
        <div class="modal-content line-copy-modal" style="max-width:600px;">
            <div class="modal-header" style="background:linear-gradient(135deg,#25d366,#128c7e); color:white;">
                <h3>📱 คัดลอกส่งไลน์</h3>
                <button class="modal-close" onclick="document.getElementById('lineCopyModal').classList.remove('active')" style="background:rgba(255,255,255,0.2);color:white;">&times;</button>
            </div>
            <div class="modal-body">
                <p style="font-size:var(--text-sm); color:var(--text-light); margin-bottom:var(--space-sm);">
                    กดปุ่ม "คัดลอก" แล้วนำไปวางในแอปไลน์ได้เลยครับ
                </p>
                <div class="line-copy-area" id="lineCopyText"></div>
                <button class="btn btn-success" onclick="copyLineText()" style="background:linear-gradient(135deg,#25d366,#128c7e); width:100%;">
                    📋 คัดลอกข้อความ
                </button>
            </div>
        </div>
    </div>

    <!-- Memo Document Modal -->
    <div class="modal-overlay" id="memoDocModal" style="z-index:1500; overflow-y:auto; padding:20px 8px; align-items:flex-start;">
        <div style="max-width:230mm; width:100%; margin:0 auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; flex-wrap:wrap; gap:8px; position:sticky; top:0; z-index:10; background:rgba(0,0,0,0.5); padding:8px 12px; border-radius:8px;">
                <button class="btn btn-outline" onclick="document.getElementById('memoDocModal').classList.remove('active')" style="background:white; padding:8px 16px;">← ปิด</button>
                <span style="color:white; font-size:0.9rem;">📄 บันทึกข้อความ</span>
                <button class="btn btn-success" onclick="printMemoDoc()" style="padding:8px 16px;">🖨️ พิมพ์</button>
            </div>
            <div id="memoDocContent" style="overflow-x:auto;">
                <!-- generated dynamically -->
            </div>
        </div>
    </div>

    <!-- Print area for memo - outside modal, direct body child -->
    <div id="memoPrintArea" style="display:none;"></div>

    <!-- Landing Page -->
    <div class="landing-page" id="landingPage">
        <h2>📝 ระบบรับสมัครนักเรียนออนไลน์</h2>

        <!-- Step 1: เลือกประเภทเอกสาร -->
        <div class="doc-type-grid" id="landingStep1">
            <div class="doc-type-card admission" onclick="showLandingStep2('admission')">
                <div class="card-icon">📝</div>
                <span class="card-badge">วก.กทว.202 / 203</span>
                <h3>ใบสมัครเข้าเรียน</h3>
                <p>สมัครเข้าเรียนชั้นมัธยมศึกษาปีที่ 1 หรือ 4<br>โรงเรียนกระดุมทองวิทยา</p>
                <div style="margin-top:1rem; color:var(--primary); font-size:0.85rem; font-weight:600;">คลิกเพื่อเลือกระดับชั้น →</div>
            </div>
            <div class="doc-type-card mobtua" onclick="showLandingStep2('mobtua')">
                <div class="card-icon">📋</div>
                <span class="card-badge">วก.กทว.205</span>
                <h3>ใบมอบตัวนักเรียน</h3>
                <p>บันทึกข้อมูลนักเรียนและผู้ปกครอง<br>สำหรับมอบตัวเข้าเรียน</p>
                <div style="margin-top:1rem; color:#7b3f9e; font-size:0.85rem; font-weight:600;">คลิกเพื่อเลือกระดับชั้น →</div>
            </div>
        </div>

        <!-- Step 2a: เลือกระดับชั้นสำหรับใบสมัคร -->
        <div class="grade-step" id="landingStep2Admission">
            <button class="step-back-btn" onclick="backToStep1()">← กลับ</button>
            <p class="grade-step-title">📝 ใบสมัครเข้าเรียน — <strong>เลือกระดับชั้น</strong></p>
            <div class="grade-sub-grid">
                <div class="grade-sub-card m1" onclick="selectGrade('m1')">
                    <div class="sub-icon">🎒</div>
                    <h3>ม.1</h3>
                    <p>มัธยมศึกษาปีที่ 1</p>
                </div>
                <div class="grade-sub-card m4" onclick="selectGrade('m4')">
                    <div class="sub-icon">🎓</div>
                    <h3>ม.4</h3>
                    <p>มัธยมศึกษาปีที่ 4</p>
                </div>
            </div>
        </div>

        <!-- Step 2b: เลือกระดับชั้นสำหรับใบมอบตัว -->
        <div class="grade-step" id="landingStep2Mobtua">
            <button class="step-back-btn" onclick="backToStep1()">← กลับ</button>
            <p class="grade-step-title">📋 ใบมอบตัวนักเรียน — <strong>เลือกระดับชั้น</strong></p>
            <div class="grade-sub-grid">
                <div class="grade-sub-card mobtua-m1" onclick="openMobTuaForm('m1')">
                    <div class="sub-icon">🎒</div>
                    <h3>ม.1</h3>
                    <p>มัธยมศึกษาปีที่ 1</p>
                </div>
                <div class="grade-sub-card mobtua-m4" onclick="openMobTuaForm('m4')">
                    <div class="sub-icon">🎓</div>
                    <h3>ม.4</h3>
                    <p>มัธยมศึกษาปีที่ 4</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-container hidden" id="mainContainer">
        <!-- Form Section -->
        <div class="form-section">
            <div class="form-header">
                <div class="form-header-icon">📝</div>
                <div style="flex:1;">
                    <h2 id="formTitle">ใบสมัครเข้าเรียนชั้นมัธยมศึกษาปีที่ 1</h2>
                    <p id="formCode">วก.กทว.202</p>
                    <span id="autosaveBadgeAdmission" style="font-size:0.75rem;opacity:0;transition:opacity 0.5s;background:rgba(255,255,255,0.25);padding:2px 8px;border-radius:999px;margin-top:4px;display:inline-block;"></span>
                </div>
            </div>
            <div class="form-body">
                <form id="admissionForm">
                    <!-- ข้อมูลส่วนตัว -->
                    <h3 style="color: var(--primary); margin-bottom: var(--space-lg); padding-bottom: var(--space-sm); border-bottom: 2px solid var(--border);">
                        📋 ข้อมูลส่วนตัวผู้สมัคร
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label>สมัครเข้าเรียนชั้น <span class="required">*</span></label>
                            <select class="form-control" name="gradeLevel" id="gradeLevel" required onchange="updateFormTitle()">
                                <option value="">-- เลือกระดับชั้น --</option>
                                <option value="m1">มัธยมศึกษาปีที่ 1</option>
                                <option value="m4">มัธยมศึกษาปีที่ 4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ปีการศึกษา <span class="required">*</span></label>
                            <input type="text" class="form-control" name="academicYear" id="academicYear" required placeholder="เช่น 2567">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>วันที่ยื่นใบสมัคร <span class="required">*</span></label>
                            <input type="date" class="form-control" name="applicationDate" required>
                        </div>
                    </div>

                    <div class="form-row-3">
                        <div class="form-group">
                            <label>คำนำหน้า <span class="required">*</span></label>
                            <select class="form-control" name="prefix" required>
                                <option value="">-- เลือก --</option>
                                <option value="เด็กชาย">เด็กชาย</option>
                                <option value="เด็กหญิง">เด็กหญิง</option>
                                <option value="นาย">นาย</option>
                                <option value="นางสาว">นางสาว</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ชื่อ <span class="required">*</span></label>
                            <input type="text" class="form-control" name="firstName" required placeholder="ชื่อ">
                        </div>
                        <div class="form-group">
                            <label>นามสกุล <span class="required">*</span></label>
                            <input type="text" class="form-control" name="lastName" required placeholder="นามสกุล">
                        </div>
                    </div>

                    <div class="form-row-3">
                        <div class="form-group">
                            <label>วันเกิด <span class="required">*</span></label>
                            <input type="number" class="form-control" name="birthDay" required min="1" max="31" placeholder="วัน (1-31)" id="birthDay">
                        </div>
                        <div class="form-group">
                            <label>เดือนเกิด <span class="required">*</span></label>
                            <select class="form-control" name="birthMonth" required id="birthMonth">
                                <option value="">-- เลือก --</option>
                                <option value="1">มกราคม</option>
                                <option value="2">กุมภาพันธ์</option>
                                <option value="3">มีนาคม</option>
                                <option value="4">เมษายน</option>
                                <option value="5">พฤษภาคม</option>
                                <option value="6">มิถุนายน</option>
                                <option value="7">กรกฎาคม</option>
                                <option value="8">สิงหาคม</option>
                                <option value="9">กันยายน</option>
                                <option value="10">ตุลาคม</option>
                                <option value="11">พฤศจิกายน</option>
                                <option value="12">ธันวาคม</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ปีเกิด พ.ศ. <span class="required">*</span></label>
                            <input type="number" class="form-control" name="birthYear" required min="2500" max="2570" placeholder="พ.ศ. (เช่น 2555)" id="birthYear">
                        </div>
                    </div>

                    <div class="form-row-3">
                        <div class="form-group">
                            <label>อายุ (ปี) <span class="required">*</span></label>
                            <input type="number" class="form-control" name="age" required placeholder="คำนวณอัตโนมัติ" id="ageField" readonly style="background-color: #f0f0f0;">
                        </div>
                        <div class="form-group">
                            <label>หมู่เลือด</label>
                            <select class="form-control" name="bloodType">
                                <option value="">-- เลือก --</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="O">O</option>
                                <option value="AB">AB</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ชื่อเล่น</label>
                            <input type="text" class="form-control" name="nickname" placeholder="ชื่อเล่น">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ส่วนสูง (ซม.)</label>
                            <input type="number" class="form-control" name="height" placeholder="เช่น 145">
                        </div>
                        <div class="form-group">
                            <label>น้ำหนัก (กก.)</label>
                            <input type="number" class="form-control" name="weight" placeholder="เช่น 35">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>เลขประจำตัวประชาชน (13 หลัก) <span class="required">*</span></label>
                        <input type="text" class="form-control" name="nationalId" required maxlength="17" placeholder="x-xxxx-xxxxx-xx-x" id="nationalIdInput">
                    </div>

                    <!-- ข้อมูลบิดา-มารดา -->
                    <h3 style="color: var(--primary); margin: var(--space-xl) 0 var(--space-lg); padding-bottom: var(--space-sm); border-bottom: 2px solid var(--border);">
                        👨‍👩‍👦 ข้อมูลบิดา-มารดา
                    </h3>

                    <div class="form-row-prefix">
                        <div class="form-group">
                            <label>คำนำหน้าบิดา <span class="required">*</span></label>
                            <select class="form-control" name="fatherPrefix" required>
                                <option value="">-- เลือก --</option>
                                <option value="นาย">นาย</option>
                                <option value="นาง">นาง</option>
                                <option value="นางสาว">นางสาว</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ชื่อบิดา <span class="required">*</span></label>
                            <input type="text" class="form-control" name="fatherFirstName" required placeholder="ชื่อ">
                        </div>
                        <div class="form-group">
                            <label>นามสกุลบิดา <span class="required">*</span></label>
                            <input type="text" class="form-control" name="fatherLastName" required placeholder="นามสกุล">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="display:none;">
                            <input type="hidden" name="fatherName" id="fatherNameHidden">
                        </div>
                        <div class="form-group">
                            <label>อายุบิดา</label>
                            <input type="number" class="form-control" name="fatherAge" placeholder="เช่น 45">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>อาชีพบิดา</label>
                        <input type="text" class="form-control" name="fatherOccupation" placeholder="เช่น เกษตรกร">
                    </div>

                    <div class="form-row-prefix">
                        <div class="form-group">
                            <label>คำนำหน้ามารดา <span class="required">*</span></label>
                            <select class="form-control" name="motherPrefix" required>
                                <option value="">-- เลือก --</option>
                                <option value="นาง">นาง</option>
                                <option value="นางสาว">นางสาว</option>
                                <option value="นาย">นาย</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ชื่อมารดา <span class="required">*</span></label>
                            <input type="text" class="form-control" name="motherFirstName" required placeholder="ชื่อ">
                        </div>
                        <div class="form-group">
                            <label>นามสกุลมารดา <span class="required">*</span></label>
                            <input type="text" class="form-control" name="motherLastName" required placeholder="นามสกุล">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="display:none;">
                            <input type="hidden" name="motherName" id="motherNameHidden">
                        </div>
                        <div class="form-group">
                            <label>อายุมารดา</label>
                            <input type="number" class="form-control" name="motherAge" placeholder="เช่น 42">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>อาชีพมารดา</label>
                        <input type="text" class="form-control" name="motherOccupation" placeholder="เช่น ค้าขาย">
                    </div>

                    <!-- ที่อยู่ปัจจุบัน -->
                    <h3 style="color: var(--primary); margin: var(--space-xl) 0 var(--space-lg); padding-bottom: var(--space-sm); border-bottom: 2px solid var(--border);">
                        🏠 ที่อยู่ปัจจุบัน
                    </h3>

                    <div class="form-row-3">
                        <div class="form-group">
                            <label>บ้านเลขที่ <span class="required">*</span></label>
                            <input type="text" class="form-control" name="houseNumber" required placeholder="เช่น 123">
                        </div>
                        <div class="form-group">
                            <label>หมู่ที่ <span class="required">*</span></label>
                            <input type="text" class="form-control" name="moo" required placeholder="เช่น 5">
                        </div>
                        <div class="form-group">
                            <label>ถนน</label>
                            <input type="text" class="form-control" name="road" placeholder="เช่น มิตรภาพ">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ซอย</label>
                            <input type="text" class="form-control" name="soi" placeholder="เช่น สุขสันต์">
                        </div>
                        <div class="form-group">
                            <label>บ้าน/หมู่บ้าน</label>
                            <input type="text" class="form-control" name="village" placeholder="เช่น บ้านโนนสวรรค์">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ตำบล <span class="required">*</span></label>
                            <input type="text" class="form-control" name="subdistrict" required placeholder="เช่น หนองหัวช้าง">
                        </div>
                        <div class="form-group">
                            <label>อำเภอ <span class="required">*</span></label>
                            <input type="text" class="form-control" name="district" required placeholder="เช่น กันทรารมย์">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>จังหวัด <span class="required">*</span></label>
                            <input type="text" class="form-control" name="province" required placeholder="เช่น ศรีสะเกษ">
                        </div>
                        <div class="form-group">
                            <label>รหัสไปรษณีย์ <span class="required">*</span></label>
                            <input type="text" class="form-control" name="postalCode" required maxlength="5" placeholder="เช่น 33130">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>หมายเลขโทรศัพท์</label>
                            <input type="tel" class="form-control" name="phone" placeholder="เช่น 081-234-5678">
                        </div>
                        <div class="form-group">
                            <label>อีเมล</label>
                            <input type="text" class="form-control" name="email" placeholder='ไม่มีใส่ "-"'>
                        </div>
                    </div>

                    <!-- โรงเรียนเดิม -->
                    <h3 style="color: var(--primary); margin: var(--space-xl) 0 var(--space-lg); padding-bottom: var(--space-sm); border-bottom: 2px solid var(--border);">
                        🏫 โรงเรียนเดิม
                    </h3>

                    <div class="form-group">
                        <label>จบชั้นประถมศึกษาปีที่ 6 จากโรงเรียน <span class="required">*</span></label>
                        <input type="text" class="form-control" name="previousSchool" required placeholder="เช่น โรงเรียนบ้านโนนสวรรค์">
                    </div>

                    <div class="form-row-3">
                        <div class="form-group">
                            <label>ตำบล <span class="required">*</span></label>
                            <input type="text" class="form-control" name="schoolSubdistrict" required placeholder="เช่น กระดุมทอง">
                        </div>
                        <div class="form-group">
                            <label>อำเภอ <span class="required">*</span></label>
                            <input type="text" class="form-control" name="schoolDistrict" required placeholder="เช่น กันทรารมย์">
                        </div>
                        <div class="form-group">
                            <label>จังหวัด <span class="required">*</span></label>
                            <input type="text" class="form-control" name="schoolProvince" required placeholder="เช่น ศรีสะเกษ">
                        </div>
                    </div>

                    <!-- ความสามารถพิเศษ -->
                    <h3 style="color: var(--primary); margin: var(--space-xl) 0 var(--space-lg); padding-bottom: var(--space-sm); border-bottom: 2px solid var(--border);">
                        ⭐ ความสามารถพิเศษ
                    </h3>

                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="talent" value="sports">
                            <span>เป็นนักกีฬา (ระบุประเภท)</span>
                        </label>
                    </div>
                    <div class="form-group" id="sportsTypeGroup" style="display: none; margin-left: 2rem;">
                        <input type="text" class="form-control" name="sportsType" placeholder="ระบุประเภทกีฬา">
                    </div>

                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="talent" value="music">
                            <span>เป็นนักดนตรีหรือศิลปะ (ระบุประเภท)</span>
                        </label>
                    </div>
                    <div class="form-group" id="musicTypeGroup" style="display: none; margin-left: 2rem;">
                        <input type="text" class="form-control" name="musicType" placeholder="ระบุประเภทดนตรี/ศิลปะ">
                    </div>

                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="talent" value="other">
                            <span>อื่นๆ (ระบุ)</span>
                        </label>
                    </div>
                    <div class="form-group" id="otherTalentGroup" style="display: none; margin-left: 2rem;">
                        <input type="text" class="form-control" name="otherTalent" placeholder="ระบุความสามารถพิเศษอื่นๆ">
                    </div>

                    <!-- Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" onclick="previewDocument()">
                            👁️ ดูตัวอย่างเอกสาร
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveDocument()">
                            💾 บันทึกเอกสาร
                        </button>
                        <button type="reset" class="btn btn-outline" onclick="clearAutosave(AUTOSAVE_KEY_ADMISSION)">
                            🔄 ล้างข้อมูล
                        </button>
                        <button type="button" class="btn btn-warning hidden" id="testDataBtn" onclick="fillTestData()" style="background: #f59e0b; color: white;">
                            🧪 ทดสอบกรอกข้อมูล
                        </button>
                        <button type="button" class="btn btn-outline" onclick="backToLanding()">
                            ← กลับหน้าหลัก
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- History Panel -->
        <aside class="history-panel">
            <div class="history-header">
                <h3>
                    📚 ประวัติการสมัคร
                    <span class="history-count" id="historyCount">0</span>
                </h3>
                <div style="display:flex; align-items:center; gap:8px; margin-top:4px;">
                    <span class="history-locked-badge hidden" id="historyLockedBadge">🔒 ล็อครายการแล้ว</span>
                </div>
            </div>
            <div class="history-list" id="historyList">
                <div class="empty-history">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p>ยังไม่มีประวัติการสมัคร</p>
                </div>
            </div>
        </aside>
    </main>

    <!-- Preview Modal -->
    <div class="modal-overlay" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📄 ตัวอย่างเอกสารใบสมัคร</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="previewArea"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">ปิด</button>
                <button class="btn btn-success" onclick="printDocument()">🖨️ พิมพ์เอกสาร</button>
            </div>
        </div>
    </div>

    <!-- ===== ใบมอบตัวนักเรียน Modal ===== -->
    <div class="modal-overlay mobtua-modal" id="mobtuaModal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #7b3f9e, #9c4dcc); color: white; flex-shrink: 0;">
                <h3 style="flex:1;">
                    📋 ใบมอบตัวนักเรียน วก.กทว.205
                    <span id="autosaveBadgeMobtua" style="font-size:0.7rem;opacity:0;transition:opacity 0.5s;background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:999px;margin-left:8px;vertical-align:middle;display:inline-block;"></span>
                </h3>
                <button class="modal-close" onclick="closeMobtuaModal()" style="background: rgba(255,255,255,0.2); color: white;">&times;</button>
            </div>
            <div class="modal-body">
                <form id="mobtuaForm">
                    <!-- ข้อมูลด้านบนขวา -->
                    <h3 class="section-divider">🔢 ข้อมูลการเข้าเรียน (ด้านบนขวาของเอกสาร)</h3>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>เลขประจำตัวนักเรียน</label>
                            <input type="text" class="form-control" name="mt_studentId" placeholder="เลขประจำตัว">
                        </div>
                        <div class="form-group">
                            <label>เข้าเรียนชั้น / ห้อง</label>
                            <input type="text" class="form-control" name="mt_classRoom" placeholder="เช่น ม.1/2">
                        </div>
                        <div class="form-group">
                            <label>ปีการศึกษา</label>
                            <input type="text" class="form-control" name="mt_academicYear" placeholder="เช่น 2568" id="mt_academicYear">
                        </div>
                    </div>

                    <!-- ข้อมูลผู้ปกครอง -->
                    <h3 class="section-divider">👤 ข้อมูลผู้ปกครอง</h3>
                    <div class="form-row-prefix">
                        <div class="form-group">
                            <label>คำนำหน้าผู้ปกครอง <span class="required">*</span></label>
                            <select class="form-control" name="mt_guardianPrefix" required>
                                <option value="">-- เลือก --</option>
                                <option value="นาย">นาย</option>
                                <option value="นาง">นาง</option>
                                <option value="นางสาว">นางสาว</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ชื่อผู้ปกครอง <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_guardianFirstName" required placeholder="ชื่อ">
                        </div>
                        <div class="form-group">
                            <label>นามสกุลผู้ปกครอง <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_guardianLastName" required placeholder="นามสกุล">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>เลขประจำตัวประชาชนผู้ปกครอง <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_guardianNationalId" required maxlength="17" placeholder="x-xxxx-xxxxx-xx-x" id="mt_guardianNationalIdInput">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>อาชีพผู้ปกครอง</label>
                            <input type="text" class="form-control" name="mt_guardianOccupation" placeholder="เช่น เกษตรกร">
                        </div>
                        <div class="form-group">
                            <label>สถานที่ทำงาน</label>
                            <input type="text" class="form-control" name="mt_guardianWorkplace" placeholder="เช่น บ้านหนองดุม">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>บ้านเลขที่ <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_guardianHouseNo" required placeholder="เช่น 2">
                        </div>
                        <div class="form-group">
                            <label>หมู่ที่ <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_guardianMoo" required placeholder="เช่น 2">
                        </div>
                        <div class="form-group">
                            <label>ตำบล <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_guardianSubdistrict" required placeholder="เช่น หนองหัวช้าง">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>อำเภอ <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_guardianDistrict" required placeholder="เช่น กันทรารมย์">
                        </div>
                        <div class="form-group">
                            <label>จังหวัด <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_guardianProvince" required placeholder="เช่น ศรีสะเกษ">
                        </div>
                        <div class="form-group">
                            <label>รหัสไปรษณีย์</label>
                            <input type="text" class="form-control" name="mt_guardianPostal" maxlength="5" placeholder="เช่น 33130">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>โทรศัพท์บ้าน</label>
                            <input type="text" class="form-control" name="mt_guardianHomePhone" placeholder="-">
                        </div>
                        <div class="form-group">
                            <label>โทรศัพท์มือถือ</label>
                            <input type="text" class="form-control" name="mt_guardianMobile" placeholder="เช่น 081-234-5678">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>เกี่ยวข้องกับนักเรียนเป็น <span class="required">*</span></label>
                            <select class="form-control" name="mt_guardianRelation" required>
                                <option value="">-- เลือก --</option>
                                <option value="บิดา">บิดา</option>
                                <option value="มารดา">มารดา</option>
                                <option value="อื่นๆ">อื่นๆ (ระบุ)</option>
                            </select>
                        </div>
                        <div class="form-group" id="mt_guardianRelationOtherGroup" style="display:none;">
                            <label>ระบุความสัมพันธ์</label>
                            <input type="text" class="form-control" name="mt_guardianRelationOther" placeholder="เช่น ปู่ ย่า ตา ยาย">
                        </div>
                        <div class="form-group">
                            <label>รายได้ต่อเดือน (บาท)</label>
                            <input type="number" class="form-control" name="mt_guardianIncome" placeholder="เช่น 9000">
                        </div>
                    </div>

                    <!-- ข้อมูลนักเรียน -->
                    <h3 class="section-divider">🎒 ข้อมูลนักเรียน</h3>
                    <div class="form-row-prefix">
                        <div class="form-group">
                            <label>คำนำหน้านักเรียน <span class="required">*</span></label>
                            <select class="form-control" name="mt_studentPrefix" required>
                                <option value="">-- เลือก --</option>
                                <option value="เด็กชาย">เด็กชาย</option>
                                <option value="เด็กหญิง">เด็กหญิง</option>
                                <option value="นาย">นาย</option>
                                <option value="นางสาว">นางสาว</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ชื่อนักเรียน <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_studentFirstName" required placeholder="ชื่อ">
                        </div>
                        <div class="form-group">
                            <label>นามสกุลนักเรียน <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_studentLastName" required placeholder="นามสกุล">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ชื่อเล่น</label>
                            <input type="text" class="form-control" name="mt_studentNickname" placeholder="เช่น เก่ง">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>วันเกิด (วัน)</label>
                            <input type="number" class="form-control" name="mt_birthDay" min="1" max="31" placeholder="1-31" id="mt_birthDay">
                        </div>
                        <div class="form-group">
                            <label>เดือนเกิด</label>
                            <select class="form-control" name="mt_birthMonth" id="mt_birthMonth">
                                <option value="">-- เลือก --</option>
                                <option value="มกราคม">มกราคม</option>
                                <option value="กุมภาพันธ์">กุมภาพันธ์</option>
                                <option value="มีนาคม">มีนาคม</option>
                                <option value="เมษายน">เมษายน</option>
                                <option value="พฤษภาคม">พฤษภาคม</option>
                                <option value="มิถุนายน">มิถุนายน</option>
                                <option value="กรกฎาคม">กรกฎาคม</option>
                                <option value="สิงหาคม">สิงหาคม</option>
                                <option value="กันยายน">กันยายน</option>
                                <option value="ตุลาคม">ตุลาคม</option>
                                <option value="พฤศจิกายน">พฤศจิกายน</option>
                                <option value="ธันวาคม">ธันวาคม</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ปีเกิด พ.ศ.</label>
                            <input type="number" class="form-control" name="mt_birthYear" min="2500" max="2570" placeholder="เช่น 2555" id="mt_birthYear">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>สัญชาติ</label>
                            <input type="text" class="form-control" name="mt_nationality" placeholder="ไทย" value="ไทย">
                        </div>
                        <div class="form-group">
                            <label>เชื้อชาติ</label>
                            <input type="text" class="form-control" name="mt_ethnicity" placeholder="ไทย" value="ไทย">
                        </div>
                        <div class="form-group">
                            <label>ศาสนา</label>
                            <input type="text" class="form-control" name="mt_religion" placeholder="พุทธ" value="พุทธ">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>ส่วนสูง (ซม.)</label>
                            <input type="number" class="form-control" name="mt_height" placeholder="เช่น 155">
                        </div>
                        <div class="form-group">
                            <label>น้ำหนัก (กก.)</label>
                            <input type="number" class="form-control" name="mt_weight" placeholder="เช่น 45">
                        </div>
                        <div class="form-group">
                            <label>โรคประจำตัว</label>
                            <input type="text" class="form-control" name="mt_disease" placeholder="ถ้าไม่มีใส่ -">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>เลขที่บัตรประจำตัวประชาชนนักเรียน <span class="required">*</span></label>
                        <input type="text" class="form-control" name="mt_studentNationalId" required maxlength="17" placeholder="x-xxxx-xxxxx-xx-x" id="mt_studentNationalIdInput">
                    </div>

                    <!-- ที่อยู่นักเรียนตามทะเบียนบ้าน -->
                    <h3 class="section-divider">🏠 ที่อยู่นักเรียน (ตามทะเบียนบ้าน)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>รหัสประจำบ้าน</label>
                            <input type="text" class="form-control" name="mt_houseCode" placeholder="รหัสประจำบ้าน 11 หลัก">
                        </div>
                        <div class="form-group">
                            <label>บ้านเลขที่ <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_houseNo" required placeholder="เช่น 14">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>หมู่ที่ <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_moo" required placeholder="เช่น 2">
                        </div>
                        <div class="form-group">
                            <label>ตำบล <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_subdistrict" required placeholder="เช่น หนองหัวช้าง">
                        </div>
                        <div class="form-group">
                            <label>อำเภอ <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_district" required placeholder="เช่น กันทรารมย์">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>จังหวัด <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_province" required placeholder="เช่น ศรีสะเกษ">
                        </div>
                        <div class="form-group">
                            <label>รหัสไปรษณีย์</label>
                            <input type="text" class="form-control" name="mt_postal" maxlength="5" placeholder="เช่น 33130">
                        </div>
                        <div class="form-group">
                            <label>โทรศัพท์มือถือ</label>
                            <input type="text" class="form-control" name="mt_mobile" placeholder="เช่น 069-789-8989">
                        </div>
                    </div>

                    <!-- ที่อยู่ปัจจุบัน -->
                    <h3 class="section-divider">📍 ที่อยู่นักเรียน (ปัจจุบัน)</h3>
                    <div class="form-group" style="margin-bottom: var(--space-md);">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="mt_sameAddress" onchange="copyAddressToCurrentMT()" style="width: 20px; height: 20px;">
                            <span>ที่อยู่ปัจจุบันเดียวกับทะเบียนบ้าน</span>
                        </label>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>รหัสประจำบ้าน (ปัจจุบัน)</label>
                            <input type="text" class="form-control" name="mt_curHouseCode" placeholder="รหัสประจำบ้าน 11 หลัก">
                        </div>
                        <div class="form-group">
                            <label>บ้านเลขที่ (ปัจจุบัน) <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_curHouseNo" required placeholder="เช่น 14">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>หมู่ที่ (ปัจจุบัน) <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_curMoo" required placeholder="เช่น 2">
                        </div>
                        <div class="form-group">
                            <label>ตำบล (ปัจจุบัน) <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_curSubdistrict" required placeholder="เช่น หนองหัวช้าง">
                        </div>
                        <div class="form-group">
                            <label>อำเภอ (ปัจจุบัน) <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_curDistrict" required placeholder="เช่น กันทรารมย์">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>จังหวัด (ปัจจุบัน) <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_curProvince" required placeholder="เช่น ศรีสะเกษ">
                        </div>
                        <div class="form-group">
                            <label>รหัสไปรษณีย์ (ปัจจุบัน)</label>
                            <input type="text" class="form-control" name="mt_curPostal" maxlength="5" placeholder="เช่น 33130">
                        </div>
                        <div class="form-group">
                            <label>โทรศัพท์มือถือ (ปัจจุบัน)</label>
                            <input type="text" class="form-control" name="mt_curMobile" placeholder="เช่น 069-789-8989">
                        </div>
                    </div>

                    <!-- ข้อมูลเพิ่มเติมนักเรียน -->
                    <h3 class="section-divider">ℹ️ ข้อมูลเพิ่มเติม</h3>
                    <div class="form-group">
                        <label>การพักนอนของนักเรียน <span class="required">*</span></label>
                        <div class="checkbox-group" style="flex-direction: row; flex-wrap: wrap; gap: 1rem; margin-top: 0.5rem;">
                            <label class="checkbox-item" style="min-height: auto;">
                                <input type="radio" name="mt_sleeping" value="อาศัยอยู่กับญาติ" required>
                                <span>อาศัยอยู่กับญาติ</span>
                            </label>
                            <label class="checkbox-item" style="min-height: auto;">
                                <input type="radio" name="mt_sleeping" value="อาศัยอยู่กับบิดามารดา">
                                <span>อาศัยอยู่กับบิดามารดา</span>
                            </label>
                            <label class="checkbox-item" style="min-height: auto;">
                                <input type="radio" name="mt_sleeping" value="อื่นๆ">
                                <span>อื่นๆ ระบุ</span>
                            </label>
                        </div>
                        <input type="text" class="form-control" name="mt_sleepingOther" placeholder="ระบุ (กรณีเลือกอื่นๆ)" style="margin-top: 0.5rem;">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ความด้อยโอกาส <span class="required">*</span></label>
                            <div class="checkbox-group" style="flex-direction: row; gap: 1rem; margin-top: 0.5rem;">
                                <label class="checkbox-item" style="min-height: auto;">
                                    <input type="radio" name="mt_disadvantaged" value="ด้อยโอกาส" required>
                                    <span>ด้อยโอกาส</span>
                                </label>
                                <label class="checkbox-item" style="min-height: auto;">
                                    <input type="radio" name="mt_disadvantaged" value="ไม่ด้อยโอกาส">
                                    <span>ไม่ด้อยโอกาส</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>การเดินทางมาโรงเรียน (เลือกได้หลายอย่าง)</label>
                        <div class="checkbox-group" style="flex-direction: row; flex-wrap: wrap; gap: 0.5rem 1rem; margin-top: 0.5rem;">
                            <label class="checkbox-item" style="min-height: auto;">
                                <input type="checkbox" name="mt_transport" value="เดินเท้า">
                                <span>เดินเท้า</span>
                            </label>
                            <label class="checkbox-item" style="min-height: auto;">
                                <input type="checkbox" name="mt_transport" value="จักรยาน">
                                <span>จักรยาน</span>
                            </label>
                            <label class="checkbox-item" style="min-height: auto;">
                                <input type="checkbox" name="mt_transport" value="รถรับส่ง">
                                <span>รถรับส่ง</span>
                            </label>
                            <label class="checkbox-item" style="min-height: auto;">
                                <input type="checkbox" name="mt_transport" value="รถจักรยานยนต์">
                                <span>รถจักรยานยนต์</span>
                            </label>
                            <label class="checkbox-item" style="min-height: auto;">
                                <input type="checkbox" name="mt_transport" value="อื่นๆ">
                                <span>อื่นๆ ระบุ</span>
                            </label>
                        </div>
                        <input type="text" class="form-control" name="mt_transportOther" placeholder="ระบุ (กรณีเลือกอื่นๆ)" style="margin-top: 0.5rem;">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>เวลาเดินทาง (นาที)</label>
                            <input type="number" class="form-control" name="mt_travelTime" placeholder="เช่น 10">
                        </div>
                        <div class="form-group">
                            <label>ระยะทางจากบ้าน (กม./เมตร)</label>
                            <input type="text" class="form-control" name="mt_travelDistance" placeholder="เช่น 5 กิโลเมตร">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>จำนวนพี่น้องทั้งหมด (คน รวมตัวเอง)</label>
                            <input type="number" class="form-control" name="mt_siblings" placeholder="เช่น 4">
                        </div>
                        <div class="form-group">
                            <label>นักเรียนเป็นบุตรคนที่</label>
                            <input type="number" class="form-control" name="mt_birthOrder" placeholder="เช่น 3">
                        </div>
                        <div class="form-group">
                            <label>พี่น้องกำลังศึกษาอยู่ (คน)</label>
                            <input type="number" class="form-control" name="mt_siblingsStudying" placeholder="เช่น 2">
                        </div>
                    </div>
                    <div class="form-row" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="form-group">
                            <label>พี่ชาย (คน)</label>
                            <input type="number" class="form-control" name="mt_olderBrothers" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>น้องชาย (คน)</label>
                            <input type="number" class="form-control" name="mt_youngerBrothers" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>พี่สาว (คน)</label>
                            <input type="number" class="form-control" name="mt_olderSisters" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>น้องสาว (คน)</label>
                            <input type="number" class="form-control" name="mt_youngerSisters" placeholder="0">
                        </div>
                    </div>

                    <!-- ข้อมูลบิดา -->
                    <h3 class="section-divider">👨 ข้อมูลบิดา</h3>
                    <div class="form-row-prefix">
                        <div class="form-group">
                            <label>คำนำหน้าบิดา</label>
                            <select class="form-control" name="mt_fatherPrefix">
                                <option value="">-- เลือก --</option>
                                <option value="นาย">นาย</option>
                                <option value="นาง">นาง</option>
                                <option value="นางสาว">นางสาว</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ชื่อบิดา <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_fatherFirstName" required placeholder="ชื่อ">
                        </div>
                        <div class="form-group">
                            <label>นามสกุลบิดา <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_fatherLastName" required placeholder="นามสกุล">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>เลขประจำตัวประชาชนบิดา</label>
                            <input type="text" class="form-control" name="mt_fatherNationalId" maxlength="17" placeholder="x-xxxx-xxxxx-xx-x" id="mt_fatherNationalIdInput">
                        </div>
                    </div>
                    <div class="form-row" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="form-group">
                            <label>สัญชาติบิดา</label>
                            <input type="text" class="form-control" name="mt_fatherNationality" placeholder="ไทย" value="ไทย">
                        </div>
                        <div class="form-group">
                            <label>เชื้อชาติบิดา</label>
                            <input type="text" class="form-control" name="mt_fatherEthnicity" placeholder="ไทย" value="ไทย">
                        </div>
                        <div class="form-group">
                            <label>ศาสนาบิดา</label>
                            <input type="text" class="form-control" name="mt_fatherReligion" placeholder="พุทธ" value="พุทธ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>สถานะบิดา</label>
                            <div class="checkbox-group" style="flex-direction: row; gap: 1rem; margin-top: 0.5rem;">
                                <label class="checkbox-item" style="min-height: auto;">
                                    <input type="radio" name="mt_fatherAlive" value="มีชีวิตอยู่">
                                    <span>มีชีวิตอยู่</span>
                                </label>
                                <label class="checkbox-item" style="min-height: auto;">
                                    <input type="radio" name="mt_fatherAlive" value="เสียชีวิต">
                                    <span>เสียชีวิต</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>การศึกษาบิดา</label>
                            <input type="text" class="form-control" name="mt_fatherEducation" placeholder="เช่น ม.6, ป.ตรี">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>อาชีพบิดา</label>
                            <input type="text" class="form-control" name="mt_fatherOccupation" placeholder="เช่น เกษตรกร">
                        </div>
                        <div class="form-group">
                            <label>สถานที่ทำงานบิดา</label>
                            <input type="text" class="form-control" name="mt_fatherWorkplace" placeholder="ที่ทำงาน">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>ตำบล (บิดา)</label>
                            <input type="text" class="form-control" name="mt_fatherSubdistrict" placeholder="ตำบล">
                        </div>
                        <div class="form-group">
                            <label>อำเภอ (บิดา)</label>
                            <input type="text" class="form-control" name="mt_fatherDistrict" placeholder="อำเภอ">
                        </div>
                        <div class="form-group">
                            <label>จังหวัด (บิดา)</label>
                            <input type="text" class="form-control" name="mt_fatherProvince" placeholder="จังหวัด">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>รายได้ต่อเดือนบิดา (บาท)</label>
                            <input type="number" class="form-control" name="mt_fatherIncome" placeholder="เช่น 9000">
                        </div>
                        <div class="form-group">
                            <label>โทรศัพท์มือถือบิดา</label>
                            <input type="text" class="form-control" name="mt_fatherMobile" placeholder="เช่น 069-789-8989">
                        </div>
                    </div>

                    <!-- ข้อมูลมารดา -->
                    <h3 class="section-divider">👩 ข้อมูลมารดา</h3>
                    <div class="form-row-prefix">
                        <div class="form-group">
                            <label>คำนำหน้ามารดา</label>
                            <select class="form-control" name="mt_motherPrefix">
                                <option value="">-- เลือก --</option>
                                <option value="นาง">นาง</option>
                                <option value="นางสาว">นางสาว</option>
                                <option value="นาย">นาย</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ชื่อมารดา <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_motherFirstName" required placeholder="ชื่อ">
                        </div>
                        <div class="form-group">
                            <label>นามสกุลมารดา <span class="required">*</span></label>
                            <input type="text" class="form-control" name="mt_motherLastName" required placeholder="นามสกุล">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>เลขประจำตัวประชาชนมารดา</label>
                            <input type="text" class="form-control" name="mt_motherNationalId" maxlength="17" placeholder="x-xxxx-xxxxx-xx-x" id="mt_motherNationalIdInput">
                        </div>
                    </div>
                    <div class="form-row" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="form-group">
                            <label>สัญชาติมารดา</label>
                            <input type="text" class="form-control" name="mt_motherNationality" placeholder="ไทย" value="ไทย">
                        </div>
                        <div class="form-group">
                            <label>เชื้อชาติมารดา</label>
                            <input type="text" class="form-control" name="mt_motherEthnicity" placeholder="ไทย" value="ไทย">
                        </div>
                        <div class="form-group">
                            <label>ศาสนามารดา</label>
                            <input type="text" class="form-control" name="mt_motherReligion" placeholder="พุทธ" value="พุทธ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>สถานะมารดา</label>
                            <div class="checkbox-group" style="flex-direction: row; gap: 1rem; margin-top: 0.5rem;">
                                <label class="checkbox-item" style="min-height: auto;">
                                    <input type="radio" name="mt_motherAlive" value="มีชีวิตอยู่">
                                    <span>มีชีวิตอยู่</span>
                                </label>
                                <label class="checkbox-item" style="min-height: auto;">
                                    <input type="radio" name="mt_motherAlive" value="เสียชีวิต">
                                    <span>เสียชีวิต</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>การศึกษามารดา</label>
                            <input type="text" class="form-control" name="mt_motherEducation" placeholder="เช่น ม.6, ป.ตรี">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>อาชีพมารดา</label>
                            <input type="text" class="form-control" name="mt_motherOccupation" placeholder="เช่น เกษตรกร">
                        </div>
                        <div class="form-group">
                            <label>สถานที่ทำงานมารดา</label>
                            <input type="text" class="form-control" name="mt_motherWorkplace" placeholder="ที่ทำงาน">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>ตำบล (มารดา)</label>
                            <input type="text" class="form-control" name="mt_motherSubdistrict" placeholder="ตำบล">
                        </div>
                        <div class="form-group">
                            <label>อำเภอ (มารดา)</label>
                            <input type="text" class="form-control" name="mt_motherDistrict" placeholder="อำเภอ">
                        </div>
                        <div class="form-group">
                            <label>จังหวัด (มารดา)</label>
                            <input type="text" class="form-control" name="mt_motherProvince" placeholder="จังหวัด">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>รายได้ต่อเดือนมารดา (บาท)</label>
                            <input type="number" class="form-control" name="mt_motherIncome" placeholder="เช่น 9000">
                        </div>
                        <div class="form-group">
                            <label>โทรศัพท์มือถือมารดา</label>
                            <input type="text" class="form-control" name="mt_motherMobile" placeholder="เช่น 088-234-5678">
                        </div>
                    </div>

                    <!-- สถานภาพบิดา-มารดา -->
                    <h3 class="section-divider">👨‍👩‍👦 สถานภาพบิดา-มารดา</h3>
                    <div class="form-group">
                        <div class="checkbox-group" style="flex-direction: row; flex-wrap: wrap; gap: 0.5rem 1.5rem; margin-top: 0.5rem;">
                            <label class="checkbox-item" style="min-height: auto;">
                                <input type="radio" name="mt_parentStatus" value="อยู่ร่วมกัน">
                                <span>อยู่ร่วมกัน</span>
                            </label>
                            <label class="checkbox-item" style="min-height: auto;">
                                <input type="radio" name="mt_parentStatus" value="แยกกันอยู่">
                                <span>แยกกันอยู่</span>
                            </label>
                            <label class="checkbox-item" style="min-height: auto;">
                                <input type="radio" name="mt_parentStatus" value="อย่าร้าง">
                                <span>อย่าร้าง</span>
                            </label>
                            <label class="checkbox-item" style="min-height: auto;">
                                <input type="radio" name="mt_parentStatus" value="บิดาเสียชีวิต">
                                <span>บิดาเสียชีวิต</span>
                            </label>
                            <label class="checkbox-item" style="min-height: auto;">
                                <input type="radio" name="mt_parentStatus" value="มารดาเสียชีวิต">
                                <span>มารดาเสียชีวิต</span>
                            </label>
                            <label class="checkbox-item" style="min-height: auto;">
                                <input type="radio" name="mt_parentStatus" value="อื่นๆ">
                                <span>อื่นๆ</span>
                            </label>
                        </div>
                        <input type="text" class="form-control" name="mt_parentStatusOther" placeholder="ระบุ (กรณีเลือกอื่นๆ)" style="margin-top: 0.5rem;">
                    </div>

                    <!-- ข้อมูลผู้ปกครองที่ไม่ใช่บิดา/มารดา -->
                    <h3 class="section-divider">👥 ข้อมูลผู้ปกครอง (กรณีไม่ได้อยู่กับบิดา/มารดา)</h3>
                    <p style="font-size: var(--text-sm); color: var(--text-light); margin-bottom: 1rem;">กรอกเฉพาะกรณีนักเรียนไม่ได้อยู่กับบิดา/มารดา</p>
                    <div class="form-row-prefix">
                        <div class="form-group">
                            <label>คำนำหน้า</label>
                            <select class="form-control" name="mt_altGuardianPrefix">
                                <option value="">-- เลือก --</option>
                                <option value="นาย">นาย</option>
                                <option value="นาง">นาง</option>
                                <option value="นางสาว">นางสาว</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ชื่อผู้ปกครอง (ถ้ามี)</label>
                            <input type="text" class="form-control" name="mt_altGuardianFirstName" placeholder="ชื่อ">
                        </div>
                        <div class="form-group">
                            <label>นามสกุล</label>
                            <input type="text" class="form-control" name="mt_altGuardianLastName" placeholder="นามสกุล">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>เกี่ยวข้องกับนักเรียนเป็น</label>
                            <input type="text" class="form-control" name="mt_altGuardianRelation" placeholder="เช่น ปู่ ย่า ตา ยาย ลุง ป้า">
                        </div>
                    </div>
                    <div class="form-row" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="form-group">
                            <label>สัญชาติ</label>
                            <input type="text" class="form-control" name="mt_altGuardianNationality" placeholder="ไทย">
                        </div>
                        <div class="form-group">
                            <label>เชื้อชาติ</label>
                            <input type="text" class="form-control" name="mt_altGuardianEthnicity" placeholder="ไทย">
                        </div>
                        <div class="form-group">
                            <label>ศาสนา</label>
                            <input type="text" class="form-control" name="mt_altGuardianReligion" placeholder="พุทธ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>อาชีพ</label>
                            <input type="text" class="form-control" name="mt_altGuardianOccupation" placeholder="อาชีพ">
                        </div>
                        <div class="form-group">
                            <label>รายได้ต่อเดือน (บาท)</label>
                            <input type="number" class="form-control" name="mt_altGuardianIncome" placeholder="เช่น 8000">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>บ้านเลขที่</label>
                            <input type="text" class="form-control" name="mt_altGuardianHouseNo" placeholder="เลขที่">
                        </div>
                        <div class="form-group">
                            <label>หมู่ที่</label>
                            <input type="text" class="form-control" name="mt_altGuardianMoo" placeholder="หมู่">
                        </div>
                        <div class="form-group">
                            <label>ถนน</label>
                            <input type="text" class="form-control" name="mt_altGuardianRoad" placeholder="ถนน">
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>ตำบล</label>
                            <input type="text" class="form-control" name="mt_altGuardianSubdistrict" placeholder="ตำบล">
                        </div>
                        <div class="form-group">
                            <label>อำเภอ</label>
                            <input type="text" class="form-control" name="mt_altGuardianDistrict" placeholder="อำเภอ">
                        </div>
                        <div class="form-group">
                            <label>จังหวัด</label>
                            <input type="text" class="form-control" name="mt_altGuardianProvince" placeholder="จังหวัด">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>สถานที่ทำงาน</label>
                            <input type="text" class="form-control" name="mt_altGuardianWorkplace" placeholder="สถานที่ทำงาน">
                        </div>
                        <div class="form-group">
                            <label>โทรศัพท์มือถือ</label>
                            <input type="text" class="form-control" name="mt_altGuardianMobile" placeholder="เบอร์โทร">
                        </div>
                    </div>

                    <!-- ปุ่ม action -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" onclick="previewMobtuaDocument()" style="background: linear-gradient(135deg, #7b3f9e, #9c4dcc);">
                            👁️ ดูตัวอย่างเอกสาร
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveMobtuaDocument()">
                            💾 บันทึกเอกสาร
                        </button>
                        <button type="reset" class="btn btn-outline" style="color: #7b3f9e; border-color: #7b3f9e;" onclick="clearAutosave(AUTOSAVE_KEY_MOBTUA)">
                            🔄 ล้างข้อมูล
                        </button>
                        <button type="button" class="btn hidden" id="mobtuaTestDataBtn" onclick="fillMobtuaTestData()" style="background: #f59e0b; color: white;">
                            🧪 กรอกข้อมูลตัวอย่าง
                        </button>
                        <button type="button" class="btn btn-outline" onclick="closeMobtuaModal()">
                            ← กลับหน้าหลัก
                        </button>
                    </div>
                </form>

                <!-- ประวัติใบมอบตัว -->
                <div style="margin-top: 2rem; border-top: 3px solid #e9d5ff; padding-top: 1.5rem;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem;">
                        <h3 style="color:#7b3f9e; font-size:1.1rem; display:flex; align-items:center; gap:0.5rem;">
                            📚 ประวัติใบมอบตัว
                            <span id="mobtuaHistoryCount" style="background:#7b3f9e; color:white; padding:2px 10px; border-radius:999px; font-size:0.8rem;">0</span>
                        </h3>
                        <span class="history-locked-badge hidden" id="mobtuaLockedBadge">🔒 ล็อครายการแล้ว</span>
                    </div>
                    <div id="mobtuaHistoryList">
                        <div class="empty-history">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:48px;height:48px;opacity:0.4;margin-bottom:0.5rem;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p>ยังไม่มีประวัติใบมอบตัว</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ใบมอบตัว Preview Modal -->
    <div class="modal-overlay" id="mobtuaPreviewModal" style="z-index: 1200;">
        <div class="modal-content" style="max-width: 950px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #7b3f9e, #9c4dcc); color: white;">
                <h3>📄 ตัวอย่างใบมอบตัวนักเรียน วก.กทว.205</h3>
                <button class="modal-close" onclick="closeMobtuaPreviewModal()" style="background: rgba(255,255,255,0.2); color: white;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="mobtuaPreviewArea"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeMobtuaPreviewModal()">ปิด</button>
                <button class="btn btn-success" onclick="printMobtuaDocument()">🖨️ พิมพ์เอกสาร</button>
            </div>
        </div>
    </div>

    <!-- Hidden Print Area for ใบมอบตัว -->
    <div id="mobtuaPrintArea" style="display:none;"></div>

    <!-- Hidden Print Area for ใบสมัคร -->
    <div id="printArea" style="display:none;"></div>

    <!-- Mobtua Edit Modal -->
    <div class="modal-overlay" id="mobtuaEditModal" style="z-index: 1300;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #7b3f9e, #9c4dcc); color: white;">
                <h3>✏️ แก้ไขข้อมูลใบมอบตัว</h3>
                <button class="modal-close" onclick="closeMobtuaEditModal()" style="background: rgba(255,255,255,0.2); color: white;">&times;</button>
            </div>
            <div class="modal-body" style="background: white; padding: 1.5rem;">
                <input type="hidden" id="mobtuaEditId">
                <div class="form-row">
                    <div class="form-group">
                        <label>ชั้น/ห้อง <span class="required">*</span></label>
                        <input type="text" class="form-control" id="mobtuaEditClassRoom" placeholder="เช่น ม.1/2">
                    </div>
                    <div class="form-group">
                        <label>ปีการศึกษา</label>
                        <input type="text" class="form-control" id="mobtuaEditAcademicYear" placeholder="เช่น 2568">
                    </div>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label>คำนำหน้านักเรียน</label>
                        <select class="form-control" id="mobtuaEditStudentPrefix">
                            <option value="เด็กชาย">เด็กชาย</option>
                            <option value="เด็กหญิง">เด็กหญิง</option>
                            <option value="นาย">นาย</option>
                            <option value="นางสาว">นางสาว</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ชื่อนักเรียน <span class="required">*</span></label>
                        <input type="text" class="form-control" id="mobtuaEditStudentFirstName" placeholder="ชื่อ">
                    </div>
                    <div class="form-group">
                        <label>นามสกุลนักเรียน <span class="required">*</span></label>
                        <input type="text" class="form-control" id="mobtuaEditStudentLastName" placeholder="นามสกุล">
                    </div>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label>คำนำหน้าผู้ปกครอง</label>
                        <select class="form-control" id="mobtuaEditGuardianPrefix">
                            <option value="นาย">นาย</option>
                            <option value="นาง">นาง</option>
                            <option value="นางสาว">นางสาว</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ชื่อผู้ปกครอง</label>
                        <input type="text" class="form-control" id="mobtuaEditGuardianFirstName" placeholder="ชื่อ">
                    </div>
                    <div class="form-group">
                        <label>นามสกุลผู้ปกครอง</label>
                        <input type="text" class="form-control" id="mobtuaEditGuardianLastName" placeholder="นามสกุล">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>โทรมือถือผู้ปกครอง</label>
                        <input type="text" class="form-control" id="mobtuaEditGuardianMobile" placeholder="เบอร์โทร">
                    </div>
                    <div class="form-group">
                        <label>โรงเรียนเดิม</label>
                        <input type="text" class="form-control" id="mobtuaEditPreviousSchool" placeholder="ชื่อโรงเรียน">
                    </div>
                </div>
                <p style="font-size:var(--text-sm); color:var(--text-light); margin-top:8px;">
                    * แก้ไขข้อมูลหลักเท่านั้น หากต้องการแก้ไขทั้งหมด กรุณาลบแล้วกรอกใหม่
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeMobtuaEditModal()">ยกเลิก</button>
                <button class="btn btn-success" onclick="saveMobtuaEditRecord()" style="background: linear-gradient(135deg,#7b3f9e,#9c4dcc);">💾 บันทึกการแก้ไข</button>
            </div>
        </div>
    </div>

    <!-- Admin Settings Modal -->
    <div class="modal-overlay" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚙️ ตั้งค่าแอดมิน</h3>
                <button class="modal-close" onclick="closeAdminModal()">&times;</button>
            </div>
            <div class="modal-body" style="background: white; padding: 2rem;">
                
                <div style="margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--primary);">📅 ตั้งค่าปีการศึกษาเริ่มต้น</h4>
                    <div class="form-group">
                        <label>ปีการศึกษา:</label>
                        <input type="text" class="form-control" id="defaultAcademicYear" placeholder="เช่น 2567">
                    </div>
                    <button class="btn btn-primary" onclick="saveDefaultYear()" style="width: 100%;">
                        💾 บันทึกปีการศึกษา
                    </button>
                </div>

                <div style="margin-bottom: 2rem; padding-top: 2rem; border-top: 2px solid var(--border);">
                    <h4 style="margin-bottom: 1rem; color: var(--primary);">🔒 ล็อครายการประวัติการสมัคร</h4>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="historyLockToggle" onchange="toggleHistoryLock()" style="width: 20px; height: 20px;">
                            <span>ล็อครายการ (ไม่ให้แก้ไข/ลบ)</span>
                        </label>
                        <p style="font-size:var(--text-sm); color:var(--text-light); margin-top:6px;">
                            เมื่อล็อค ปุ่มแก้ไขและลบจะถูกซ่อน ต้องปลดล็อคด้วยรหัสแอดมิน
                        </p>
                    </div>
                </div>

                <div style="margin-bottom: 2rem; padding-top: 2rem; border-top: 2px solid var(--border);">
                    <h4 style="margin-bottom: 1rem; color: var(--primary);">🧪 ระบบทดสอบ</h4>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="testModeToggle" onchange="toggleTestMode()" style="width: 20px; height: 20px;">
                            <span>เปิดใช้งานปุ่มทดสอบกรอกข้อมูล</span>
                        </label>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem; padding-top: 2rem; border-top: 2px solid var(--border);">
                    <h4 style="margin-bottom: 1rem; color: var(--primary);">📊 ส่งออกข้อมูล Excel</h4>
                    <button class="btn btn-success" onclick="exportToExcel()" style="width: 100%; margin-bottom: 0.75rem;">
                        📥 ดาวน์โหลดข้อมูลใบสมัคร (Excel)
                    </button>
                    <button class="btn btn-success" onclick="exportMobtuaToExcel()" style="width: 100%; background: linear-gradient(135deg,#7b3f9e,#9c4dcc);">
                        📥 ดาวน์โหลดข้อมูลใบมอบตัว (Excel)
                    </button>
                </div>
                
                <div style="margin-bottom: 2rem; padding-top: 2rem; border-top: 2px solid var(--border);">
                    <h4 style="margin-bottom: 1rem; color: var(--primary);">🔔 ประกาศแจ้งเตือน</h4>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="alertToggle" onchange="toggleAlert()" style="width: 20px; height: 20px;">
                            <span>เปิดใช้งานประกาศแจ้งเตือน</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label>ข้อความประกาศ:</label>
                        <textarea class="form-control" id="alertMessage" rows="4" placeholder="กรอกข้อความประกาศ..." style="resize: vertical;"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="saveAlertSettings()" style="width: 100%;">
                        💾 บันทึกการตั้งค่า
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Record Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>✏️ แก้ไขข้อมูล</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body" style="background: white; padding: 1.5rem;">
                <input type="hidden" id="editRecordId">
                <div class="form-group">
                    <label>ระดับชั้น <span class="required">*</span></label>
                    <select class="form-control" id="editGradeLevel">
                        <option value="m1">มัธยมศึกษาปีที่ 1</option>
                        <option value="m4">มัธยมศึกษาปีที่ 4</option>
                    </select>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label>คำนำหน้า</label>
                        <select class="form-control" id="editPrefix">
                            <option value="เด็กชาย">เด็กชาย</option>
                            <option value="เด็กหญิง">เด็กหญิง</option>
                            <option value="นาย">นาย</option>
                            <option value="นางสาว">นางสาว</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ชื่อ <span class="required">*</span></label>
                        <input type="text" class="form-control" id="editFirstName" placeholder="ชื่อ">
                    </div>
                    <div class="form-group">
                        <label>นามสกุล <span class="required">*</span></label>
                        <input type="text" class="form-control" id="editLastName" placeholder="นามสกุล">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>โทรศัพท์</label>
                        <input type="text" class="form-control" id="editPhone" placeholder="เช่น 081-234-5678">
                    </div>
                    <div class="form-group">
                        <label>โรงเรียนเดิม</label>
                        <input type="text" class="form-control" id="editPreviousSchool" placeholder="ชื่อโรงเรียน">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>อำเภอ</label>
                        <input type="text" class="form-control" id="editDistrict" placeholder="อำเภอ">
                    </div>
                    <div class="form-group">
                        <label>จังหวัด</label>
                        <input type="text" class="form-control" id="editProvince" placeholder="จังหวัด">
                    </div>
                </div>
                <p style="font-size:var(--text-sm); color:var(--text-light); margin-top:8px;">
                    * สำหรับแก้ไขข้อมูลหลักเท่านั้น หากต้องการแก้ไขข้อมูลทั้งหมด กรุณาลบแล้วกรอกใหม่
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeEditModal()">ยกเลิก</button>
                <button class="btn btn-success" onclick="saveEditRecord()">💾 บันทึกการแก้ไข</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="modal-overlay" id="alertAnnouncementModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ed8936, #f6ad55); color: white;">
                <h3>🔔 ประกาศ</h3>
                <button class="modal-close" onclick="closeAlertModal()">&times;</button>
            </div>
            <div class="modal-body" style="background: white; padding: 2rem;">
                <div id="alertContent" style="font-size: 1.1rem; line-height: 1.8; white-space: pre-wrap;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeAlertModal()">รับทราบ</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toastMessage">บันทึกข้อมูลสำเร็จ</span>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, getDoc, doc, deleteDoc, updateDoc, query, orderBy, limit, where, Timestamp, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAZruE6dHfH2uFjE0TAet7Yys8H5soATVY",
            authDomain: "recruitstudents2026.firebaseapp.com",
            projectId: "recruitstudents2026",
            storageBucket: "recruitstudents2026.firebasestorage.app",
            messagingSenderId: "312157707609",
            appId: "1:312157707609:web:164adccd4f6c95af990048"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.firestore = { collection, addDoc, getDocs, getDoc, doc, deleteDoc, updateDoc, query, orderBy, limit, where, Timestamp, serverTimestamp };

        console.log('Firebase initialized successfully!');
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            setDefaultDate();
        });

        function setupEventListeners() {
            const talentCheckboxes = document.querySelectorAll('input[name="talent"]');
            talentCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.value === 'sports') {
                        document.getElementById('sportsTypeGroup').style.display = this.checked ? 'block' : 'none';
                    } else if (this.value === 'music') {
                        document.getElementById('musicTypeGroup').style.display = this.checked ? 'block' : 'none';
                    } else if (this.value === 'other') {
                        document.getElementById('otherTalentGroup').style.display = this.checked ? 'block' : 'none';
                    }
                });
            });

            document.getElementById('previewModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });

            // คำนวณอายุอัตโนมัติ
            ['birthDay', 'birthMonth', 'birthYear'].forEach(id => {
                document.getElementById(id)?.addEventListener('change', calculateAge);
            });

            // Format บัตรประชาชนอัตโนมัติ
            const nationalIdInput = document.getElementById('nationalIdInput');
            if (nationalIdInput) {
                nationalIdInput.addEventListener('input', formatNationalId);
            }
        }

        function calculateAge() {
            const day = document.getElementById('birthDay')?.value;
            const month = document.getElementById('birthMonth')?.value;
            const year = document.getElementById('birthYear')?.value;
            
            if (day && month && year) {
                const buddhist = parseInt(year);
                const christian = buddhist - 543;
                const birthDate = new Date(christian, parseInt(month) - 1, parseInt(day));
                const today = new Date();
                
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                document.getElementById('ageField').value = age;
            }
        }

        function formatNationalId(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            
            if (value.length > 13) {
                value = value.substring(0, 13);
            }
            
            let formatted = '';
            if (value.length > 0) formatted += value.substring(0, 1);
            if (value.length > 1) formatted += '-' + value.substring(1, 5);
            if (value.length > 5) formatted += '-' + value.substring(5, 10);
            if (value.length > 10) formatted += '-' + value.substring(10, 12);
            if (value.length > 12) formatted += '-' + value.substring(12, 13);
            
            e.target.value = formatted;
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="applicationDate"]').value = today;
            
            // โหลดปีการศึกษาเริ่มต้นจาก localStorage
            const defaultYear = localStorage.getItem('defaultAcademicYear');
            if (defaultYear) {
                document.getElementById('academicYear').value = defaultYear;
            } else {
                const currentYear = new Date().getFullYear() + 543;
                document.getElementById('academicYear').value = currentYear;
            }
        }

        function backToLanding() {
            document.getElementById('mainContainer').classList.add('hidden');
            document.getElementById('landingPage').classList.remove('hidden');
            backToStep1();
        }

        function showLandingStep2(type) {
            document.getElementById('landingStep1').style.display = 'none';
            if (type === 'admission') {
                document.getElementById('landingStep2Admission').classList.add('active');
            } else {
                document.getElementById('landingStep2Mobtua').classList.add('active');
            }
        }

        function backToStep1() {
            document.getElementById('landingStep1').style.display = '';
            document.getElementById('landingStep2Admission').classList.remove('active');
            document.getElementById('landingStep2Mobtua').classList.remove('active');
        }

        function selectGrade(grade) {
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('mainContainer').classList.remove('hidden');
            // reset step for next time
            backToStep1();
            
            const gradeSelect = document.getElementById('gradeLevel');
            gradeSelect.value = grade;
            updateFormTitle();
        }

        function updateFormTitle() {
            const gradeLevel = document.getElementById('gradeLevel').value;
            const formTitle = document.getElementById('formTitle');
            const formCode = document.getElementById('formCode');
            
            if (gradeLevel === 'm1') {
                formTitle.textContent = 'ใบสมัครเข้าเรียนชั้นมัธยมศึกษาปีที่ 1';
                formCode.textContent = 'วก.กทว.202';
            } else if (gradeLevel === 'm4') {
                formTitle.textContent = 'ใบสมัครเข้าเรียนชั้นมัธยมศึกษาปีที่ 4';
                formCode.textContent = 'วก.กทว.203';
            }
        }

        function getFormData() {
            const form = document.getElementById('admissionForm');
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                if (key === 'talent') {
                    if (!data[key]) data[key] = [];
                    data[key].push(value);
                } else {
                    data[key] = value;
                }
            }
            
            // รวมชื่อ-สกุลนักเรียน
            if (data.firstName && data.lastName) {
                data.fullName = data.firstName + ' ' + data.lastName;
            }

            // รวมชื่อ-สกุลบิดา
            if (data.fatherFirstName || data.fatherLastName) {
                data.fatherName = `${data.fatherPrefix || ''} ${data.fatherFirstName || ''} ${data.fatherLastName || ''}`.trim();
            }

            // รวมชื่อ-สกุลมารดา
            if (data.motherFirstName || data.motherLastName) {
                data.motherName = `${data.motherPrefix || ''} ${data.motherFirstName || ''} ${data.motherLastName || ''}`.trim();
            }
            
            // รวมวันเกิด
            if (data.birthDay && data.birthMonth && data.birthYear) {
                const buddhist = parseInt(data.birthYear);
                const christian = buddhist - 543;
                data.birthDate = `${christian}-${String(data.birthMonth).padStart(2, '0')}-${String(data.birthDay).padStart(2, '0')}`;
            }
            
            // ลบ "-" ออกจากบัตรประชาชนเพื่อเก็บเฉพาะตัวเลข
            if (data.nationalId) {
                data.nationalIdClean = data.nationalId.replace(/[^0-9]/g, '');
            }
            
            return data;
        }

        function validateForm() {
            const form = document.getElementById('admissionForm');
            return form.checkValidity();
        }

        function formatThaiDate(dateString) {
            if (!dateString) return '....................';
            const date = new Date(dateString);
            const thaiMonths = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 
                               'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
            const day = date.getDate();
            const month = thaiMonths[date.getMonth()];
            const year = date.getFullYear() + 543;
            return `${day} ${month} ${year}`;
        }

        function formatIdBoxes(id) {
            // ใช้ nationalIdClean ถ้ามี ไม่งั้นใช้ nationalId
            const cleanId = id || '';
            
            if (!cleanId || cleanId.length !== 13) {
                const boxes = [];
                for (let i = 0; i < 13; i++) {
                    if (i === 1 || i === 5 || i === 10 || i === 12) {
                        boxes.push('<span class="id-dash"></span>');
                    }
                    boxes.push('<span class="id-box"></span>');
                }
                return boxes.join('');
            }
            
            const digits = cleanId.split('');
            const boxes = [];
            digits.forEach((digit, i) => {
                if (i === 1 || i === 5 || i === 10 || i === 12) {
                    boxes.push('<span class="id-dash"></span>');
                }
                boxes.push(`<span class="id-box">${digit}</span>`);
            });
            return boxes.join('');
        }

        function checkbox(isChecked) {
            return `<span class="doc-checkbox${isChecked ? ' checked' : ''}"></span>`;
        }

        function generateDocumentHTML(data) {
            const logoUrl = 'https://nonthaphathr.github.io/uploadimg/logoschool.png';
            const talents = data.talent || [];
            
            // กำหนดชื่อชั้นและรหัสฟอร์ม
            let gradeText = 'มัธยมศึกษาปีที่ 1';
            let formCode = 'วก.กทว.202';
            
            if (data.gradeLevel === 'm4') {
                gradeText = 'มัธยมศึกษาปีที่ 4';
                formCode = 'วก.กทว.203';
            }
            
            return `
                <div class="print-document">
                    <div class="doc-code">${formCode}</div>
                    
                    <div class="doc-header">
                        <div class="doc-logo-section">
                            <img src="${logoUrl}" class="doc-logo" alt="โลโก้โรงเรียน">
                        </div>
                        <div class="doc-school-info">
                            วันที่ ${formatThaiDate(data.applicationDate)}
                        </div>
                    </div>

                    <div class="doc-title-section">
                        <div class="doc-title">ใบสมัครเข้าเรียนชั้น${gradeText} ปีการศึกษา ${data.academicYear || '.........................'}</div>
                        <div style="text-align: center; font-size: 14px; margin: 4px 0;">
                            โรงเรียนกระดุมทองวิทยา อำเภอกันทรารมย์ จังหวัดศรีสะเกษ<br>
                            สังกัดองค์การบริหารส่วนจังหวัดศรีสะเกษ
                        </div>
                    </div>

                    <div class="doc-content">
                        <div class="field-line" style="margin-top: 8px;">
                            <span class="field-label">1. ชื่อ-สกุล ผู้สมัคร</span>
                            <span class="field-value">${data.prefix || ''}${data.fullName || '..........................................'}</span>
                            <span class="field-label">ชื่อเล่น</span>
                            <span class="field-value">${data.nickname || '..............'}</span>
                            <span class="field-label">เกิดวันที่</span>
                            <span class="field-value">${formatThaiDate(data.birthDate)}</span>
                        </div>

                        <div class="field-line">
                            <span class="field-label">อายุ</span>
                            <span class="field-value">${data.age || '............'}</span>
                            <span class="field-label">ปี</span>
                        </div>
                        <div class="field-line">
                            <span class="field-label">ส่วนสูง</span>
                            <span class="field-value">${data.height || '..................'}</span>
                            <span class="field-label">เซนติเมตร</span>
                            <span class="field-label">น้ำหนัก</span>
                            <span class="field-value">${data.weight || '....................'}</span>
                            <span class="field-label">กิโลกรัม</span>
                            <span class="field-label">หมู่เลือด</span>
                            <span class="field-value">${data.bloodType || '.................................'}</span>
                        </div>

                        <div class="field-line">
                            <span class="field-label">เลขประจำตัวประชาชน</span>
                            <div class="id-boxes" style="display: inline-flex; gap: 2px; align-items: center;">
                                ${formatIdBoxes(data.nationalIdClean || data.nationalId)}
                            </div>
                        </div>

                        <div class="field-line">
                            <span class="field-label">ชื่อ-สกุลบิดา</span>
                            <span class="field-value">${data.fatherName || '.....................................................................'}</span>
                            <span class="field-label">อายุ</span>
                            <span class="field-value">${data.fatherAge || '........................'}</span>
                            <span class="field-label">อาชีพ</span>
                            <span class="field-value">${data.fatherOccupation || '.....................................'}</span>
                        </div>

                        <div class="field-line">
                            <span class="field-label">ชื่อ-สกุลมารดา</span>
                            <span class="field-value">${data.motherName || '.....................................................................'}</span>
                            <span class="field-label">อายุ</span>
                            <span class="field-value">${data.motherAge || '........................'}</span>
                            <span class="field-label">อาชีพ</span>
                            <span class="field-value">${data.motherOccupation || '.....................................'}</span>
                        </div>

                        <div class="field-line" style="margin-top: 6px;">
                            <span class="field-label">2. ที่อยู่ปัจจุบัน บ้านเลขที่</span>
                            <span class="field-value">${data.houseNumber || '……………'}</span>
                            <span class="field-label">หมู่ที่</span>
                            <span class="field-value">${data.moo || '………'}</span>
                            <span class="field-label">ถนน</span>
                            <span class="field-value">${data.road || '…........……………………'}</span>
                            <span class="field-label">ซอย</span>
                            <span class="field-value">${data.soi || '......................'}</span>
                        </div>

                        <div class="field-line">
                            <span class="field-label">บ้าน</span>
                            <span class="field-value">${data.village || '..................................'}</span>
                            <span class="field-label">ตำบล</span>
                            <span class="field-value">${data.subdistrict || '…………………'}</span>
                            <span class="field-label">อำเภอ</span>
                            <span class="field-value">${data.district || '……………………..'}</span>
                            <span class="field-label">จังหวัด</span>
                            <span class="field-value">${data.province || '…………….....………….'}</span>
                        </div>

                        <div class="field-line">
                            <span class="field-label">รหัสไปรษณีย์</span>
                            <span class="field-value">${data.postalCode || '……............……………'}</span>
                            <span class="field-label">โทรศัพท์</span>
                            <span class="field-value">${data.phone || '.…..………...........................................…....'}</span>
                            <span class="field-label">E-mail</span>
                            <span class="field-value">${data.email || '………………….………………………………………'}</span>
                        </div>

                        <div class="field-line" style="margin-top: 6px;">
                            <span class="field-label">3. ปัจจุบันกำลังจบชั้นประถมศึกษาปีที่ 6 จากโรงเรียน</span>
                            <span class="field-value">${data.previousSchool || '……………………………………………………………………………..………..'}</span>
                        </div>

                        <div class="field-line">
                            <span class="field-label">ตำบล</span>
                            <span class="field-value">${data.schoolSubdistrict || '……………………….'}</span>
                            <span class="field-label">อำเภอ</span>
                            <span class="field-value">${data.schoolDistrict || '…...…………………………..'}</span>
                            <span class="field-label">จังหวัด</span>
                            <span class="field-value">${data.schoolProvince || '…………………………………….'}</span>
                        </div>

                        <p style="margin-top: 8px; font-weight: 600;">4. ความสามารถพิเศษ</p>
                        
                        <div class="checkbox-line">
                            ${checkbox(talents.includes('sports'))} เป็นนักกีฬา(ระบุประเภท) <strong>${talents.includes('sports') ? (data.sportsType || '') : '................................................................................'}</strong>
                        </div>
                        
                        <div class="checkbox-line">
                            ${checkbox(talents.includes('music'))} เป็นนักดนตรีหรือศิลปะ(ระบุประเภท) <strong>${talents.includes('music') ? (data.musicType || '') : '.............................................................'}</strong>
                        </div>
                        
                        <div class="checkbox-line">
                            ${checkbox(talents.includes('other'))} อื่นๆ(ระบุ) <strong>${talents.includes('other') ? (data.otherTalent || '') : '........................................................................................................'}</strong>
                        </div>
                    </div>

                    <div class="signature-section" style="text-align: right; margin-top: 12px;">
                        <p>ลงชื่อ..........................................................................ผู้สมัคร</p>
                        <p>(.......................................................................)</p>
                        <p>วันที่.................เดือน...............................พ.ศ................</p>
                    </div>

                    <div class="approval-section">
                        <p style="font-weight: 600; margin-bottom: 6px;">ตรวจหลักฐานการสมัคร (สำหรับเจ้าหน้าที่)</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                            <div class="checkbox-line" style="margin: 2px 0;">
                                ${checkbox(false)} ใบสมัครพร้อมรูปถ่าย 2 แผ่น
                            </div>
                            <div class="checkbox-line" style="margin: 2px 0;">
                                ${checkbox(false)} ระเบียนแสดงผลการเรียน(ปพ.1)หรือใบรับรอง
                            </div>
                            <div class="checkbox-line" style="margin: 2px 0;">
                                ${checkbox(false)} สำเนาทะเบียนบ้านของนร/บิดา/มารดา
                            </div>
                            <div class="checkbox-line" style="margin: 2px 0;">
                                ${checkbox(false)} สำเนาบัตรประชาชนของนร/บิดา/มารดา
                            </div>
                            <div class="checkbox-line" style="margin: 2px 0;">
                                ${checkbox(false)} สำเนาสูติบัตรของนักเรียน
                            </div>
                            <div class="checkbox-line" style="margin: 2px 0;">
                                ${checkbox(false)} หลักฐานอื่นๆ……………….
                            </div>
                        </div>

                        <div style="text-align: right; margin-top: 12px;">
                            <p>ลงชื่อ.............................................................กรรมการรับสมัคร</p>
                            <p>(.......................................................)</p>
                            <p>วันที่.................เดือน..............................พ.ศ...............</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function previewDocument() {
            try {
                if (!validateForm()) {
                    showToast('กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน', 'error');
                    document.getElementById('admissionForm').reportValidity();
                    return;
                }
                const data = getFormData();
                const html = generateDocumentHTML(data);
                const previewArea = document.getElementById('previewArea');
                const printArea   = document.getElementById('printArea');
                const modal       = document.getElementById('previewModal');
                if (!previewArea || !printArea || !modal) {
                    showToast('ไม่พบองค์ประกอบของหน้าต่างแสดงผล กรุณารีโหลดหน้า', 'error');
                    return;
                }
                previewArea.innerHTML = html;
                printArea.innerHTML   = html;
                modal.classList.add('active');
            } catch (err) {
                console.error('previewDocument error:', err);
                showToast('เกิดข้อผิดพลาดในการแสดงตัวอย่าง: ' + err.message, 'error');
            }
        }

        async function saveDocument() {
            try {
                if (!validateForm()) {
                    showToast('กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน', 'error');
                    document.getElementById('admissionForm').reportValidity();
                    return;
                }
                const data = getFormData();
                await saveToFirestore(data);
                const html = generateDocumentHTML(data);
                const previewArea = document.getElementById('previewArea');
                const printArea   = document.getElementById('printArea');
                const modal       = document.getElementById('previewModal');
                if (previewArea) previewArea.innerHTML = html;
                if (printArea)   printArea.innerHTML   = html;
                if (modal)       modal.classList.add('active');
            } catch (err) {
                console.error('saveDocument error:', err);
                showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
            }
        }

        async function saveToFirestore(data) {
            try {
                showLoading(true);

                const gradeText = data.gradeLevel === 'm4' ? 'ม.4' : 'ม.1';
                const formCode = data.gradeLevel === 'm4' ? 'วก.กทว.203' : 'วก.กทว.202';

                const record = {
                    formType: `ใบสมัครเข้าเรียน ${gradeText}`,
                    formCode: formCode,
                    gradeLevel: data.gradeLevel,
                    studentName: `${data.prefix || ''}${data.fullName || ''}`,
                    academicYear: data.academicYear,
                    data: data,
                    createdAt: window.firestore.serverTimestamp(),
                    updatedAt: window.firestore.serverTimestamp()
                };

                const docRef = await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'admissions'),
                    record
                );

                console.log('Document written with ID:', docRef.id);
                showToast('บันทึกข้อมูลสำเร็จ');
                await loadHistory();
                // ล้างฟอร์มและ autosave หลังบันทึกสำเร็จ
                document.getElementById('admissionForm').reset();
                clearAutosave(AUTOSAVE_KEY_ADMISSION);
                setDefaultDate();

            } catch (error) {
                console.error('Error adding document:', error);
                showToast('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadHistory() {
            try {
                showLoading(true);

                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'admissions'),
                    window.firestore.orderBy('createdAt', 'desc'),
                    window.firestore.limit(50)
                );

                const querySnapshot = await window.firestore.getDocs(q);
                const history = [];

                querySnapshot.forEach((doc) => {
                    history.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                const historyList = document.getElementById('historyList');
                const historyCount = document.getElementById('historyCount');
                if (!historyList || !historyCount) return;
                
                historyCount.textContent = history.length;

                if (history.length === 0) {
                    historyList.innerHTML = `
                        <div class="empty-history">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p>ยังไม่มีประวัติการสมัคร</p>
                        </div>
                    `;
                    return;
                }

                const isLocked = localStorage.getItem('historyLocked') === 'true';

                historyList.innerHTML = history.map(record => {
                    let dateStr = '-';
                    if (record.createdAt) {
                        const date = record.createdAt.toDate();
                        dateStr = date.toLocaleDateString('th-TH', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }

                    const gradeLabel = record.gradeLevel === 'm4' ? 'ม.4' : 'ม.1';
                    const actionButtons = isLocked
                        ? `<span style="font-size:var(--text-xs); color:var(--text-light);">🔒 ล็อครายการ</span>`
                        : `<button class="btn btn-edit btn-sm" onclick="openEditRecord('${record.id}')">✏️ แก้ไข</button>
                           <button class="btn btn-danger btn-sm" onclick="deleteHistoryRecord('${record.id}')">🗑️ ลบ</button>`;

                    return `
                        <div class="history-item">
                            <div class="history-item-header">
                                <span class="history-item-type">${gradeLabel} - ${record.formCode}</span>
                                <span class="history-item-date">${dateStr}</span>
                            </div>
                            <div class="history-item-name">${record.studentName || '-'}</div>
                            <div class="history-item-detail">ปีการศึกษา ${record.academicYear || '-'}</div>
                            <div class="history-item-actions">
                                <button class="btn btn-primary btn-sm" onclick="viewHistoryRecord('${record.id}')">👁️ ดู</button>
                                ${actionButtons}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading history:', error);
                showToast('เกิดข้อผิดพลาดในการโหลดประวัติ: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function viewHistoryRecord(id) {
            try {
                showLoading(true);
                const docRef = window.firestore.doc(window.db, 'admissions', id);
                const docSnap = await window.firestore.getDoc(docRef);
                
                if (docSnap.exists()) {
                    const record = docSnap.data();
                    const html = generateDocumentHTML(record.data || {});
                    
                    const previewArea = document.getElementById('previewArea');
                    const printArea   = document.getElementById('printArea');
                    const modal       = document.getElementById('previewModal');
                    if (previewArea) previewArea.innerHTML = html;
                    if (printArea)   printArea.innerHTML   = html;
                    if (modal)       modal.classList.add('active');
                } else {
                    showToast('ไม่พบข้อมูล', 'error');
                }
            } catch (error) {
                console.error('Error viewing record:', error);
                showToast('เกิดข้อผิดพลาด: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteHistoryRecord(id) {
            // เช็คว่าล็อคอยู่ไหม
            if (localStorage.getItem('historyLocked') === 'true') {
                showToast('รายการถูกล็อค ไม่สามารถลบได้', 'error');
                return;
            }

            const password = prompt('กรุณาใส่รหัสผ่านเพื่อยืนยันการลบ:');
            if (password === null) return;
            if (password !== '1111') {
                showToast('รหัสผ่านไม่ถูกต้อง', 'error');
                return;
            }

            if (!confirm('ยืนยันการลบรายการนี้? ไม่สามารถกู้คืนได้')) return;

            try {
                showLoading(true);
                await window.firestore.deleteDoc(window.firestore.doc(window.db, 'admissions', id));
                showToast('ลบรายการสำเร็จ');
                await loadHistory();
            } catch (error) {
                console.error('Error deleting record:', error);
                showToast('เกิดข้อผิดพลาดในการลบ: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function closeModal() {
            document.getElementById('previewModal').classList.remove('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        async function openEditRecord(id) {
            if (localStorage.getItem('historyLocked') === 'true') {
                showToast('รายการถูกล็อค ไม่สามารถแก้ไขได้', 'error');
                return;
            }

            try {
                showLoading(true);
                const docRef = window.firestore.doc(window.db, 'admissions', id);
                const docSnap = await window.firestore.getDoc(docRef);

                if (!docSnap.exists()) {
                    showToast('ไม่พบข้อมูล', 'error');
                    return;
                }

                const record = docSnap.data();
                const d = record.data || {};

                // ใส่ข้อมูลลง modal
                document.getElementById('editRecordId').value = id;
                document.getElementById('editGradeLevel').value = record.gradeLevel || 'm1';
                document.getElementById('editPrefix').value = d.prefix || 'เด็กชาย';
                document.getElementById('editFirstName').value = d.firstName || '';
                document.getElementById('editLastName').value = d.lastName || '';
                document.getElementById('editPhone').value = d.phone || '';
                document.getElementById('editPreviousSchool').value = d.previousSchool || '';
                document.getElementById('editDistrict').value = d.district || '';
                document.getElementById('editProvince').value = d.province || '';

                document.getElementById('editModal').classList.add('active');

            } catch (error) {
                console.error('Error loading record:', error);
                showToast('เกิดข้อผิดพลาด: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function saveEditRecord() {
            const id = document.getElementById('editRecordId').value;
            const firstName = document.getElementById('editFirstName').value.trim();
            const lastName = document.getElementById('editLastName').value.trim();

            if (!firstName || !lastName) {
                showToast('กรุณากรอกชื่อและนามสกุล', 'error');
                return;
            }

            try {
                showLoading(true);

                const gradeLevel = document.getElementById('editGradeLevel').value;
                const prefix = document.getElementById('editPrefix').value;
                const fullName = firstName + ' ' + lastName;
                const gradeText = gradeLevel === 'm4' ? 'ม.4' : 'ม.1';
                const formCode = gradeLevel === 'm4' ? 'วก.กทว.203' : 'วก.กทว.202';

                // โหลดข้อมูลเดิมมาก่อน
                const docRef = window.firestore.doc(window.db, 'admissions', id);
                const docSnap = await window.firestore.getDoc(docRef);
                const oldData = docSnap.data();
                const oldInnerData = oldData.data || {};

                // merge ข้อมูลที่แก้ไข
                const updatedInnerData = {
                    ...oldInnerData,
                    prefix,
                    firstName,
                    lastName,
                    fullName,
                    phone: document.getElementById('editPhone').value,
                    previousSchool: document.getElementById('editPreviousSchool').value,
                    district: document.getElementById('editDistrict').value,
                    province: document.getElementById('editProvince').value,
                    gradeLevel
                };

                await window.firestore.updateDoc(docRef, {
                        gradeLevel,
                        formType: `ใบสมัครเข้าเรียน ${gradeText}`,
                        formCode,
                        studentName: `${prefix}${fullName}`,
                        data: updatedInnerData,
                        updatedAt: window.firestore.serverTimestamp()
                    });

                showToast('แก้ไขข้อมูลสำเร็จ');
                closeEditModal();
                await loadHistory();

            } catch (error) {
                console.error('Error updating record:', error);
                showToast('เกิดข้อผิดพลาด: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function toggleHistoryLock() {
            const locked = document.getElementById('historyLockToggle').checked;
            localStorage.setItem('historyLocked', locked);
            applyHistoryLockUI(locked);
        }

        function applyHistoryLockUI(locked) {
            const badge = document.getElementById('historyLockedBadge');
            if (locked) {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            loadHistory(); // รีโหลดเพื่ออัปเดตปุ่ม
        }

        function printDocument() {
            closeModal();
            setTimeout(() => {
                window.print();
            }, 100);
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('active');
            } else {
                loading.classList.remove('active');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = 'toast show' + (type === 'error' ? ' error' : '');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ระบบแอดมิน
        function openAdminSettings() {
            const password = prompt('กรุณาใส่รหัสผ่านแอดมิน:');
            if (password === '1111') {
                loadAdminSettings();
                document.getElementById('adminModal').classList.add('active');
            } else if (password !== null) {
                showToast('รหัสผ่านไม่ถูกต้อง', 'error');
            }
        }

        function closeAdminModal() {
            document.getElementById('adminModal').classList.remove('active');
        }

        function loadAdminSettings() {
            const alertEnabled = localStorage.getItem('alertEnabled') === 'true';
            const alertMessage = localStorage.getItem('alertMessage') || '';
            document.getElementById('alertToggle').checked = alertEnabled;
            document.getElementById('alertMessage').value = alertMessage;

            const defaultYear = localStorage.getItem('defaultAcademicYear') || '';
            document.getElementById('defaultAcademicYear').value = defaultYear;

            const testModeEnabled = localStorage.getItem('testModeEnabled') === 'true';
            document.getElementById('testModeToggle').checked = testModeEnabled;
            toggleTestModeButton(testModeEnabled);

            const historyLocked = localStorage.getItem('historyLocked') === 'true';
            document.getElementById('historyLockToggle').checked = historyLocked;
        }

        function saveDefaultYear() {
            const year = document.getElementById('defaultAcademicYear').value;
            localStorage.setItem('defaultAcademicYear', year);
            document.getElementById('academicYear').value = year;
            showToast('บันทึกปีการศึกษาสำเร็จ');
        }

        function toggleTestMode() {
            const enabled = document.getElementById('testModeToggle').checked;
            localStorage.setItem('testModeEnabled', enabled);
            toggleTestModeButton(enabled);
        }

        function toggleTestModeButton(show) {
            const btn = document.getElementById('testDataBtn');
            if (show) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
            // sync ปุ่มใบมอบตัวด้วย
            const mobBtn = document.getElementById('mobtuaTestDataBtn');
            if (mobBtn) {
                if (show) mobBtn.classList.remove('hidden');
                else mobBtn.classList.add('hidden');
            }
        }

        function fillMobtuaTestData() {
            const f = (name, val) => {
                const el = document.querySelector(`[name="${name}"]`);
                if (el) el.value = val;
            };
            const r = (name, val) => {
                const el = document.querySelector(`[name="${name}"][value="${val}"]`);
                if (el) el.checked = true;
            };
            const cb = (name, val) => {
                const el = document.querySelector(`[name="${name}"][value="${val}"]`);
                if (el) el.checked = true;
            };

            // ข้อมูลการเข้าเรียน
            f('mt_studentId', '12345');
            f('mt_classRoom', 'ม.1/2');
            f('mt_academicYear', localStorage.getItem('defaultAcademicYear') || (new Date().getFullYear() + 543).toString());

            // ผู้ปกครอง
            f('mt_guardianPrefix', 'นาย');
            f('mt_guardianFirstName', 'ชอบ');
            f('mt_guardianLastName', 'รักดี');
            f('mt_guardianNationalId', '3-3305-0999-19-9');
            f('mt_guardianOccupation', 'เกษตรกรรม');
            f('mt_guardianWorkplace', 'บ้านหนองดุม');
            f('mt_guardianHouseNo', '2');
            f('mt_guardianMoo', '2');
            f('mt_guardianSubdistrict', 'หนองหัวช้าง');
            f('mt_guardianDistrict', 'กันทรารมย์');
            f('mt_guardianProvince', 'ศรีสะเกษ');
            f('mt_guardianPostal', '33130');
            f('mt_guardianHomePhone', '-');
            f('mt_guardianMobile', '069-789-8989');
            f('mt_guardianRelation', 'บิดา');
            f('mt_guardianIncome', '9000');

            // นักเรียน
            f('mt_studentPrefix', 'เด็กชาย');
            f('mt_studentFirstName', 'เก่ง');
            f('mt_studentLastName', 'รักดี');
            f('mt_studentNickname', 'เก่ง');
            f('mt_birthDay', '2');
            f('mt_birthMonth', 'มีนาคม');
            f('mt_birthYear', '2546');
            f('mt_nationality', 'ไทย');
            f('mt_ethnicity', 'ไทย');
            f('mt_religion', 'พุทธ');
            f('mt_height', '160');
            f('mt_weight', '45');
            f('mt_disease', '-');
            f('mt_studentNationalId', '1-3302-02214-14-5');

            // ที่อยู่ตามทะเบียนบ้าน
            f('mt_houseCode', '3303-021432-7');
            f('mt_houseNo', '14');
            f('mt_moo', '2');
            f('mt_subdistrict', 'หนองหัวช้าง');
            f('mt_district', 'กันทรารมย์');
            f('mt_province', 'ศรีสะเกษ');
            f('mt_postal', '33130');
            f('mt_mobile', '069-789-8989');

            // ที่อยู่ปัจจุบัน (เหมือนทะเบียนบ้าน)
            f('mt_curHouseCode', '3303-021432-7');
            f('mt_curHouseNo', '14');
            f('mt_curMoo', '2');
            f('mt_curSubdistrict', 'หนองหัวช้าง');
            f('mt_curDistrict', 'กันทรารมย์');
            f('mt_curProvince', 'ศรีสะเกษ');
            f('mt_curPostal', '33130');
            f('mt_curMobile', '069-789-8989');

            // ข้อมูลเพิ่มเติม
            r('mt_sleeping', 'อาศัยอยู่กับบิดามารดา');
            r('mt_disadvantaged', 'ไม่ด้อยโอกาส');
            cb('mt_transport', 'รถรับส่ง');
            f('mt_travelTime', '10');
            f('mt_travelDistance', '5 กิโลเมตร');
            f('mt_siblings', '4');
            f('mt_birthOrder', '3');
            f('mt_siblingsStudying', '2');
            f('mt_olderBrothers', '2');
            f('mt_youngerBrothers', '1');
            f('mt_olderSisters', '0');
            f('mt_youngerSisters', '0');

            // บิดา
            f('mt_fatherPrefix', 'นาย');
            f('mt_fatherFirstName', 'ชอบ');
            f('mt_fatherLastName', 'รักดี');
            f('mt_fatherNationalId', '3-3305-0999-19-9');
            f('mt_fatherNationality', 'ไทย');
            f('mt_fatherEthnicity', 'ไทย');
            f('mt_fatherReligion', 'พุทธ');
            r('mt_fatherAlive', 'มีชีวิตอยู่');
            f('mt_fatherEducation', 'ม.6');
            f('mt_fatherOccupation', 'เกษตรกร');
            f('mt_fatherWorkplace', 'บ้านหนองดุม');
            f('mt_fatherSubdistrict', 'หนองหัวช้าง');
            f('mt_fatherDistrict', 'กันทรารมย์');
            f('mt_fatherProvince', 'ศรีสะเกษ');
            f('mt_fatherIncome', '9000');
            f('mt_fatherMobile', '069-789-8989');

            // มารดา
            f('mt_motherPrefix', 'นาง');
            f('mt_motherFirstName', 'เพียร');
            f('mt_motherLastName', 'รักดี');
            f('mt_motherNationalId', '3-3304-0549-19-7');
            f('mt_motherNationality', 'ไทย');
            f('mt_motherEthnicity', 'ไทย');
            f('mt_motherReligion', 'พุทธ');
            r('mt_motherAlive', 'มีชีวิตอยู่');
            f('mt_motherEducation', 'ม.6');
            f('mt_motherOccupation', 'เกษตรกรรม');
            f('mt_motherWorkplace', 'บ้านหนองดุม');
            f('mt_motherSubdistrict', 'หนองหัวช้าง');
            f('mt_motherDistrict', 'กันทรารมย์');
            f('mt_motherProvince', 'ศรีสะเกษ');
            f('mt_motherIncome', '9000');
            f('mt_motherMobile', '088-234-5678');

            // สถานภาพบิดา-มารดา
            r('mt_parentStatus', 'อยู่ร่วมกัน');

            showToast('กรอกข้อมูลตัวอย่างใบมอบตัวสำเร็จ');
        }

        function fillTestData() {
            // เลือกระดับชั้น
            const gradeLevel = document.getElementById('gradeLevel');
            if (!gradeLevel.value) {
                gradeLevel.value = 'm1';
                updateFormTitle();
            }

            // ข้อมูลส่วนตัว
            document.querySelector('[name="prefix"]').value = 'เด็กชาย';
            document.querySelector('[name="firstName"]').value = 'สมชาย';
            document.querySelector('[name="lastName"]').value = 'ใจดี';
            document.querySelector('[name="nickname"]').value = 'ชาย';

            // วันเกิด
            document.getElementById('birthDay').value = '15';
            document.getElementById('birthMonth').value = '5';
            document.getElementById('birthYear').value = '2555';
            calculateAge();

            // ข้อมูลอื่นๆ
            document.querySelector('[name="bloodType"]').value = 'O';
            document.querySelector('[name="height"]').value = '145';
            document.querySelector('[name="weight"]').value = '35';
            document.getElementById('nationalIdInput').value = '1-2345-67890-12-3';

            // บิดา-มารดา
            // บิดา-มารดา
            document.querySelector('[name="fatherPrefix"]').value = 'นาย';
            document.querySelector('[name="fatherFirstName"]').value = 'สมศักดิ์';
            document.querySelector('[name="fatherLastName"]').value = 'ใจดี';
            document.querySelector('[name="fatherAge"]').value = '45';
            document.querySelector('[name="fatherOccupation"]').value = 'เกษตรกร';
            document.querySelector('[name="motherPrefix"]').value = 'นาง';
            document.querySelector('[name="motherFirstName"]').value = 'สมหญิง';
            document.querySelector('[name="motherLastName"]').value = 'ใจดี';
            document.querySelector('[name="motherAge"]').value = '42';
            document.querySelector('[name="motherOccupation"]').value = 'ค้าขาย';

            // ที่อยู่
            document.querySelector('[name="houseNumber"]').value = '123';
            document.querySelector('[name="moo"]').value = '5';
            document.querySelector('[name="road"]').value = 'มิตรภาพ';
            document.querySelector('[name="soi"]').value = '';
            document.querySelector('[name="village"]').value = 'บ้านโนนสวรรค์';
            document.querySelector('[name="subdistrict"]').value = 'กระดุมทอง';
            document.querySelector('[name="district"]').value = 'กันทรารมย์';
            document.querySelector('[name="province"]').value = 'ศรีสะเกษ';
            document.querySelector('[name="postalCode"]').value = '33130';
            document.querySelector('[name="phone"]').value = '081-234-5678';
            document.querySelector('[name="email"]').value = 'test@email.com';

            // โรงเรียนเดิม
            document.querySelector('[name="previousSchool"]').value = 'โรงเรียนบ้านโนนสวรรค์';
            document.querySelector('[name="schoolSubdistrict"]').value = 'กระดุมทอง';
            document.querySelector('[name="schoolDistrict"]').value = 'กันทรารมย์';
            document.querySelector('[name="schoolProvince"]').value = 'ศรีสะเกษ';

            showToast('กรอกข้อมูลทดสอบสำเร็จ');
        }

        function toggleAlert() {
            const enabled = document.getElementById('alertToggle').checked;
            localStorage.setItem('alertEnabled', enabled);
        }

        function saveAlertSettings() {
            const enabled = document.getElementById('alertToggle').checked;
            const message = document.getElementById('alertMessage').value;
            
            localStorage.setItem('alertEnabled', enabled);
            localStorage.setItem('alertMessage', message);
            
            showToast('บันทึกการตั้งค่าสำเร็จ');
        }

        async function exportToExcel() {
            try {
                showLoading(true);
                
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'admissions'),
                    window.firestore.orderBy('createdAt', 'desc')
                );
                
                const querySnapshot = await window.firestore.getDocs(q);
                const records = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    records.push({
                        'วันที่สมัคร': data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString('th-TH') : '-',
                        'ระดับชั้น': data.gradeLevel === 'm4' ? 'ม.4' : 'ม.1',
                        'ปีการศึกษา': data.academicYear || '-',
                        'ชื่อ-สกุล': data.studentName || '-',
                        'เลขบัตรประชาชน': data.data?.nationalIdClean || data.data?.nationalId || '-',
                        'วันเกิด': data.data?.birthDate || '-',
                        'อายุ': data.data?.age || '-',
                        'บิดา': data.data?.fatherName || '-',
                        'มารดา': data.data?.motherName || '-',
                        'ที่อยู่': `${data.data?.houseNumber || ''} หมู่ ${data.data?.moo || ''} ต.${data.data?.subdistrict || ''} อ.${data.data?.district || ''} จ.${data.data?.province || ''}`,
                        'โทรศัพท์': data.data?.phone || '-',
                        'อีเมล': data.data?.email || '-',
                        'โรงเรียนเดิม': data.data?.previousSchool || '-'
                    });
                });
                
                if (records.length === 0) {
                    showToast('ไม่มีข้อมูลให้ส่งออก', 'error');
                    return;
                }
                
                // สร้าง CSV
                const headers = Object.keys(records[0]);
                const csvContent = [
                    '\ufeff' + headers.join(','),
                    ...records.map(row => headers.map(header => {
                        const value = row[header] || '';
                        return `"${value.toString().replace(/"/g, '""')}"`;
                    }).join(','))
                ].join('\n');
                
                // ดาวน์โหลด
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const today = new Date().toLocaleDateString('th-TH').replace(/\//g, '-');
                
                link.setAttribute('href', url);
                link.setAttribute('download', `รายชื่อผู้สมัคร_${today}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('ส่งออกข้อมูลสำเร็จ');
                
            } catch (error) {
                console.error('Error exporting data:', error);
                showToast('เกิดข้อผิดพลาดในการส่งออกข้อมูล: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function showAlertIfEnabled() {
            const enabled = localStorage.getItem('alertEnabled') === 'true';
            const message = localStorage.getItem('alertMessage') || '';
            
            if (enabled && message.trim()) {
                document.getElementById('alertContent').textContent = message;
                document.getElementById('alertAnnouncementModal').classList.add('active');
            }
        }

        function closeAlertModal() {
            document.getElementById('alertAnnouncementModal').classList.remove('active');
        }

        // ========== ระบบใบมอบตัวนักเรียน วก.กทว.205 ==========
        function openMobTuaForm(grade) {
            document.getElementById('mobtuaModal').classList.add('active');
            // reset landing step for next time
            backToStep1();

            const defaultYear = localStorage.getItem('defaultAcademicYear');
            const yearVal = defaultYear || (new Date().getFullYear() + 543).toString();
            document.getElementById('mt_academicYear').value = yearVal;

            // ตั้งค่าระดับชั้นเริ่มต้นใน classRoom field
            if (grade) {
                const classRoomEl = document.querySelector('[name="mt_classRoom"]');
                if (classRoomEl && !classRoomEl.value) {
                    classRoomEl.value = grade === 'm1' ? 'ม.1/' : 'ม.4/';
                    classRoomEl.focus();
                    // วาง cursor ไว้ท้ายสุด
                    const len = classRoomEl.value.length;
                    classRoomEl.setSelectionRange(len, len);
                }
                // เก็บ grade ไว้ใน data attribute ของ form เพื่อใช้ใน document
                document.getElementById('mobtuaForm').dataset.grade = grade;
            }

            // โหลดประวัติและ sync lock badge
            loadMobtuaHistory();
            const isLocked = localStorage.getItem('historyLocked') === 'true';
            const badge = document.getElementById('mobtuaLockedBadge');
            if (badge) {
                isLocked ? badge.classList.remove('hidden') : badge.classList.add('hidden');
            }
            // ตั้ง Autosave + โหลดข้อมูลที่บันทึกไว้
            setupAutosave('mobtuaForm', AUTOSAVE_KEY_MOBTUA);
            promptRestoreAutosave('mobtuaForm', AUTOSAVE_KEY_MOBTUA);
        }

        function closeMobtuaModal() {
            document.getElementById('mobtuaModal').classList.remove('active');
            backToStep1();
        }

        function closeMobtuaPreviewModal() {
            document.getElementById('mobtuaPreviewModal').classList.remove('active');
        }

        function copyAddressToCurrentMT() {
            const same = document.getElementById('mt_sameAddress').checked;
            if (!same) return;
            const map = {
                mt_curHouseCode: document.querySelector('[name="mt_houseCode"]')?.value,
                mt_curHouseNo: document.querySelector('[name="mt_houseNo"]')?.value,
                mt_curMoo: document.querySelector('[name="mt_moo"]')?.value,
                mt_curSubdistrict: document.querySelector('[name="mt_subdistrict"]')?.value,
                mt_curDistrict: document.querySelector('[name="mt_district"]')?.value,
                mt_curProvince: document.querySelector('[name="mt_province"]')?.value,
                mt_curPostal: document.querySelector('[name="mt_postal"]')?.value,
                mt_curMobile: document.querySelector('[name="mt_mobile"]')?.value,
            };
            Object.entries(map).forEach(([name, val]) => {
                const el = document.querySelector(`[name="${name}"]`);
                if (el && val !== undefined) el.value = val;
            });
        }

        // Setup ID format for มอบตัว fields
        function setupMobtuaEvents() {
            ['mt_guardianNationalIdInput', 'mt_studentNationalIdInput', 'mt_fatherNationalIdInput', 'mt_motherNationalIdInput'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', formatNationalId);
            });

            // Guardian relation other
            document.querySelector('[name="mt_guardianRelation"]')?.addEventListener('change', function() {
                const grp = document.getElementById('mt_guardianRelationOtherGroup');
                if (grp) grp.style.display = this.value === 'อื่นๆ' ? 'block' : 'none';
            });
        }

        function getMobtuaFormData() {
            const form = document.getElementById('mobtuaForm');
            const fd = new FormData(form);
            const d = {};
            for (let [k, v] of fd.entries()) {
                if (k === 'mt_transport') {
                    if (!d[k]) d[k] = [];
                    d[k].push(v);
                } else {
                    d[k] = v;
                }
            }
            // ประกอบชื่อเต็มจากฟิลด์แยก
            d.mt_guardianName = `${d.mt_guardianPrefix || ''} ${d.mt_guardianFirstName || ''} ${d.mt_guardianLastName || ''}`.trim();
            d.mt_studentFullName = `${d.mt_studentPrefix || ''}${d.mt_studentFirstName || ''} ${d.mt_studentLastName || ''}`.trim();
            d.mt_fatherFullName = `${d.mt_fatherPrefix || ''} ${d.mt_fatherFirstName || ''} ${d.mt_fatherLastName || ''}`.trim();
            d.mt_motherFullName = `${d.mt_motherPrefix || ''} ${d.mt_motherFirstName || ''} ${d.mt_motherLastName || ''}`.trim();
            d.mt_altGuardianName = `${d.mt_altGuardianPrefix || ''} ${d.mt_altGuardianFirstName || ''} ${d.mt_altGuardianLastName || ''}`.trim();
            return d;
        }

        function mtCb(checked) {
            return `<span class="mt-box">${checked ? '✓' : ''}</span>`;
        }

        function mtIdBoxes(id) {
            const raw = (id || '').replace(/[^0-9]/g, '');
            if (raw.length !== 13) {
                let boxes = '';
                for (let i = 0; i < 13; i++) {
                    if (i === 1 || i === 5 || i === 10 || i === 12) boxes += '<span class="mt-id-dash"></span>';
                    boxes += '<span class="mt-id-box"></span>';
                }
                return boxes;
            }
            let boxes = '';
            raw.split('').forEach((digit, i) => {
                if (i === 1 || i === 5 || i === 10 || i === 12) boxes += '<span class="mt-id-dash"></span>';
                boxes += `<span class="mt-id-box">${digit}</span>`;
            });
            return boxes;
        }

        function val(v, placeholder) {
            const str = (v || '').toString().trim();
            if (!str || str === '-') return `<span class="mt-line" style="min-width:${placeholder ? placeholder : '80px'}">&nbsp;</span>`;
            return `<span class="mt-line">${str}</span>`;
        }

        function generateMobtuaDocumentHTML(d) {
            const logoUrl = 'https://nonthaphathr.github.io/uploadimg/logoschool.png';
            const guardianRelation = d.mt_guardianRelation === 'อื่นๆ' ? (d.mt_guardianRelationOther || 'อื่นๆ') : (d.mt_guardianRelation || '');
            const transports = Array.isArray(d.mt_transport) ? d.mt_transport : (d.mt_transport ? [d.mt_transport] : []);
            const studentIdClean = (d.mt_studentNationalId || '').replace(/[^0-9]/g, '');

            function parentStatusCb(status) {
                const opts = ['อยู่ร่วมกัน', 'แยกกันอยู่', 'อย่าร้าง', 'บิดาเสียชีวิต', 'มารดาเสียชีวิต'];
                return opts.map(o => `${mtCb(d.mt_parentStatus === o)} ${o}`).join(' &nbsp; ');
            }

            return `
<div class="mobtua-doc">

  <!-- หน้า 1 -->
  <div class="mobtua-page-1">
    <div class="mt-code">วก.กทว.205</div>
    <div class="mt-doc-header-row">
        <img src="${logoUrl}" class="mt-logo" alt="โลโก้">
        <div class="mt-title-center">
            <h2 style="font-size:17px; font-weight:700; margin:0;">ใบมอบตัวนักเรียน</h2>
            <p style="font-size:15px; font-weight:600; margin:2px 0 0;">โรงเรียนกระดุมทองวิทยา</p>
        </div>
        <div class="mt-topright">
            <div>เลขประจำตัว ${val(d.mt_studentId)}</div>
            <div>เข้าเรียนชั้น ${val(d.mt_classRoom, '60px')}</div>
            <div>ปีการศึกษา ${val(d.mt_academicYear)}</div>
        </div>
    </div>

    <p class="mt-section-title">ข้อมูลนักเรียน <span style="font-weight:400; font-size:12px;">(กรอกข้อมูลด้วยลายมือบรรจง)</span></p>

    <p class="mt-para mt-nowrap">ข้าพเจ้า(ชื่อผู้ปกครอง) ${val(d.mt_guardianName, '150px')} เลขประจำตัวประชาชน ${val(d.mt_guardianNationalId, '130px')}</p>
    <p class="mt-para mt-nowrap">อาชีพ ${val(d.mt_guardianOccupation, '100px')} สถานที่ทำงาน ${val(d.mt_guardianWorkplace, '180px')}</p>
    <p class="mt-para mt-nowrap">ที่อยู่ปัจจุบัน บ้านเลขที่ ${val(d.mt_guardianHouseNo, '35px')} หมู่ ${val(d.mt_guardianMoo, '25px')} ตำบล ${val(d.mt_guardianSubdistrict, '80px')} อำเภอ ${val(d.mt_guardianDistrict, '80px')} จังหวัด ${val(d.mt_guardianProvince, '70px')}</p>
    <p class="mt-para mt-nowrap">รหัสไปรษณีย์ ${val(d.mt_guardianPostal, '45px')} โทรศัพท์บ้าน ${val(d.mt_guardianHomePhone, '90px')} โทรศัพท์มือถือ ${val(d.mt_guardianMobile, '90px')}</p>
    <p class="mt-para mt-nowrap">เกี่ยวข้องกับนักเรียนโดยเป็น
        ${mtCb(guardianRelation === 'บิดา')} บิดา &nbsp;
        ${mtCb(guardianRelation === 'มารดา')} มารดา &nbsp;
        อื่นๆ ระบุ ${val(guardianRelation !== 'บิดา' && guardianRelation !== 'มารดา' ? guardianRelation : '', '70px')} &nbsp;
        รายได้ต่อเดือน ${val(d.mt_guardianIncome, '55px')} บาท
    </p>

    <p class="mt-section-title" style="margin-top:6px;">ขอทำใบมอบตัวนักเรียนให้ไว้ต่อผู้อำนวยการโรงเรียนกระดุมทองวิทยา</p>
    <p class="mt-para mt-nowrap">ด้วย (ชื่อ–สกุลนักเรียน) ${val(d.mt_studentFullName, '200px')} ชื่อเล่น ${val(d.mt_studentNickname, '70px')}</p>
    <p class="mt-para mt-nowrap">เกิดวันที่ ${val(d.mt_birthDay, '22px')} เดือน ${val(d.mt_birthMonth, '70px')} พ.ศ. ${val(d.mt_birthYear, '42px')} สัญชาติ ${val(d.mt_nationality, '55px')} เชื้อชาติ ${val(d.mt_ethnicity, '55px')}</p>
    <p class="mt-para mt-nowrap">ศาสนา ${val(d.mt_religion, '48px')} ส่วนสูง ${val(d.mt_height, '35px')} ซ.ม. น้ำหนัก ${val(d.mt_weight, '35px')} ก.ก. โรคประจำตัว (ถ้ามี) ${val(d.mt_disease, '90px')}</p>
    <p class="mt-para">เลขที่บัตรประจำตัวประชาชนนักเรียน <span class="mt-id-boxes">${mtIdBoxes(d.mt_studentNationalId)}</span></p>

    <p class="mt-section-title">ที่อยู่นักเรียน(ตามทะเบียนบ้าน)</p>
    <p class="mt-para mt-nowrap">รหัสประจำบ้าน ${val(d.mt_houseCode, '100px')} บ้านเลขที่ ${val(d.mt_houseNo, '30px')} หมู่ ${val(d.mt_moo, '25px')} ตำบล ${val(d.mt_subdistrict, '80px')}</p>
    <p class="mt-para mt-nowrap">อำเภอ ${val(d.mt_district, '75px')} จังหวัด ${val(d.mt_province, '75px')} รหัสไปรษณีย์ ${val(d.mt_postal, '45px')} โทรศัพท์มือถือ ${val(d.mt_mobile, '85px')}</p>

    <p class="mt-section-title">ที่อยู่นักเรียน(ปัจจุบัน)</p>
    <p class="mt-para mt-nowrap">รหัสประจำบ้าน ${val(d.mt_curHouseCode, '100px')} บ้านเลขที่ ${val(d.mt_curHouseNo, '30px')} หมู่ ${val(d.mt_curMoo, '25px')} ตำบล ${val(d.mt_curSubdistrict, '80px')}</p>
    <p class="mt-para mt-nowrap">อำเภอ ${val(d.mt_curDistrict, '75px')} จังหวัด ${val(d.mt_curProvince, '75px')} รหัสไปรษณีย์ ${val(d.mt_curPostal, '45px')} โทรศัพท์มือถือ ${val(d.mt_curMobile, '85px')}</p>

    <p class="mt-para mt-nowrap">การพักนอนของนักเรียน
        ${mtCb(d.mt_sleeping === 'อาศัยอยู่กับญาติ')} อาศัยอยู่กับญาติ &nbsp;
        ${mtCb(d.mt_sleeping === 'อาศัยอยู่กับบิดามารดา')} อาศัยอยู่กับบิดามารดา &nbsp;
        ${mtCb(d.mt_sleeping === 'อื่นๆ')} อื่นๆ ระบุ ${val(d.mt_sleepingOther, '70px')}
    </p>
    <p class="mt-para mt-nowrap">ความด้อยโอกาส &nbsp;
        ${mtCb(d.mt_disadvantaged === 'ด้อยโอกาส')} ด้อยโอกาส &nbsp;&nbsp;
        ${mtCb(d.mt_disadvantaged === 'ไม่ด้อยโอกาส')} ไม่ด้อยโอกาส
    </p>
    <p class="mt-para mt-nowrap">การเดินทางมาโรงเรียน &nbsp;
        ${mtCb(transports.includes('เดินเท้า'))} เดินเท้า &nbsp;
        ${mtCb(transports.includes('จักรยาน'))} จักรยาน &nbsp;
        ${mtCb(transports.includes('รถรับส่ง'))} รถรับส่ง &nbsp;
        ${mtCb(transports.includes('รถจักรยานยนต์'))} รถจักรยานยนต์ &nbsp;
        ${mtCb(transports.includes('อื่นๆ'))} อื่นๆ ระบุ ${val(d.mt_transportOther, '60px')}
    </p>
    <p class="mt-para mt-nowrap">เวลาในการเดินทางมาโรงเรียน ${val(d.mt_travelTime, '35px')} นาที &nbsp; ระยะทางจากบ้านมาโรงเรียน ${val(d.mt_travelDistance, '90px')}</p>
    <p class="mt-para mt-nowrap">นักเรียนมีจำนวนพี่น้อง ${val(d.mt_siblings, '28px')} คน (รวมตัวนักเรียนด้วย) &nbsp; จำนวนพี่ชาย ${val(d.mt_olderBrothers, '22px')} คน &nbsp; จำนวนน้องชาย ${val(d.mt_youngerBrothers, '22px')} คน</p>
    <p class="mt-para mt-nowrap">จำนวนพี่สาว ${val(d.mt_olderSisters, '22px')} คน &nbsp; จำนวนน้องสาว ${val(d.mt_youngerSisters, '22px')} คน &nbsp; จำนวนพี่น้องที่กำลังศึกษาอยู่ ${val(d.mt_siblingsStudying, '30px')} คน</p>
    <p class="mt-para mt-nowrap">นักเรียนเป็นบุตรคนที่ ${val(d.mt_birthOrder, '28px')} ในจำนวนพี่น้อง ${val(d.mt_siblings, '28px')} คน (รวมตัวนักเรียนด้วย)</p>

    <p class="mt-section-title">ข้อมูลของบิดามารดา</p>
    <p class="mt-para mt-nowrap"><strong>บิดา</strong> ${val(d.mt_fatherFullName, '180px')} เลขประจำตัวประชาชน ${val(d.mt_fatherNationalId, '115px')}</p>
    <p class="mt-para mt-nowrap">สัญชาติ ${val(d.mt_fatherNationality, '42px')} เชื้อชาติ ${val(d.mt_fatherEthnicity, '42px')} ศาสนา ${val(d.mt_fatherReligion, '42px')} &nbsp;
        ( ${d.mt_fatherAlive === 'มีชีวิตอยู่' ? '✓' : '&nbsp;'} ) มีชีวิตอยู่ &nbsp; ( ${d.mt_fatherAlive === 'เสียชีวิต' ? '✓' : '&nbsp;'} ) เสียชีวิต &nbsp; การศึกษา ${val(d.mt_fatherEducation, '55px')}</p>
    <p class="mt-para mt-nowrap">อาชีพ ${val(d.mt_fatherOccupation, '75px')} สถานที่ทำงาน ${val(d.mt_fatherWorkplace, '85px')} ตำบล ${val(d.mt_fatherSubdistrict, '65px')} อำเภอ ${val(d.mt_fatherDistrict, '65px')}</p>
    <p class="mt-para mt-nowrap">จังหวัด ${val(d.mt_fatherProvince, '65px')} รายได้/เดือน ${val(d.mt_fatherIncome, '48px')} บาท &nbsp; โทรศัพท์มือถือ ${val(d.mt_fatherMobile, '85px')}</p>

    <p class="mt-para mt-nowrap" style="margin-top:5px;"><strong>มารดา</strong> ${val(d.mt_motherFullName, '180px')} เลขประจำตัวประชาชน ${val(d.mt_motherNationalId, '115px')}</p>
    <p class="mt-para mt-nowrap">สัญชาติ ${val(d.mt_motherNationality, '42px')} เชื้อชาติ ${val(d.mt_motherEthnicity, '42px')} ศาสนา ${val(d.mt_motherReligion, '42px')} &nbsp;
        ( ${d.mt_motherAlive === 'มีชีวิตอยู่' ? '✓' : '&nbsp;'} ) มีชีวิตอยู่ &nbsp; ( ${d.mt_motherAlive === 'เสียชีวิต' ? '✓' : '&nbsp;'} ) เสียชีวิต &nbsp; การศึกษา ${val(d.mt_motherEducation, '55px')}</p>
    <p class="mt-para mt-nowrap">อาชีพ ${val(d.mt_motherOccupation, '75px')} สถานที่ทำงาน ${val(d.mt_motherWorkplace, '85px')} ตำบล ${val(d.mt_motherSubdistrict, '65px')} อำเภอ ${val(d.mt_motherDistrict, '65px')}</p>
    <p class="mt-para mt-nowrap">จังหวัด ${val(d.mt_motherProvince, '65px')} รายได้/เดือน ${val(d.mt_motherIncome, '48px')} บาท &nbsp; โทรศัพท์มือถือ ${val(d.mt_motherMobile, '85px')}</p>
  </div>

  <!-- หน้า 2 -->
  <div class="mobtua-page-2">
    <div class="mt-code" style="margin-top:4px;">วก.กทว.205</div>

    <p class="mt-para mt-nowrap" style="margin-top:4px;">สถานภาพของบิดา มารดา &nbsp; ${parentStatusCb(d.mt_parentStatus)} &nbsp;
    อื่นๆ ระบุ ${val(d.mt_parentStatus === 'อื่นๆ' ? d.mt_parentStatusOther : '', '70px')}</p>

    <p class="mt-section-title">ข้อมูลผู้ปกครอง (กรณีที่นักเรียนไม่ได้อยู่กับบิดา/มารดา)</p>
    <p class="mt-para mt-nowrap">ชื่อ-สกุล ${val(d.mt_altGuardianName, '180px')} เกี่ยวข้องกับนักเรียนเป็น ${val(d.mt_altGuardianRelation, '80px')}</p>
    <p class="mt-para mt-nowrap">สัญชาติ ${val(d.mt_altGuardianNationality, '48px')} เชื้อชาติ ${val(d.mt_altGuardianEthnicity, '48px')} ศาสนา ${val(d.mt_altGuardianReligion, '48px')} อาชีพ ${val(d.mt_altGuardianOccupation, '75px')} รายได้/เดือน ${val(d.mt_altGuardianIncome, '48px')} บาท</p>
    <p class="mt-para mt-nowrap">อยู่บ้านเลขที่ ${val(d.mt_altGuardianHouseNo, '30px')} หมู่ที่ ${val(d.mt_altGuardianMoo, '22px')} ถนน ${val(d.mt_altGuardianRoad, '75px')} ตำบล ${val(d.mt_altGuardianSubdistrict, '75px')} อำเภอ ${val(d.mt_altGuardianDistrict, '75px')}</p>
    <p class="mt-para mt-nowrap">จังหวัด ${val(d.mt_altGuardianProvince, '65px')} สถานที่ทำงาน ${val(d.mt_altGuardianWorkplace, '95px')} โทรศัพท์มือถือ ${val(d.mt_altGuardianMobile, '90px')}</p>

    <p class="mt-para" style="margin-top:10px;">บัดนี้ <strong>${val(d.mt_studentFullName, '200px')}</strong> ได้เข้าเป็นนักเรียนโรงเรียนกระดุมทองวิทยาเรียบร้อยแล้ว</p>
    <p class="mt-para">ข้าพเจ้าขอสัญญาว่าจะเป็นผู้ปกครอง คอยกำกับ ดูแล และเอาใจใส่ <strong>${val(d.mt_studentFullName, '200px')}</strong> ตั้งใจศึกษา</p>
    <p class="mt-para">เอาใจใส่ต่อการเรียนให้ดีอย่างสม่ำเสมอและจะอบรม ตักเตือน สั่งสอนให้ประพฤติและปฏิบัติตนตามกฎระเบียบ วินัย และข้อบังคับของทางโรงเรียนอย่างดีทุกประการ</p>
    <p class="mt-para">ทั้งจะเป็นผู้อุปถัมภ์ค่าใช้จ่ายต่างๆ อุปกรณ์การเรียนให้เพียงพอตามระเบียบของโรงเรียนนี้ ข้าพเจ้ายินดีมอบนักเรียนในความปกครอง</p>
    <p class="mt-para">ของข้าพเจ้าให้ดำเนินการตามระเบียบข้อบังคับทุกประการ หากกระทำผิดกฎระเบียบวินัย ข้อบังคับของโรงเรียน ขอให้โรงเรียน</p>
    <p class="mt-para">ได้ดำเนินการลงโทษตามกฎระเบียบของโรงเรียน ตามควรแก่กรณี ข้าพเจ้าได้อ่านความทั้งหมดถูกต้อง ครบถ้วนสมบูรณ์แล้ว</p>
    <p class="mt-para">จึงลงลายมือชื่อไว้เป็นหลักฐาน</p>

    <div class="mt-sig-row">
        <div class="mt-sig-block">
            <p>ลงชื่อ......................................................................ผู้ปกครอง</p>
            <p>(${val(d.mt_guardianName, '150px')})</p>
            <p>วันที่..............เดือน.....................พ.ศ..............</p>
        </div>
        <div class="mt-sig-block">
            <p>ลงชื่อ......................................................................ผู้รับมอบตัว</p>
            <p>(...........................................................................)</p>
            <p>วันที่..............เดือน.....................พ.ศ..............</p>
        </div>
    </div>

    <div class="mt-divider" style="margin-top:14px;"></div>
    <p class="mt-section-title">เอกสารที่ต้องยื่นวันมอบตัว</p>
    <div class="mt-doclist">
        <div class="mt-doclist-item">${mtCb(false)} สำเนา ปพ.1 (ฉบับจบการศึกษา)</div>
        <div class="mt-doclist-item">${mtCb(false)} สำเนาทะเบียนบ้านของบิดา</div>
        <div class="mt-doclist-item">${mtCb(false)} สำเนาบัตรประชาชนของนักเรียน</div>
        <div class="mt-doclist-item">${mtCb(false)} สำเนาทะเบียนบ้านของมารดา</div>
        <div class="mt-doclist-item">${mtCb(false)} สำเนาบัตรประชาชนของบิดา</div>
        <div class="mt-doclist-item">${mtCb(false)} สำเนาสูติบัตรของนักเรียน</div>
        <div class="mt-doclist-item">${mtCb(false)} สำเนาบัตรประชาชนของมารดา</div>
        <div class="mt-doclist-item">${mtCb(false)} สำเนาทะเบียนบ้านของผู้ปกครอง (กรณีไม่อยู่กับบิดา/มารดา)</div>
        <div class="mt-doclist-item">${mtCb(false)} สำเนาบัตรประชาชนของผู้ปกครอง (กรณีไม่อยู่กับบิดา/มารดา)</div>
        <div class="mt-doclist-item">${mtCb(false)} สำเนาทะเบียนบ้านของนักเรียน</div>
    </div>
    <p style="font-size:12px; font-weight:700; margin-top:6px;">***เอกสารทุกฉบับ รับรองสำเนาถูกต้อง</p>
  </div>

</div>`;
        }

        function previewMobtuaDocument() {
            const form = document.getElementById('mobtuaForm');
            if (!form.checkValidity()) {
                showToast('กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน', 'error');
                form.reportValidity();
                return;
            }
            const d = getMobtuaFormData();
            const html = generateMobtuaDocumentHTML(d);
            document.getElementById('mobtuaPreviewArea').innerHTML = html;
            document.getElementById('mobtuaPrintArea').innerHTML = html;
            document.getElementById('mobtuaPreviewModal').classList.add('active');
        }

        async function saveMobtuaDocument() {
            const form = document.getElementById('mobtuaForm');
            if (!form.checkValidity()) {
                showToast('กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน', 'error');
                form.reportValidity();
                return;
            }
            const d = getMobtuaFormData();
            try {
                showLoading(true);
                const record = {
                    formType: 'ใบมอบตัวนักเรียน',
                    formCode: 'วก.กทว.205',
                    studentName: d.mt_studentFullName || '',
                    guardianName: d.mt_guardianName || '',
                    academicYear: d.mt_academicYear || '',
                    classRoom: d.mt_classRoom || '',
                    data: d,
                    createdAt: window.firestore.serverTimestamp(),
                    updatedAt: window.firestore.serverTimestamp()
                };
                await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'mobtua'),
                    record
                );
                showToast('บันทึกใบมอบตัวสำเร็จ');
                const html = generateMobtuaDocumentHTML(d);
                document.getElementById('mobtuaPreviewArea').innerHTML = html;
                document.getElementById('mobtuaPrintArea').innerHTML = html;
                document.getElementById('mobtuaPreviewModal').classList.add('active');
                await loadMobtuaHistory();
                // ล้างฟอร์มและ autosave หลังบันทึกสำเร็จ
                document.getElementById('mobtuaForm').reset();
                clearAutosave(AUTOSAVE_KEY_MOBTUA);
                // reset autosave setup flag ให้ event listener ทำงานต่อได้
                const mf = document.getElementById('mobtuaForm');
                if (mf) mf._autosaveSetup = false;
            } catch (error) {
                console.error('Error saving mobtua:', error);
                showToast('เกิดข้อผิดพลาด: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadMobtuaHistory() {
            try {
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'mobtua'),
                    window.firestore.orderBy('createdAt', 'desc'),
                    window.firestore.limit(50)
                );
                const snap = await window.firestore.getDocs(q);
                const records = [];
                snap.forEach(doc => records.push({ id: doc.id, ...doc.data() }));

                const list = document.getElementById('mobtuaHistoryList');
                const count = document.getElementById('mobtuaHistoryCount');
                if (!list) return;
                count.textContent = records.length;

                const isLocked = localStorage.getItem('historyLocked') === 'true';

                if (records.length === 0) {
                    list.innerHTML = `<div class="empty-history">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:48px;height:48px;opacity:0.4;margin-bottom:0.5rem;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p>ยังไม่มีประวัติใบมอบตัว</p></div>`;
                    return;
                }

                list.innerHTML = records.map(rec => {
                    let dateStr = '-';
                    if (rec.createdAt) {
                        dateStr = rec.createdAt.toDate().toLocaleDateString('th-TH', {
                            year: 'numeric', month: 'short', day: 'numeric',
                            hour: '2-digit', minute: '2-digit'
                        });
                    }
                    const actionBtns = isLocked
                        ? `<span style="font-size:var(--text-xs);color:var(--text-light);">🔒 ล็อครายการ</span>`
                        : `<button class="btn btn-edit btn-sm" onclick="openMobtuaEditRecord('${rec.id}')">✏️ แก้ไข</button>
                           <button class="btn btn-danger btn-sm" onclick="deleteMobtuaRecord('${rec.id}')">🗑️ ลบ</button>`;

                    return `<div class="history-item" style="border-left: 3px solid #9c4dcc;">
                        <div class="history-item-header">
                            <span class="history-item-type" style="background:#7b3f9e;">มอบตัว</span>
                            <span class="history-item-date">${dateStr}</span>
                        </div>
                        <div class="history-item-name">${rec.studentName || '-'}</div>
                        <div class="history-item-detail">ปีการศึกษา ${rec.academicYear || '-'} | ${rec.classRoom || '-'} | ผู้ปกครอง: ${rec.guardianName || '-'}</div>
                        <div class="history-item-actions">
                            <button class="btn btn-primary btn-sm" style="background:#7b3f9e;" onclick="viewMobtuaRecord('${rec.id}')">👁️ ดู</button>
                            ${actionBtns}
                        </div>
                    </div>`;
                }).join('');
            } catch(e) {
                console.error('loadMobtuaHistory error:', e);
            }
        }

        async function viewMobtuaRecord(id) {
            try {
                showLoading(true);
                const snap = await window.firestore.getDoc(window.firestore.doc(window.db, 'mobtua', id));
                if (!snap.exists()) { showToast('ไม่พบข้อมูล', 'error'); return; }
                const html = generateMobtuaDocumentHTML(snap.data().data);
                document.getElementById('mobtuaPreviewArea').innerHTML = html;
                document.getElementById('mobtuaPrintArea').innerHTML = html;
                document.getElementById('mobtuaPreviewModal').classList.add('active');
            } catch(e) {
                showToast('เกิดข้อผิดพลาด: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteMobtuaRecord(id) {
            if (localStorage.getItem('historyLocked') === 'true') {
                showToast('รายการถูกล็อค ไม่สามารถลบได้', 'error'); return;
            }
            const pw = prompt('กรุณาใส่รหัสผ่านเพื่อยืนยันการลบ:');
            if (pw === null) return;
            if (pw !== '1111') { showToast('รหัสผ่านไม่ถูกต้อง', 'error'); return; }
            if (!confirm('ยืนยันการลบรายการนี้?')) return;
            try {
                showLoading(true);
                await window.firestore.deleteDoc(window.firestore.doc(window.db, 'mobtua', id));
                showToast('ลบรายการสำเร็จ');
                await loadMobtuaHistory();
            } catch(e) {
                showToast('เกิดข้อผิดพลาด: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function openMobtuaEditRecord(id) {
            if (localStorage.getItem('historyLocked') === 'true') {
                showToast('รายการถูกล็อค ไม่สามารถแก้ไขได้', 'error'); return;
            }
            const pw = prompt('กรุณาใส่รหัสผ่านเพื่อแก้ไข:');
            if (pw === null) return;
            if (pw !== '1111') { showToast('รหัสผ่านไม่ถูกต้อง', 'error'); return; }

            try {
                showLoading(true);
                const snap = await window.firestore.getDoc(window.firestore.doc(window.db, 'mobtua', id));
                if (!snap.exists()) { showToast('ไม่พบข้อมูล', 'error'); return; }

                const rec = snap.data();
                const d = rec.data || {};

                document.getElementById('mobtuaEditId').value = id;
                document.getElementById('mobtuaEditClassRoom').value = rec.classRoom || d.mt_classRoom || '';
                document.getElementById('mobtuaEditAcademicYear').value = rec.academicYear || d.mt_academicYear || '';
                document.getElementById('mobtuaEditStudentPrefix').value = d.mt_studentPrefix || 'เด็กชาย';
                document.getElementById('mobtuaEditStudentFirstName').value = d.mt_studentFirstName || '';
                document.getElementById('mobtuaEditStudentLastName').value = d.mt_studentLastName || '';
                document.getElementById('mobtuaEditGuardianPrefix').value = d.mt_guardianPrefix || 'นาย';
                document.getElementById('mobtuaEditGuardianFirstName').value = d.mt_guardianFirstName || '';
                document.getElementById('mobtuaEditGuardianLastName').value = d.mt_guardianLastName || '';
                document.getElementById('mobtuaEditGuardianMobile').value = d.mt_guardianMobile || '';
                document.getElementById('mobtuaEditPreviousSchool').value = d.mt_previousSchool || '';

                document.getElementById('mobtuaEditModal').classList.add('active');
            } catch(e) {
                showToast('เกิดข้อผิดพลาด: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function closeMobtuaEditModal() {
            document.getElementById('mobtuaEditModal').classList.remove('active');
        }

        async function saveMobtuaEditRecord() {
            const id = document.getElementById('mobtuaEditId').value;
            const firstName = document.getElementById('mobtuaEditStudentFirstName').value.trim();
            const lastName = document.getElementById('mobtuaEditStudentLastName').value.trim();
            if (!firstName || !lastName) {
                showToast('กรุณากรอกชื่อและนามสกุลนักเรียน', 'error'); return;
            }

            try {
                showLoading(true);
                const snap = await window.firestore.getDoc(window.firestore.doc(window.db, 'mobtua', id));
                const oldData = snap.data();
                const oldInner = oldData.data || {};

                const studentPrefix = document.getElementById('mobtuaEditStudentPrefix').value;
                const guardianPrefix = document.getElementById('mobtuaEditGuardianPrefix').value;
                const guardianFirst = document.getElementById('mobtuaEditGuardianFirstName').value.trim();
                const guardianLast = document.getElementById('mobtuaEditGuardianLastName').value.trim();
                const classRoom = document.getElementById('mobtuaEditClassRoom').value.trim();
                const academicYear = document.getElementById('mobtuaEditAcademicYear').value.trim();

                const studentFullName = `${studentPrefix}${firstName} ${lastName}`;
                const guardianName = `${guardianPrefix} ${guardianFirst} ${guardianLast}`.trim();

                const updatedInner = {
                    ...oldInner,
                    mt_studentPrefix: studentPrefix,
                    mt_studentFirstName: firstName,
                    mt_studentLastName: lastName,
                    mt_studentFullName: studentFullName,
                    mt_guardianPrefix: guardianPrefix,
                    mt_guardianFirstName: guardianFirst,
                    mt_guardianLastName: guardianLast,
                    mt_guardianName: guardianName,
                    mt_guardianMobile: document.getElementById('mobtuaEditGuardianMobile').value,
                    mt_previousSchool: document.getElementById('mobtuaEditPreviousSchool').value,
                    mt_classRoom: classRoom,
                    mt_academicYear: academicYear,
                };

                await window.firestore.updateDoc(
                    window.firestore.doc(window.db, 'mobtua', id), {
                        studentName: studentFullName,
                        guardianName: guardianName,
                        classRoom: classRoom,
                        academicYear: academicYear,
                        data: updatedInner,
                        updatedAt: window.firestore.serverTimestamp()
                    }
                );

                showToast('แก้ไขข้อมูลสำเร็จ');
                closeMobtuaEditModal();
                await loadMobtuaHistory();
            } catch(e) {
                showToast('เกิดข้อผิดพลาด: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function exportMobtuaToExcel() {
            try {
                showLoading(true);
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'mobtua'),
                    window.firestore.orderBy('createdAt', 'desc')
                );
                const snap = await window.firestore.getDocs(q);
                const rows = [];
                snap.forEach(doc => {
                    const r = doc.data();
                    const d = r.data || {};
                    const transports = Array.isArray(d.mt_transport) ? d.mt_transport.join(', ') : (d.mt_transport || '-');
                    rows.push({
                        // ทั่วไป
                        'วันที่บันทึก':         r.createdAt ? new Date(r.createdAt.toDate()).toLocaleDateString('th-TH') : '-',
                        'ปีการศึกษา':           d.mt_academicYear || '-',
                        'ชั้น/ห้อง':            d.mt_classRoom || '-',
                        'เลขประจำตัวนักเรียน':  d.mt_studentId || '-',
                        // นักเรียน
                        'ชื่อ-สกุลนักเรียน':   r.studentName || '-',
                        'ชื่อเล่น':             d.mt_studentNickname || '-',
                        'เลขบัตรนักเรียน':      (d.mt_studentNationalId || '').replace(/-/g,''),
                        'วันเกิด(วัน)':         d.mt_birthDay || '-',
                        'วันเกิด(เดือน)':       d.mt_birthMonth || '-',
                        'วันเกิด(ปีพ.ศ.)':     d.mt_birthYear || '-',
                        'อายุ':                 d.mt_age || '-',
                        'น้ำหนัก(กก.)':         d.mt_weight || '-',
                        'ส่วนสูง(ซม.)':         d.mt_height || '-',
                        'สัญชาตินักเรียน':      d.mt_nationality || '-',
                        'เชื้อชาตินักเรียน':    d.mt_ethnicity || '-',
                        'ศาสนานักเรียน':        d.mt_religion || '-',
                        'โรคประจำตัว':          d.mt_disease || '-',
                        'ข้อด้อยโอกาส':         d.mt_disadvantaged || '-',
                        'โรงเรียนเดิม':         d.mt_previousSchool || '-',
                        'จำนวนพี่น้องทั้งหมด':  d.mt_siblings || '-',
                        'พี่ชาย':               d.mt_olderBrothers || '-',
                        'พี่สาว':               d.mt_olderSisters || '-',
                        'น้องชาย':              d.mt_youngerBrothers || '-',
                        'น้องสาว':              d.mt_youngerSisters || '-',
                        'พี่น้องกำลังศึกษา':    d.mt_siblingsStudying || '-',
                        'เป็นบุตรคนที่':        d.mt_birthOrder || '-',
                        'ที่พัก':               d.mt_sleeping === 'อื่นๆ' ? (d.mt_sleepingOther||'อื่นๆ') : (d.mt_sleeping||'-'),
                        'การเดินทาง':           transports + (d.mt_transportOther ? ` (${d.mt_transportOther})` : ''),
                        'ระยะทาง(กม.)':         d.mt_travelDistance || '-',
                        'เวลาเดินทาง(นาที)':    d.mt_travelTime || '-',
                        // ที่อยู่นักเรียน
                        'รหัสบ้านนักเรียน':     d.mt_houseCode || '-',
                        'บ้านเลขที่นักเรียน':   d.mt_houseNo || '-',
                        'หมู่นักเรียน':         d.mt_moo || '-',
                        'ตำบลนักเรียน':         d.mt_subdistrict || '-',
                        'อำเภอนักเรียน':        d.mt_district || '-',
                        'จังหวัดนักเรียน':      d.mt_province || '-',
                        'รหัสไปรษณีย์นักเรียน': d.mt_postal || '-',
                        'โทรนักเรียน':          d.mt_mobile || '-',
                        // ที่อยู่ปัจจุบัน
                        'รหัสบ้านปัจจุบัน':     d.mt_curHouseCode || '-',
                        'บ้านเลขที่ปัจจุบัน':   d.mt_curHouseNo || '-',
                        'หมู่ปัจจุบัน':         d.mt_curMoo || '-',
                        'ตำบลปัจจุบัน':         d.mt_curSubdistrict || '-',
                        'อำเภอปัจจุบัน':        d.mt_curDistrict || '-',
                        'จังหวัดปัจจุบัน':      d.mt_curProvince || '-',
                        'ไปรษณีย์ปัจจุบัน':     d.mt_curPostal || '-',
                        'โทรปัจจุบัน':          d.mt_curMobile || '-',
                        // ผู้ปกครอง
                        'ชื่อผู้ปกครอง':        r.guardianName || '-',
                        'เลขบัตรผู้ปกครอง':     (d.mt_guardianNationalId || '').replace(/-/g,''),
                        'ความสัมพันธ์ผู้ปกครอง': d.mt_guardianRelation === 'อื่นๆ' ? (d.mt_guardianRelationOther||'อื่นๆ') : (d.mt_guardianRelation||'-'),
                        'อาชีพผู้ปกครอง':       d.mt_guardianOccupation || '-',
                        'ที่ทำงานผู้ปกครอง':    d.mt_guardianWorkplace || '-',
                        'รายได้ผู้ปกครอง':      d.mt_guardianIncome || '-',
                        'โทรบ้านผู้ปกครอง':     d.mt_guardianHomePhone || '-',
                        'โทรมือถือผู้ปกครอง':   d.mt_guardianMobile || '-',
                        'บ้านเลขที่ผู้ปกครอง':  d.mt_guardianHouseNo || '-',
                        'หมู่ผู้ปกครอง':        d.mt_guardianMoo || '-',
                        'ตำบลผู้ปกครอง':        d.mt_guardianSubdistrict || '-',
                        'อำเภอผู้ปกครอง':       d.mt_guardianDistrict || '-',
                        'จังหวัดผู้ปกครอง':     d.mt_guardianProvince || '-',
                        'ไปรษณีย์ผู้ปกครอง':    d.mt_guardianPostal || '-',
                        // บิดา
                        'ชื่อ-สกุลบิดา':        d.mt_fatherFullName || '-',
                        'เลขบัตรบิดา':          (d.mt_fatherNationalId || '').replace(/-/g,''),
                        'สัญชาติบิดา':          d.mt_fatherNationality || '-',
                        'เชื้อชาติบิดา':        d.mt_fatherEthnicity || '-',
                        'ศาสนาบิดา':            d.mt_fatherReligion || '-',
                        'สถานะบิดา':            d.mt_fatherAlive || '-',
                        'การศึกษาบิดา':         d.mt_fatherEducation || '-',
                        'อาชีพบิดา':            d.mt_fatherOccupation || '-',
                        'ที่ทำงานบิดา':         d.mt_fatherWorkplace || '-',
                        'รายได้บิดา':           d.mt_fatherIncome || '-',
                        'โทรบิดา':              d.mt_fatherMobile || '-',
                        'ตำบลบิดา':             d.mt_fatherSubdistrict || '-',
                        'อำเภอบิดา':            d.mt_fatherDistrict || '-',
                        'จังหวัดบิดา':          d.mt_fatherProvince || '-',
                        // มารดา
                        'ชื่อ-สกุลมารดา':       d.mt_motherFullName || '-',
                        'เลขบัตรมารดา':         (d.mt_motherNationalId || '').replace(/-/g,''),
                        'สัญชาติมารดา':         d.mt_motherNationality || '-',
                        'เชื้อชาติมารดา':       d.mt_motherEthnicity || '-',
                        'ศาสนามารดา':           d.mt_motherReligion || '-',
                        'สถานะมารดา':           d.mt_motherAlive || '-',
                        'การศึกษามารดา':        d.mt_motherEducation || '-',
                        'อาชีพมารดา':           d.mt_motherOccupation || '-',
                        'ที่ทำงานมารดา':        d.mt_motherWorkplace || '-',
                        'รายได้มารดา':          d.mt_motherIncome || '-',
                        'โทรมารดา':             d.mt_motherMobile || '-',
                        'ตำบลมารดา':            d.mt_motherSubdistrict || '-',
                        'อำเภอมารดา':           d.mt_motherDistrict || '-',
                        'จังหวัดมารดา':         d.mt_motherProvince || '-',
                        // สถานภาพ
                        'สถานภาพบิดา-มารดา':   d.mt_parentStatus === 'อื่นๆ' ? (d.mt_parentStatusOther||'อื่นๆ') : (d.mt_parentStatus||'-'),
                        // ผู้ปกครองทดแทน
                        'ชื่อผู้ปกครองทดแทน':   d.mt_altGuardianName || '-',
                        'ความสัมพันธ์ทดแทน':    d.mt_altGuardianRelation || '-',
                        'สัญชาติทดแทน':         d.mt_altGuardianNationality || '-',
                        'เชื้อชาติทดแทน':       d.mt_altGuardianEthnicity || '-',
                        'ศาสนาทดแทน':           d.mt_altGuardianReligion || '-',
                        'อาชีพทดแทน':           d.mt_altGuardianOccupation || '-',
                        'รายได้ทดแทน':          d.mt_altGuardianIncome || '-',
                        'โทรทดแทน':             d.mt_altGuardianMobile || '-',
                        'ที่อยู่ทดแทน':         [d.mt_altGuardianHouseNo, d.mt_altGuardianMoo && `หมู่${d.mt_altGuardianMoo}`, d.mt_altGuardianRoad && `ถ.${d.mt_altGuardianRoad}`, d.mt_altGuardianSubdistrict && `ต.${d.mt_altGuardianSubdistrict}`, d.mt_altGuardianDistrict && `อ.${d.mt_altGuardianDistrict}`, d.mt_altGuardianProvince && `จ.${d.mt_altGuardianProvince}`].filter(Boolean).join(' ') || '-',
                    });
                });
                if (rows.length === 0) { showToast('ไม่มีข้อมูลให้ส่งออก', 'error'); return; }
                const headers = Object.keys(rows[0]);
                const csv = [
                    '\ufeff' + headers.join(','),
                    ...rows.map(row => headers.map(h => `"${(row[h]||'').toString().replace(/"/g,'""')}"`).join(','))
                ].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const today = new Date().toLocaleDateString('th-TH').replace(/\//g,'-');
                a.href = url; a.download = `รายชื่อใบมอบตัว_${today}.csv`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                showToast('ส่งออกข้อมูลใบมอบตัวสำเร็จ');
            } catch(e) {
                showToast('เกิดข้อผิดพลาด: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ========== AUTOSAVE SYSTEM ==========
        const AUTOSAVE_KEY_MOBTUA = 'autosave_mobtua';
        const AUTOSAVE_KEY_ADMISSION = 'autosave_admission';
        const autosaveTimers = {};

        function autosaveForm(formId, storageKey) {
            const form = document.getElementById(formId);
            if (!form) return;
            const fd = new FormData(form);
            const data = {};
            for (let [k, v] of fd.entries()) {
                if (!data[k]) data[k] = v;
                else if (Array.isArray(data[k])) data[k].push(v);
                else data[k] = [data[k], v];
            }
            localStorage.setItem(storageKey, JSON.stringify({ data, savedAt: new Date().toISOString() }));
        }

        function restoreForm(formId, storageKey) {
            const saved = localStorage.getItem(storageKey);
            if (!saved) return false;
            try {
                const { data, savedAt } = JSON.parse(saved);
                const form = document.getElementById(formId);
                if (!form) return false;
                Object.entries(data).forEach(([name, value]) => {
                    const values = Array.isArray(value) ? value : [value];
                    const els = form.querySelectorAll(`[name="${name}"]`);
                    els.forEach(el => {
                        if (el.type === 'checkbox' || el.type === 'radio') {
                            el.checked = values.includes(el.value);
                        } else {
                            el.value = values[0] || '';
                        }
                    });
                });
                return savedAt;
            } catch(e) {
                console.warn('Restore autosave failed:', e);
                return false;
            }
        }

        function setupAutosave(formId, storageKey, debounceMs = 1500) {
            const form = document.getElementById(formId);
            if (!form) return;
            // ป้องกัน register ซ้ำ
            if (form._autosaveSetup) return;
            form._autosaveSetup = true;
            const trigger = () => {
                clearTimeout(autosaveTimers[storageKey]);
                autosaveTimers[storageKey] = setTimeout(() => {
                    autosaveForm(formId, storageKey);
                    showAutosaveBadge(storageKey);
                }, debounceMs);
            };
            form.addEventListener('input', trigger);
            form.addEventListener('change', trigger);
        }

        function showAutosaveBadge(storageKey) {
            const badgeId = storageKey === AUTOSAVE_KEY_MOBTUA ? 'autosaveBadgeMobtua' : 'autosaveBadgeAdmission';
            const badge = document.getElementById(badgeId);
            if (!badge) return;
            badge.textContent = '💾 บันทึกอัตโนมัติ ' + new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
            badge.style.opacity = '1';
            clearTimeout(badge._hideTimer);
            badge._hideTimer = setTimeout(() => { badge.style.opacity = '0'; }, 3000);
        }

        function clearAutosave(storageKey) {
            localStorage.removeItem(storageKey);
        }

        function promptRestoreAutosave(formId, storageKey) {
            const savedAt = restoreForm(formId, storageKey);
            if (savedAt) {
                const dt = new Date(savedAt).toLocaleString('th-TH');
                const badgeId = storageKey === AUTOSAVE_KEY_MOBTUA ? 'autosaveBadgeMobtua' : 'autosaveBadgeAdmission';
                const badge = document.getElementById(badgeId);
                if (badge) {
                    badge.textContent = `📂 โหลดข้อมูลที่บันทึกไว้อัตโนมัติ (${dt})`;
                    badge.style.opacity = '1';
                    clearTimeout(badge._hideTimer);
                    badge._hideTimer = setTimeout(() => { badge.style.opacity = '0'; }, 5000);
                }
                // trigger age calc
                if (formId === 'mobtuaForm') {
                    document.getElementById('mt_birthDay')?.dispatchEvent(new Event('change'));
                } else {
                    document.getElementById('birthDay')?.dispatchEvent(new Event('change'));
                }
                // trigger talent checkbox visibility
                if (formId === 'admissionForm') {
                    ['sports','music','other'].forEach(v => {
                        const cb = document.querySelector(`input[name="talent"][value="${v}"]`);
                        if (cb) cb.dispatchEvent(new Event('change'));
                    });
                }
                return true;
            }
            return false;
        }

        function printMobtuaDocument() {
            // ตั้ง flag บน body ให้ CSS print รู้ว่าพิมพ์ใบมอบตัว
            document.body.setAttribute('data-print', 'mobtua');
            const mobtuaPrint = document.getElementById('mobtuaPrintArea');
            mobtuaPrint.style.display = 'block';
            setTimeout(() => {
                window.print();
                document.body.removeAttribute('data-print');
                mobtuaPrint.style.display = 'none';
            }, 200);
        }

        // เรียกใช้เมื่อโหลดหน้า
        window.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            setTimeout(showAlertIfEnabled, 500);
            setupMobtuaEvents();

            // โหลดโหมดทดสอบ
            const testModeEnabled = localStorage.getItem('testModeEnabled') === 'true';
            toggleTestModeButton(testModeEnabled);

            // โหลดสถานะล็อค
            const historyLocked = localStorage.getItem('historyLocked') === 'true';
            applyHistoryLockUI(historyLocked);

            // ตั้ง Autosave สำหรับฟอร์มใบสมัคร
            setupAutosave('admissionForm', AUTOSAVE_KEY_ADMISSION);
            // โหลดข้อมูลที่เคยบันทึกของใบสมัคร
            promptRestoreAutosave('admissionForm', AUTOSAVE_KEY_ADMISSION);
        });

        /* =========================================================
           DAILY REPORT MODULE
           ========================================================= */
        let rptData = []; // ข้อมูลผลลัพธ์ประจำวัน

        function openReportPage() {
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('mainContainer').classList.add('hidden');
            document.getElementById('reportPage').classList.add('active');
            const dateEl = document.getElementById('rpt_date');
            if (!dateEl.value) {
                dateEl.value = new Date().toISOString().slice(0, 10);
            }
            // โหลดข้อมูลผู้ลงนามจาก localStorage
            const saved = JSON.parse(localStorage.getItem('memoSignatories') || '{}');
            const fields = ['rpt','sig1','sig2','sig3','sig4'];
            fields.forEach(id => {
                if (saved[id+'_prefix'])    { const el = document.getElementById(id+'_prefix');    if(el) el.value = saved[id+'_prefix']; }
                if (saved[id+'_firstName']) { const el = document.getElementById(id+'_firstName'); if(el) el.value = saved[id+'_firstName']; }
                if (saved[id+'_lastName'])  { const el = document.getElementById(id+'_lastName');  if(el) el.value = saved[id+'_lastName']; }
            });
        }

        function saveSignatoriesToStorage() {
            const fields = ['rpt','sig1','sig2','sig3','sig4'];
            const data = {};
            fields.forEach(id => {
                const pe = document.getElementById(id+'_prefix');
                const fe = document.getElementById(id+'_firstName');
                const le = document.getElementById(id+'_lastName');
                if(pe) data[id+'_prefix']    = pe.value;
                if(fe) data[id+'_firstName'] = fe.value.trim();
                if(le) data[id+'_lastName']  = le.value.trim();
            });
            localStorage.setItem('memoSignatories', JSON.stringify(data));
        }

        function getSigName(id) {
            const prefix    = (document.getElementById(id+'_prefix')?.value    || '').trim();
            const firstName = (document.getElementById(id+'_firstName')?.value || '').trim();
            const lastName  = (document.getElementById(id+'_lastName')?.value  || '').trim();
            if (!firstName && !lastName) return '................................................................';
            return `${prefix}${firstName} ${lastName}`;
        }

        function closeReportPage() {
            document.getElementById('reportPage').classList.remove('active');
            document.getElementById('landingPage').classList.remove('hidden');
            backToStep1();
        }

        async function fetchDailyReport() {
            const dateVal = document.getElementById('rpt_date').value;
            if (!dateVal) { showToast('กรุณาเลือกวันที่', 'error'); return; }

            // บันทึกข้อมูลผู้ลงนาม
            saveSignatoriesToStorage();

            try {
                showLoading(true);

                const startDate = new Date(dateVal + 'T00:00:00');
                const endDate   = new Date(dateVal + 'T23:59:59');

                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'admissions'),
                    window.firestore.where('createdAt', '>=', window.firestore.Timestamp.fromDate(startDate)),
                    window.firestore.where('createdAt', '<=', window.firestore.Timestamp.fromDate(endDate)),
                    window.firestore.orderBy('createdAt', 'asc')
                );

                const snap = await window.firestore.getDocs(q);
                rptData = [];
                snap.forEach(doc => rptData.push({ id: doc.id, ...doc.data() }));

                renderReportResults(dateVal, rptData);
            } catch (e) {
                console.error('fetchDailyReport error:', e);
                showToast('เกิดข้อผิดพลาด: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderReportResults(dateVal, records) {
            const resultsEl = document.getElementById('rpt_results');
            const emptyEl   = document.getElementById('rpt_empty');

            if (records.length === 0) {
                resultsEl.style.display = 'none';
                emptyEl.style.display   = 'block';
                return;
            }
            emptyEl.style.display   = 'none';
            resultsEl.style.display = 'block';

            const d = new Date(dateVal + 'T12:00:00');
            const thaiDate = d.toLocaleDateString('th-TH', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
            document.getElementById('rpt_dateLabel').textContent = `— ${thaiDate}`;

            const m1 = records.filter(r => r.gradeLevel === 'm1');
            const m4 = records.filter(r => r.gradeLevel === 'm4');
            const male   = records.filter(r => { const p=(r.data&&r.data.prefix)||''; return p==='เด็กชาย'||p==='นาย'; });
            const female = records.filter(r => { const p=(r.data&&r.data.prefix)||''; return p==='เด็กหญิง'||p==='นางสาว'; });

            document.getElementById('rpt_total').textContent       = records.length;
            document.getElementById('rpt_m1count').textContent     = m1.length;
            document.getElementById('rpt_m4count').textContent     = m4.length;
            document.getElementById('rpt_maleCount').textContent   = male.length;
            document.getElementById('rpt_femaleCount').textContent = female.length;

            const tbody = document.getElementById('rpt_tableBody');
            tbody.innerHTML = records.map((rec, i) => {
                const d = rec.data || {};
                const grade = rec.gradeLevel === 'm4' ? 'ม.4' : 'ม.1';
                const timeStr = rec.createdAt ? rec.createdAt.toDate().toLocaleTimeString('th-TH', { hour:'2-digit', minute:'2-digit' }) : '-';
                return `<tr>
                    <td style="text-align:center;">${i + 1}</td>
                    <td><span class="grade-badge">${grade}</span></td>
                    <td>${rec.studentName || '-'}</td>
                    <td>${d.previousSchool || '-'}</td>
                    <td>${d.district || '-'}</td>
                    <td>${d.province || '-'}</td>
                    <td>${timeStr}</td>
                </tr>`;
            }).join('');
        }

        function getReporterName() {
            return getSigName('rpt');
        }

        function getSelectedThaiDate() {
            const dateVal = document.getElementById('rpt_date').value;
            if (!dateVal) return '';
            const d = new Date(dateVal + 'T12:00:00');
            return d.toLocaleDateString('th-TH', { year:'numeric', month:'long', day:'numeric' });
        }

        /* ---------- LINE COPY ---------- */
        function openLineCopyModal() {
            if (rptData.length === 0) { showToast('ไม่มีข้อมูลสำหรับสร้างรายงาน', 'error'); return; }

            const thaiDate   = getSelectedThaiDate();
            const reporter   = getReporterName();
            const m1 = rptData.filter(r => r.gradeLevel === 'm1');
            const m4 = rptData.filter(r => r.gradeLevel === 'm4');
            const male   = rptData.filter(r => { const p=(r.data?.prefix||''); return p==='เด็กชาย'||p==='นาย'; });
            const female = rptData.filter(r => { const p=(r.data?.prefix||''); return p==='เด็กหญิง'||p==='นางสาว'; });

            const lines = rptData.map((r, i) => {
                const grade = r.gradeLevel === 'm4' ? 'ม.4' : 'ม.1';
                const school = (r.data?.previousSchool || '-');
                return `   ${i+1}. ${r.studentName || '-'} (${grade}) — ${school}`;
            }).join('\n');

            const text =
`📋 รายงานผลการรับสมัครนักเรียน
โรงเรียนกระดุมทองวิทยา
วันที่ ${thaiDate}
━━━━━━━━━━━━━━━━━━━━━
📊 สรุปยอดผู้สมัคร
• รวมทั้งหมด : ${rptData.length} คน
  - ม.1 : ${m1.length} คน
  - ม.4 : ${m4.length} คน
• ชาย : ${male.length} คน | หญิง : ${female.length} คน
━━━━━━━━━━━━━━━━━━━━━
📝 รายชื่อผู้สมัคร
${lines}
━━━━━━━━━━━━━━━━━━━━━
รายงานโดย ${reporter || '—'}`;

            document.getElementById('lineCopyText').textContent = text;
            document.getElementById('lineCopyModal').classList.add('active');
        }

        function copyLineText() {
            const text = document.getElementById('lineCopyText').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showToast('คัดลอกข้อความสำเร็จ! นำไปวางในไลน์ได้เลย');
            }).catch(() => {
                // fallback
                const sel = window.getSelection();
                const range = document.createRange();
                range.selectNodeContents(document.getElementById('lineCopyText'));
                sel.removeAllRanges();
                sel.addRange(range);
                document.execCommand('copy');
                showToast('คัดลอกแล้ว');
            });
        }

        /* ---------- MEMO DOCUMENT ---------- */
        async function generateMemoDocument() {
            // บันทึกชื่อผู้ลงนามก่อน
            saveSignatoriesToStorage();

            try {
                showLoading(true);

                // ดึงข้อมูลทั้งหมดจาก Firestore
                const snap = await window.firestore.getDocs(
                    window.firestore.query(
                        window.firestore.collection(window.db, 'admissions'),
                        window.firestore.orderBy('createdAt', 'asc')
                    )
                );
                const allData = [];
                snap.forEach(doc => allData.push({ id: doc.id, ...doc.data() }));

                if (allData.length === 0) {
                    showToast('ยังไม่มีข้อมูลผู้สมัครในระบบ', 'error');
                    showLoading(false);
                    return;
                }

                _buildMemoHTML(allData);

            } catch(e) {
                console.error('generateMemoDocument error:', e);
                showToast('เกิดข้อผิดพลาด: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function _buildMemoHTML(allData) {
            // ===== ข้อมูลพื้นฐาน =====
            const today = new Date();
            const thaiDateToday = today.toLocaleDateString('th-TH', { year:'numeric', month:'long', day:'numeric' });
            const thaiYear = today.getFullYear() + 543;

            const m1All = allData.filter(r => r.gradeLevel === 'm1');
            const m4All = allData.filter(r => r.gradeLevel === 'm4');
            const maleAll   = allData.filter(r => { const p=(r.data?.prefix||''); return p==='เด็กชาย'||p==='นาย'; });
            const femaleAll = allData.filter(r => { const p=(r.data?.prefix||''); return p==='เด็กหญิง'||p==='นางสาว'; });

            // ===== สรุปรายวัน (pivot table หน้า 1) =====
            const dayMap = {};
            allData.forEach(rec => {
                const dateKey = rec.createdAt
                    ? rec.createdAt.toDate().toLocaleDateString('th-TH', { year:'numeric', month:'short', day:'numeric' })
                    : 'ไม่ระบุวันที่';
                if (!dayMap[dateKey]) dayMap[dateKey] = { total:0, m1:0, m4:0, male:0, female:0 };
                dayMap[dateKey].total++;
                if (rec.gradeLevel === 'm1') dayMap[dateKey].m1++;
                if (rec.gradeLevel === 'm4') dayMap[dateKey].m4++;
                const p = rec.data?.prefix || '';
                if (p==='เด็กชาย'||p==='นาย') dayMap[dateKey].male++;
                if (p==='เด็กหญิง'||p==='นางสาว') dayMap[dateKey].female++;
            });

            const summaryRows = Object.entries(dayMap).map(([date, c], i) =>
                `<tr>
                    <td>${i+1}</td>
                    <td class="text-left">${date}</td>
                    <td>${c.m1}</td>
                    <td>${c.m4}</td>
                    <td>${c.male}</td>
                    <td>${c.female}</td>
                    <td><strong>${c.total}</strong></td>
                </tr>`
            ).join('');

            const sumRow = `<tr style="background:#fff5eb;font-weight:bold;">
                <td colspan="2" style="text-align:center;">รวมทั้งหมด</td>
                <td>${m1All.length}</td>
                <td>${m4All.length}</td>
                <td>${maleAll.length}</td>
                <td>${femaleAll.length}</td>
                <td>${allData.length}</td>
            </tr>`;

            // ===== หน้า 2: รายชื่อทั้งหมดแยกชั้น =====
            const buildGradeBlock = (gradeLabel, recs) => {
                if (recs.length === 0) return '';
                const rows = recs.map((rec, i) => {
                    const d = rec.data || {};
                    const dateStr = rec.createdAt
                        ? rec.createdAt.toDate().toLocaleDateString('th-TH', { day:'2-digit', month:'short', year:'numeric' })
                        : '-';
                    return `<tr>
                        <td>${i+1}</td>
                        <td class="text-left">${rec.studentName||'-'}</td>
                        <td class="text-left">${d.previousSchool||'-'}</td>
                        <td>${d.district||'-'}</td>
                        <td>${d.province||'-'}</td>
                        <td>${dateStr}</td>
                    </tr>`;
                }).join('');
                return `<div class="school-block">
                    <span class="school-name">📚 นักเรียนชั้น ${gradeLabel} — รวม ${recs.length} คน</span>
                    <table class="student-table">
                        <thead>
                            <tr><th>ที่</th><th>ชื่อ-สกุล</th><th>โรงเรียนเดิม</th><th>อำเภอ</th><th>จังหวัด</th><th>วันที่สมัคร</th></tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;
            };

            const page2Content = buildGradeBlock('ม.1', m1All) + buildGradeBlock('ม.4', m4All);

            // ===== สร้าง HTML =====
            const memoHTML = `
            <div class="a4-paper memo-layout">
                <img src="https://nonthaphathr.github.io/uploadimg/kruda.png" class="garuda" alt="ตราครุฑ">

                <div class="doc-title">บันทึกข้อความ</div>

                <div class="doc-meta">
                    <b>ส่วนราชการ</b>&nbsp;&nbsp;งานทะเบียนและเทียบโอนผลการเรียน โรงเรียนกระดุมทองวิทยา
                    ตำบลหนองหัวช้าง อำเภอกันทรารมย์ จังหวัดศรีสะเกษ
                </div>
                <div class="doc-meta doc-meta-row">
                    <span class="doc-ref"><b>ที่</b>&nbsp;&nbsp;ศก 51008.08/............</span>
                    <span class="doc-date"><b>วันที่</b>&nbsp;&nbsp;${thaiDateToday}</span>
                </div>
                <div class="doc-meta">
                    <b>เรื่อง</b>&nbsp;&nbsp;รายงานผลการรับสมัครนักเรียน (สรุปรวมทั้งหมด) ประจำปีการศึกษา ${thaiYear}
                </div>
                <hr class="doc-line">
                <div class="doc-to">เรียน&nbsp;&nbsp;ผู้อำนวยการโรงเรียนกระดุมทองวิทยา</div>

                <div class="doc-content">
                    ด้วยงานทะเบียนและเทียบโอนผลการเรียน โรงเรียนกระดุมทองวิทยา ได้ดำเนินการเปิดรับสมัครนักเรียน
                    ประจำปีการศึกษา ${thaiYear} มีนักเรียนสมัครเข้าเรียนผ่านระบบออนไลน์รวมทั้งสิ้น
                    <strong>${allData.length}</strong> คน แบ่งเป็นนักเรียนชั้น ม.1 จำนวน ${m1All.length} คน
                    และนักเรียนชั้น ม.4 จำนวน ${m4All.length} คน (ชาย ${maleAll.length} คน หญิง ${femaleAll.length} คน)
                    มีรายละเอียดสรุปรายวันดังตารางต่อไปนี้
                </div>

                <table class="doc-table">
                    <colgroup>
                        <col style="width:5%"><col style="width:25%">
                        <col style="width:10%"><col style="width:10%">
                        <col style="width:12%"><col style="width:12%"><col style="width:12%">
                    </colgroup>
                    <thead>
                        <tr>
                            <th rowspan="2">ที่</th>
                            <th rowspan="2">วันที่</th>
                            <th colspan="2">ระดับชั้น</th>
                            <th colspan="2">เพศ</th>
                            <th rowspan="2">รวม</th>
                        </tr>
                        <tr>
                            <th>ม.1</th><th>ม.4</th>
                            <th>ชาย</th><th>หญิง</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${summaryRows}
                        ${sumRow}
                    </tbody>
                </table>

                <div class="doc-closing">จึงเรียนมาเพื่อโปรดทราบ และโปรดพิจารณา</div>

                <table class="sign-table">
                    <tr>
                        <td>
                            ลงชื่อ&nbsp;........................................<br>
                            (${getSigName('rpt')})<br>
                            ผู้รับผิดชอบงานรับนักเรียน
                        </td>
                        <td>
                            ลงชื่อ&nbsp;........................................<br>
                            (${getSigName('sig1')})<br>
                            หัวหน้างานรับนักเรียน
                        </td>
                    </tr>
                    <tr style="height:14px;"><td></td><td></td></tr>
                    <tr>
                        <td>
                            <div class="checkbox-text">(&nbsp;&nbsp;&nbsp;) รับทราบ</div>
                            ลงชื่อ&nbsp;........................................<br>
                            (${getSigName('sig2')})<br>
                            หัวหน้ากลุ่มบริหารงานทั่วไป
                        </td>
                        <td>
                            <div class="checkbox-text">(&nbsp;&nbsp;&nbsp;) รับทราบ</div>
                            ลงชื่อ&nbsp;........................................<br>
                            (${getSigName('sig3')})<br>
                            รองผู้อำนวยการโรงเรียนกระดุมทองวิทยา
                        </td>
                    </tr>
                    <tr style="height:14px;"><td></td><td></td></tr>
                    <tr>
                        <td></td>
                        <td>
                            <div class="checkbox-text">(&nbsp;&nbsp;&nbsp;) รับทราบ</div>
                            ลงชื่อ&nbsp;........................................<br>
                            (${getSigName('sig4')})<br>
                            ผู้อำนวยการโรงเรียนกระดุมทองวิทยา
                        </td>
                    </tr>
                </table>

            </div>

            ${page2Content ? `
            <div class="a4-paper memo-page2">
                <div class="page2-title">รายชื่อนักเรียนที่สมัครเรียน (ทั้งหมด) ปีการศึกษา ${thaiYear}</div>
                <div class="page2-subtitle">โรงเรียนกระดุมทองวิทยา | พิมพ์ ณ วันที่ ${thaiDateToday}</div>
                ${page2Content}
            </div>` : ''}`;

            document.getElementById('memoDocContent').innerHTML = memoHTML;
            document.getElementById('memoPrintArea').innerHTML  = memoHTML;
            document.getElementById('memoDocModal').classList.add('active');
        }

        function printMemoDoc() {
            // ตรวจว่ามีเนื้อหาหรือเปล่า
            const printArea = document.getElementById('memoPrintArea');
            if (!printArea || !printArea.innerHTML.trim()) {
                showToast('กรุณาสร้างเอกสารก่อนพิมพ์', 'error'); return;
            }
            document.body.setAttribute('data-print', 'memo');
            window.print();
            setTimeout(() => document.body.removeAttribute('data-print'), 1500);
        }
    </script>
</body>
</html>
